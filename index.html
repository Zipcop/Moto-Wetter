<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wetter">

    <!-- FONT: Outfit (Google Fonts) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- PWA MANIFEST (Ermöglicht Installation als App) -->
    <link rel="manifest"
        href='data:application/manifest+json;charset=utf-8,{"name":"Moto Wetter","short_name":"MotoWetter","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#0f172a","icons":[{"src":"https://img.icons8.com/fluency/512/weather.png?v=2","sizes":"512x512","type":"image/png"}]}'>

    <!-- ZURÜCK ZUM ORIGINAL: Web-Icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/weather.png?v=2">

    <title>Wetter Live</title>

    <!-- LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* touch-action: pan-y verhindert horizontales Wischen auf Browserebene */
        html,
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            width: 100%;
            touch-action: pan-y;
        }

        /* ZURÜCKGESETZT: Originaler blauer Hintergrund ohne Bild */
        /* PREMIUM THEME BASE */
        body {
            /* Fallback Background */
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding-top: max(env(safe-area-inset-top), 20px);
            padding-bottom: max(env(safe-area-inset-bottom), 20px);
            padding-left: 1rem;
            padding-right: 1rem;
            font-family: 'Outfit', sans-serif;
            color: #ffffff;
            transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        /* NOISE TEXTURE REMOVED per User Request */

        /* DYNAMIC ATMOSPHERES - Classes to be toggled by JS */

        /* Clear / Sunny */
        body.theme-clear-day {
            background: linear-gradient(180deg, #38bdf8 0%, #3b82f6 100%);
        }

        body.theme-clear-night {
            background: linear-gradient(180deg, #0f172a 0%, #1e1b4b 100%);
        }

        /* Cloudy */
        body.theme-cloudy-day {
            background: linear-gradient(180deg, #94a3b8 0%, #64748b 100%);
        }

        body.theme-cloudy-night {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
        }

        /* Rain */
        body.theme-rain-day {
            background: linear-gradient(180deg, #334155 0%, #475569 100%);
        }

        body.theme-rain-night {
            background: linear-gradient(180deg, #020617 0%, #1e293b 100%);
        }

        /* Sunset / Sunrise */
        body.theme-sunset {
            background: linear-gradient(180deg, #fb923c 0%, #db2777 60%, #4c1d95 100%);
        }

        /* Extreme (Thunder/Snow) */
        body.theme-extreme {
            background: linear-gradient(180deg, #312e81 0%, #111827 100%);
        }

        /* Z-INDEX LAYERING (Repariert) */
        /* Layer 1: Wetter-Effekte (Regen, Wolken, Vögel) */
        #splashEffects {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
            transition: transform 0.1s linear;
        }

        /* Layer 50: Hauptinhalt (App UI) - Muss höher sein als Effekte, damit klickbar */
        main {
            position: relative;
            z-index: 50;
        }

        /* Layer 90: Rain on Glass Overlay (Feature 7) */
        #rainGlassCanvas {
            position: fixed;
            inset: 0;
            z-index: 90;
            pointer-events: none;
            opacity: 0;
            transition: opacity 1s ease;
            mix-blend-mode: overlay;
        }

        /* Layer 100: Ladescreen */
        #splashScreen {
            position: fixed;
            inset: 0;
            z-index: 100;
            inset: 0;
            z-index: 100;
            background: #0f172a;
            /* backdrop-filter: blur(20px); REMOVED for opacity */
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1), opacity 0.6s ease-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 2.5rem;
            overflow: hidden;
            cursor: pointer;
        }

        .splash-hidden {
            transform: translateY(-100%);
            opacity: 0;
            pointer-events: none;
        }

        #splashLocalEffects {
            position: absolute;
            inset: 0;
            z-index: -1;
            pointer-events: none;
            overflow: hidden;
        }

        .splash-content {
            position: relative;
            z-index: 10;
        }

        /* PREMIUM GLASSMORPHISM */
        /* PREMIUM GLASSMORPHISM */
        .glass-panel {
            background: rgba(0, 0, 0, 0.2);
            /* Lighter base for more light interaction */
            backdrop-filter: blur(24px) saturate(140%);
            /* High blur + saturation for vibrancy */
            -webkit-backdrop-filter: blur(24px) saturate(140%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-top: 1px solid rgba(255, 255, 255, 0.25);
            /* Highlight top edge */
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            /* Lowlight bottom edge */
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.25);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .glass-btn {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Hover effects for Desktop ONLY */
        @media (hover: hover) {
            .glass-panel:hover {
                /* background: rgba(0, 0, 0, 0.3); REMOVED per user request */
                transform: translateY(-2px);
                box-shadow: 0 12px 40px -4px rgba(0, 0, 0, 0.3);
            }

            .glass-btn:hover {
                /* background: rgba(0, 0, 0, 0.3); REMOVED per user request */
                transform: translateY(-1px);
            }

            .leaflet-bar a:hover {
                background-color: #3b82f6 !important;
            }

            .ride-item-hover:hover {
                background-color: #1e293b;
                /* slate-800 */
            }
        }

        /* TACTILE FEEDBACK (Global) */
        button,
        .glass-btn,
        .fav-item,
        .glass-panel[onclick] {
            cursor: pointer;
            touch-action: manipulation;
            /* No double-tap zoom */
        }

        button:active,
        .glass-btn:active,
        .fav-item:active,
        .glass-panel[onclick]:active {
            transform: scale(0.96);
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        input[type="search"]::-webkit-search-cancel-button {
            -webkit-appearance: none;
        }

        .radar-fullscreen {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 200 !important;
            background: #0f172a;
            border-radius: 0 !important;
            padding: env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 40px) 0;
            margin: 0 !important;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }

        .dot-live {
            background-color: #ef4444;
            animation: pulse-red 2s infinite;
        }

        /* MODAL ACTIVE STATE */
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-overlay {
            pointer-events: none;
            /* Prevent clicks when hidden/fading out */
        }

        .dot-forecast {
            background-color: #a855f7;
            animation: pulse-purple 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        @keyframes pulse-purple {
            0% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0.7);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(168, 85, 247, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(168, 85, 247, 0);
            }
        }

        .hour-card-active {
            background-color: rgba(59, 130, 246, 0.2) !important;
            border-color: rgba(59, 130, 246, 0.8) !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .hour-card-night {
            background-color: rgba(10, 15, 30, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.05) !important;
        }

        .modal-overlay {
            cursor: pointer;
        }

        .modal-content {
            cursor: default;
        }

        #suggestionsList {
            z-index: 100 !important;
        }

        .animate-pulse-slow {
            animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        .rain-bar {
            transition: height 0.5s ease-out;
        }

        /* DEV MENU STYLES */
        #devMenu {
            z-index: 9999;
        }

        .dev-btn {
            /* @apply replaced with standard CSS (or use classes in HTML) */
            /* Using standard styles here to avoid lint error, or just ignoring if using a build tool that supports it. 
               However, since this is in a <style> tag without type="text/tailwindcss", standard CSS is preferred or explicit style configuration.
               Let's replace @apply with actual properties effectively or just use the utility classes in the HTML directly. 
               But since the user asked to fix the 'problem', and we see they are using CDN, 
               'Unknown at rule @apply' suggests the IDE doesn't like it.
               We can convert these to standard CSS or just comment them out and ensure the HTML has classes.
               Looking at usage, .dev-btn is likely used in JS or HTML.
               Let's just translate the Tailwind classes to CSS properties here to satisfy the linter and keep functionality.
            */
            background-color: #334155;
            /* bg-slate-700 */
            color: white;
            /* text-white */
            font-size: 0.75rem;
            /* text-xs */
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            /* font-mono */
            padding: 0.5rem 0.75rem;
            /* py-2 px-3 */
            border-radius: 0.25rem;
            /* rounded */
            border: 1px solid #475569;
            /* border-slate-600 */
            transition: background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, color 0.15s ease-in-out;
            /* transition-colors */
            cursor: pointer;
        }

        .dev-btn:hover {
            background-color: #475569;
            /* hover:bg-slate-600 */
        }

        .dev-btn-active {
            background-color: #2563eb;
            /* bg-blue-600 */
            border-color: #60a5fa;
            /* border-blue-400 */
        }

        /* LEAFLET CUSTOM STYLES */
        .leaflet-container {
            background: #0f172a !important;
            font-family: inherit !important;
        }

        .leaflet-control-attribution {
            background: rgba(15, 23, 42, 0.8) !important;
            color: #64748b !important;
        }

        .leaflet-control-attribution a {
            color: #94a3b8 !important;
        }

        .leaflet-control-zoom {
            border: none !important;
            margin-right: 12px !important;
            margin-top: 50px !important;
        }

        .leaflet-bar a {
            background-color: rgba(30, 41, 59, 0.9) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* LEAFLET BAR STYLES (MOVED TO MEDIA QUERY ABOVE) */
        .leaflet-bar a {
            background-color: rgba(30, 41, 59, 0.9) !important;
            color: white !important;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        }

        /* TIMELINE SLIDER STYLES */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            /* Fix: Define standard property */
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            margin-top: -4px;
            box-shadow: 0 0 0 2px rgba(15, 23, 42, 1);
            border: 2px solid white;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: linear-gradient(to right, rgba(255, 255, 255, 0.2) var(--past-pct, 100%), rgba(168, 85, 247, 0.6) var(--past-pct, 100%));
            border-radius: 2px;
        }

        input[type=range]:focus {
            outline: none;
        }

        /* Animations */
        @keyframes floatUp {
            0% {
                transform: translateY(20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-float-up {
            animation: floatUp 0.8s ease-out forwards;
        }

        .delay-100 {
            animation-delay: 0.1s;
        }

        .delay-200 {
            animation-delay: 0.2s;
        }

        .delay-300 {
            animation-delay: 0.3s;
        }

        @keyframes bounce-slow {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }

        /* Splash FX */
        @keyframes rain-fall {
            0% {
                transform: translateY(-10vh) translateX(-5vh) rotate(15deg);
            }

            100% {
                transform: translateY(110vh) translateX(10vh) rotate(15deg);
            }
        }

        .rain-drop {
            position: absolute;
            width: 2px;
            height: 15px;
            background: rgba(255, 255, 255, 0.4);
            top: -20px;
            animation: rain-fall 0.8s linear infinite;
        }

        @keyframes snow-fall {
            0% {
                transform: translateY(-10vh) translateX(0);
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            100% {
                transform: translateY(110vh) translateX(20px);
                opacity: 0.3;
            }
        }

        .snowflake {
            position: absolute;
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            top: -10px;
            filter: blur(1px);
            animation: snow-fall 4s linear infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.4;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
                transform: scale(1.2);
            }
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s infinite ease-in-out;
            box-shadow: 0 0 6px rgba(255, 255, 255, 0.9);
        }

        @keyframes fog-drift {
            0% {
                transform: translateX(-10%);
                opacity: 0.4;
            }

            50% {
                transform: translateX(10%);
                opacity: 0.7;
            }

            100% {
                transform: translateX(-10%);
                opacity: 0.4;
            }
        }

        .fog-layer {
            position: absolute;
            left: -20%;
            right: -20%;
            top: 20%;
            height: 60%;
            background: linear-gradient(to bottom, transparent, rgba(255, 255, 255, 0.2), transparent);
            filter: blur(25px);
            animation: fog-drift 10s infinite ease-in-out;
        }

        @keyframes cloud-drift {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100vw);
            }
        }

        .cloud-shape {
            position: absolute;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.45) 0%, rgba(255, 255, 255, 0.15) 60%, transparent 70%);
            border-radius: 50%;
            filter: blur(25px);
            animation: cloud-drift linear infinite;
        }

        .sun-orb {
            position: absolute;
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(253, 224, 71, 0.8) 0%, rgba(253, 224, 71, 0.3) 50%, transparent 70%);
            filter: blur(30px);
            animation: pulse-sun 6s infinite ease-in-out;
            z-index: -1;
            transform: translate(-50%, -50%);
            transition: top 1s linear, left 1s linear;
        }

        @keyframes pulse-sun {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.8;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.1);
                opacity: 1;
            }
        }

        .compass-active {
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }

        /* Layer 20: Blitze */
        #lightningLayer {
            position: fixed;
            inset: 0;
            z-index: 20;
            background: white;
            opacity: 0;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        @keyframes lightning-flash {
            0% {
                opacity: 0;
            }

            2% {
                opacity: 0.6;
            }

            4% {
                opacity: 0;
            }

            6% {
                opacity: 0.8;
            }

            8% {
                opacity: 0;
            }

            100% {
                opacity: 0;
            }
        }

        /* BIRD ANIMATION (Z-Index 2 damit vor Wolken) */
        .bird-container {
            position: absolute;
            left: -10%;
            width: 100px;
            height: 50px;
            pointer-events: none;
            z-index: 2;
            opacity: 0.6;
        }

        /* SCROLL FADE MASK - Adjusted: Only fade right side to prevent cutting off start */
        .scroll-fade-mask {
            -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
            mask-image: linear-gradient(to right, black 85%, transparent 100%);
        }

        /* VIEW TRANSITIONS: Premium Fade */
        ::view-transition-group(mobile-morph) {
            animation-duration: 0.3s;
            /* Faster, cleaner fade */
        }

        ::view-transition-old(mobile-morph) {
            animation: fade-out 0.2s ease both;
        }

        ::view-transition-new(mobile-morph) {
            animation: fade-in-scale 0.3s ease both;
        }

        @keyframes fade-out {
            to {
                opacity: 0;
            }
        }

        @keyframes fade-in-scale {
            from {
                opacity: 0;
                transform: scale(0.96);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .bird {
            position: absolute;
            width: 10px;
            height: 6px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.5);
            border-left: 2px solid rgba(255, 255, 255, 0.5);
            transform: rotate(-45deg) skew(10deg);
            animation: wing-flap 0.8s ease-in-out infinite alternate;
        }

        /* Flug von Links nach Rechts */
        @keyframes fly-across {
            0% {
                left: -20%;
                transform: translateY(0) scale(0.8);
            }

            25% {
                transform: translateY(-20px) scale(0.9);
            }

            50% {
                transform: translateY(10px) scale(1);
            }

            75% {
                transform: translateY(-15px) scale(0.9);
            }

            100% {
                left: 120%;
                transform: translateY(0) scale(0.8);
            }
        }

        /* Flug von Rechts nach Links (gespiegelt mit scaleX(-1)) */
        @keyframes fly-across-reverse {
            0% {
                left: 120%;
                transform: translateY(0) scale(0.8) scaleX(-1);
            }

            25% {
                transform: translateY(-15px) scale(0.9) scaleX(-1);
            }

            50% {
                transform: translateY(10px) scale(1) scaleX(-1);
            }

            75% {
                transform: translateY(-20px) scale(0.9) scaleX(-1);
            }

            100% {
                left: -20%;
                transform: translateY(0) scale(0.8) scaleX(-1);
            }
        }

        @keyframes wing-flap {
            0% {
                transform: rotate(-45deg) skew(10deg) scaleY(0.7);
            }

            100% {
                transform: rotate(-45deg) skew(10deg) scaleY(1.3);
            }
        }

        /* --- FEATURE 4: LIGHT MODE OVERRIDES --- */
        body.light-mode .rain-drop {
            background: rgba(59, 130, 246, 0.6);
        }

        body.light-mode .cloud-shape {
            background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 60%, transparent 70%);
        }

        /* FAVORITES STYLES */
        .fav-item {
            cursor: pointer;
            transition: all 0.2s;
        }

        .fav-item:active {
            transform: scale(0.98);
        }

        /* VIEW TRANSITIONS */
        ::view-transition-old(mobile-morph),
        ::view-transition-new(mobile-morph) {
            animation-duration: 0.35s;
            animation-timing-function: cubic-bezier(0.25, 1, 0.5, 1);
        }
    </style>
</head>

<body class="flex flex-col items-center overflow-hidden text-slate-100 bg-slate-900" style="touch-action: none;">

    <!-- VIEW CONTAINER -->
    <div id="view-container" class="fixed inset-0 w-full h-full flex overflow-hidden scroll-smooth no-scrollbar">

        <!-- === VIEW 1: WEATHER === -->
        <section id="view-weather" class="w-screen h-full flex-shrink-0 snap-center relative overflow-hidden">
            <!-- BACKGROUND EFFECTS (Modified for Swipe) -->
            <div id="splashEffects" style="position: absolute !important; inset: 0; z-index: 1;"></div>
            <div id="lightningLayer" style="position: absolute !important; inset: 0; z-index: 20;"></div>
            <!-- FEATURE 7: Rain on Glass Canvas -->
            <canvas id="rainGlassCanvas"
                style="position: absolute !important; inset: 0; z-index: 90; pointer-events: none;"></canvas>

            <div id="splashScreen" onclick="dismissSplash()">
                <div id="splashLocalEffects"></div>
                <div class="mt-10 text-center opacity-0 animate-float-up splash-content">
                    <div
                        class="flex items-center justify-center gap-2 text-blue-300 mb-2 uppercase tracking-widest text-xs font-bold">
                        <i data-lucide="map-pin" size="14"></i> Aktueller Standort
                    </div>
                    <h1 id="splashCity" class="text-4xl font-bold tracking-tight drop-shadow-lg">Ortung...</h1>
                </div>
                <div
                    class="flex flex-col items-center justify-center opacity-0 animate-float-up delay-100 splash-content">
                    <!-- Icon Wrapper -->
                    <div class="mb-4">
                        <div id="splashIcon" class="transform scale-150 drop-shadow-2xl text-blue-200">
                            <div class="loader border-t-white/50"></div>
                        </div>
                    </div>
                    <div class="text-8xl font-black tracking-tighter drop-shadow-xl"><span
                            id="splashTemp">--</span><span class="text-4xl align-top text-blue-200/80">°</span></div>
                    <div id="splashDesc" class="text-xl font-medium text-blue-100/80 mt-2">Einen Moment...</div>
                </div>
                <div
                    class="mb-10 flex flex-col items-center gap-2 opacity-0 animate-float-up delay-200 cursor-pointer splash-content">
                    <span class="text-xs font-medium text-white/50 uppercase tracking-wider">Zum Starten tippen</span>
                    <div
                        class="bg-white/10 p-3 rounded-full backdrop-blur-md animate-bounce-slow hover:bg-white/20 transition">
                        <i data-lucide="chevron-up" class="text-white"></i>
                    </div>
                </div>
            </div>

            <main
                class="w-full h-full max-w-md mx-auto space-y-4 pt-12 pb-24 relative z-10 overflow-y-auto custom-scrollbar px-6 overscroll-contain"
                style="padding-top: max(3rem, env(safe-area-inset-top)); padding-bottom: max(6rem, env(safe-area-inset-bottom)); touch-action: pan-y;">
                <div class="glass-panel rounded-2xl p-4 shadow-xl z-20 relative">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <!-- NEU: Zurück Button -->
                            <button onclick="showSplash()"
                                class="text-slate-400 hover:text-white transition p-1 rounded-full hover:bg-slate-700/50"
                                title="Zurück zur Vorschau"><i data-lucide="arrow-left" size="18"></i></button>
                            <!-- TRIGGER FÜR DEV MENU: 3x Tappen für einfachere Bedienung -->
                            <h1 onclick="handleDevTrigger()"
                                class="text-sm font-bold text-blue-200 uppercase tracking-widest flex items-center gap-2 select-none cursor-pointer active:scale-95 transition-transform touch-manipulation">
                                <i data-lucide="bike" size="16"></i> Wetter
                            </h1>
                        </div>
                        <div class="flex items-center gap-3">
                            <!-- NEW: Moto Button -->
                            <button onclick="scrollToMoto()"
                                class="text-blue-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 bg-blue-500/10 border border-blue-500/20"
                                title="Moto Cockpit"><i data-lucide="bike" size="18"></i></button>

                            <button onclick="showModal('settingsModal')"
                                class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative"
                                title="Einstellungen"><i data-lucide="settings-2" size="18"></i></button>
                            <button
                                onclick="document.getElementById('favoritesModal').classList.remove('hidden'); renderFavoritesList()"
                                class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50"
                                title="Favoriten"><i data-lucide="heart" size="18"></i></button>
                        </div>
                    </div>
                    <form onsubmit="event.preventDefault(); searchCity();" class="flex gap-2 relative">
                        <div class="relative flex-grow">
                            <input type="search" id="cityInput" placeholder="Stadt eingeben..."
                                class="w-full bg-slate-800/50 border border-slate-600 rounded-xl py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition appearance-none"
                                autocomplete="off">
                            <div id="suggestionsList"
                                class="hidden absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto">
                            </div>
                        </div>
                        <button type="submit"
                            class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i
                                data-lucide="search"></i></button>
                        <button type="button" onclick="locateMe()"
                            class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i
                                data-lucide="map-pin"></i></button>
                    </form>
                    <div class="flex justify-center items-center gap-3 mt-4">
                        <div id="cityName" class="text-xl font-bold tracking-wide text-blue-100">--</div>
                        <button id="favToggleBtn" onclick="toggleFavoriteCurrent()"
                            class="transition active:scale-95 opacity-80 hover:opacity-100"><i data-lucide="heart"
                                class="text-slate-500" size="20"></i></button>
                    </div>
                    <div id="offlineBanner"
                        class="hidden flex items-center justify-center gap-2 text-[10px] text-orange-300 font-bold mb-1 bg-orange-500/20 rounded py-1 px-3 mx-auto w-fit animate-pulse cursor-pointer hover:bg-orange-500/30 transition"
                        onclick="fetchWeather(lastWeatherData?.name || 'Standort', '')"><span>OFFLINE-MODUS</span> <i
                            data-lucide="refresh-cw" size="10"></i></div>
                    <div id="timeLabel"
                        class="text-xs text-slate-400 text-center uppercase tracking-wider mb-1 font-semibold opacity-0 transition-opacity duration-300">
                        Aktuell</div>
                    <div id="errorMessage"
                        class="hidden text-red-400 text-center text-sm mt-2 font-semibold bg-red-500/10 p-2 rounded-lg border border-red-500/20">
                        Stadt nicht gefunden.</div>
                </div>

                <div id="loadingIndicator" class="hidden flex justify-center py-10">
                    <div class="loader"></div>
                </div>
                <div id="gpsErrorPrompt" class="hidden text-center py-10 animate-fade-in">
                    <div
                        class="bg-slate-800/50 p-4 rounded-2xl inline-flex flex-col items-center gap-3 border border-slate-600/50">
                        <i data-lucide="map-off" size="32" class="text-slate-400"></i>
                        <p class="text-sm text-slate-300">Standortzugriff verweigert</p><button onclick="locateMe()"
                            class="glass-btn text-xs font-bold py-2 px-4 rounded-xl transition">Erneut
                            versuchen</button>
                    </div>
                </div>
                <div id="warningContainer" class="hidden w-full max-w-lg animate-fade-in"></div>

                <div id="dynamicContent" class="hidden w-full max-w-lg space-y-4 animate-fade-in">
                    <!-- BEST RIDE CARD (Feature: Best Ride Finder) -->
                    <div id="bestRideSection" onclick="showBestRideDetails()"
                        class="glass-panel rounded-2xl p-4 hidden active:scale-95 transition-transform cursor-pointer relative">
                        <div class="flex justify-between items-start mb-2">
                            <h3
                                class="text-sm font-bold text-yellow-300 flex items-center gap-2 uppercase tracking-wide">
                                <i data-lucide="star" size="16"></i> Beste Zeit
                            </h3>
                            <span id="bestRideScore"
                                class="text-xs font-black bg-yellow-400/20 text-yellow-200 px-2 py-0.5 rounded-full border border-yellow-400/30">--</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <div id="bestRideTime" class="text-xl font-bold text-white mb-0.5">--:-- - --:--</div>
                                <div class="flex items-center gap-2">
                                    <div id="bestRideDay"
                                        class="text-xs text-slate-400 uppercase tracking-widest font-semibold">--</div>
                                    <div id="bestRideTemp"
                                        class="text-xs font-bold text-emerald-300 bg-emerald-400/10 px-1.5 py-0.5 rounded border border-emerald-400/20 hidden">
                                        --°</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div id="bestRideDesc" class="text-xs text-slate-300 font-medium italic">--</div>
                            </div>
                        </div>
                    </div>
                    <div id="statusSection" class="grid grid-cols-2 gap-4 transition-all duration-300">
                        <div id="card-weather" onclick="showDailyDetails(0)"
                            class="glass-panel rounded-3xl p-6 flex flex-col items-center justify-center text-center transition-all duration-300 active:scale-95 cursor-pointer relative group overflow-hidden">

                            <!-- Hero Temperature -->
                            <div class="relative z-10 flex flex-col items-center mt-2">
                                <div class="flex items-start leading-none"
                                    style="text-shadow: 0 10px 30px rgba(0,0,0,0.2);">
                                    <span id="temperature"
                                        class="text-[7rem] font-[200] tracking-tighter text-white">--</span>
                                    <span class="text-4xl font-light mt-6 text-white/60">°</span>
                                </div>

                                <!-- Icon & Desc -->
                                <div
                                    class="flex items-center gap-3 mb-6 bg-white/5 px-4 py-2 rounded-full border border-white/10 backdrop-blur-md">
                                    <div id="weatherIconContainer" class="text-white drop-shadow-lg scale-110"><i
                                            data-lucide="cloud" size="20"></i></div>
                                    <div id="weatherDesc"
                                        class="text-sm font-bold tracking-widest uppercase text-white/90">--
                                    </div>
                                </div>

                                <!-- High / Low / Feels -->
                                <!-- High / Low / Feels -->
                                <!-- High / Low / Feels -->
                                <div class="flex w-full px-2 mb-2 items-stretch justify-between">
                                    <div class="flex-1 flex flex-col items-center justify-center gap-1">
                                        <span
                                            class="text-[9px] opacity-60 uppercase font-bold tracking-wider">Tief</span>
                                        <span class="font-semibold text-lg leading-none"><span
                                                id="tempMin">--</span>°</span>
                                    </div>
                                    <!-- Separator -->
                                    <div class="w-px bg-white/10 h-8 self-center mx-1"></div>

                                    <div class="flex-1 flex flex-col items-center justify-center gap-1">
                                        <span
                                            class="text-[9px] opacity-60 uppercase font-bold tracking-wider">Gefühlt</span>
                                        <span class="font-semibold text-lg leading-none"><span
                                                id="feelsLike">--</span>°</span>
                                    </div>

                                    <!-- Separator -->
                                    <div class="w-px bg-white/10 h-8 self-center mx-1"></div>

                                    <div class="flex-1 flex flex-col items-center justify-center gap-1">
                                        <span
                                            class="text-[9px] opacity-60 uppercase font-bold tracking-wider">Hoch</span>
                                        <span class="font-semibold text-lg leading-none"><span
                                                id="tempMax">--</span>°</span>
                                    </div>
                                </div>
                            </div>

                            <!-- FEATURE 5: WIND COMPASS (UPDATED v2) -->
                            <!-- Geändert: von py-2 zu p-4 für eine größere Box -->
                            <div
                                class="flex gap-4 mt-2 text-xs text-slate-400 items-center justify-center bg-slate-800/10 p-4 rounded-xl border border-slate-700/30">
                                <!-- Compass Circle -->
                                <div class="relative w-14 h-14 shrink-0">
                                    <!-- Static Bezel (Phone orientation relative) -->
                                    <div
                                        class="absolute inset-0 rounded-full border-2 border-slate-600 bg-slate-900 shadow-inner flex items-center justify-center">
                                        <span
                                            class="absolute top-0.5 left-1/2 -translate-x-1/2 text-[7px] text-slate-500 font-bold">N</span>
                                        <span
                                            class="absolute bottom-0.5 left-1/2 -translate-x-1/2 text-[7px] text-slate-600 font-bold">S</span>
                                        <span
                                            class="absolute left-1 top-1/2 -translate-y-1/2 text-[7px] text-slate-600 font-bold">W</span>
                                        <span
                                            class="absolute right-1 top-1/2 -translate-y-1/2 text-[7px] text-slate-600 font-bold">O</span>
                                    </div>

                                    <!-- Rotating Arrow Container -->
                                    <div id="windDirArrow"
                                        class="absolute inset-0 transition-transform duration-500 ease-out will-change-transform flex items-center justify-center">
                                        <!-- Red Arrow Head (Pointing Up/North relative to container) -->
                                        <div
                                            class="absolute top-2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[14px] border-b-red-500 drop-shadow-[0_0_2px_rgba(239,68,68,0.8)]">
                                        </div>
                                        <!-- Tail -->
                                        <div class="absolute bottom-3 w-1 h-5 bg-slate-600 rounded-full"></div>
                                        <!-- Center Point -->
                                        <div class="w-2 h-2 bg-slate-300 rounded-full border border-slate-900 z-10">
                                        </div>
                                    </div>
                                </div>

                                <!-- Text Info -->
                                <div class="flex flex-col items-start gap-0.5">
                                    <span
                                        class="text-[10px] uppercase tracking-widest text-slate-500 font-bold">Wind</span>
                                    <div class="flex items-baseline gap-1">
                                        <span id="windSpeed" class="text-xl font-bold text-white leading-none">--</span>
                                        <span class="text-xs text-slate-400">km/h</span>
                                    </div>
                                    <span id="windDirText" class="text-xs font-bold text-blue-400">--</span>
                                </div>
                            </div>

                            <div class="flex items-center justify-center gap-2 mt-2 text-xs text-slate-400">
                                <i data-lucide="droplets" size="12"></i> <span id="humidity">--</span>% Feuchte
                            </div>
                        </div>
                        <div id="card-moto" onclick="showMotoDetails()"
                            class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden transition-all duration-300 active:scale-95 cursor-pointer group">
                            <div
                                class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition">
                                <i data-lucide="info" size="12"></i>
                            </div>
                            <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Moto Index</h3>
                            <!-- NEW: SVG Gauge for Moto Index -->
                            <div class="relative w-24 h-24 mb-1">
                                <svg class="w-full h-full transform -rotate-90" viewBox="0 0 100 100">
                                    <!-- Background Track -->
                                    <circle cx="50" cy="50" r="40" fill="transparent" stroke="rgba(255,255,255,0.1)"
                                        stroke-width="8" />
                                    <!-- Progress Arc -->
                                    <circle id="motoScoreGauge" cx="50" cy="50" r="40" fill="transparent"
                                        stroke="url(#scoreGradient)" stroke-width="8" stroke-dasharray="251.2"
                                        stroke-dashoffset="251.2" stroke-linecap="round"
                                        style="transition: stroke-dashoffset 1s ease-out;" />
                                    <!-- Gradient Definition -->
                                    <defs>
                                        <linearGradient id="scoreGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                            <stop offset="0%" style="stop-color:#ef4444" />
                                            <stop offset="50%" style="stop-color:#fbbf24" />
                                            <stop offset="100%" style="stop-color:#10b981" />
                                        </linearGradient>
                                    </defs>
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="motoScoreValue" class="text-3xl font-black text-white">--</span>
                                </div>
                            </div>
                            <div id="motoScoreText" class="text-xs font-semibold mb-2">--</div>

                            <!-- NEU: Dynamisches 6er Grid -->
                            <div id="motoDynamicGrid" class="grid grid-cols-2 gap-2 w-full mb-2 px-1"></div>

                            <div class="border-t border-slate-600/50 w-full pt-2 mt-auto">
                                <div class="flex justify-between items-center px-1 text-xs"><span
                                        class="text-slate-400">Heute
                                        Ø</span><span id="dailyScoreValue" class="font-bold text-blue-100">--</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="rainChartSection" class="glass-panel rounded-2xl p-4">
                        <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300 mb-3"><i
                                data-lucide="umbrella" size="16"></i> Niederschlag (1h)</h3>
                        <div class="flex justify-between items-end h-24 gap-2" id="rainBarsContainer">
                            <div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">
                                Keine Daten
                            </div>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1 px-1">
                            <span>Jetzt</span><span>15m</span><span>30m</span><span>45m</span>
                        </div>
                    </div>

                    <!-- RADAR SECTION -->
                    <div id="radarSection"
                        class="glass-panel rounded-2xl overflow-hidden shadow-lg transition-all duration-300 flex flex-col">
                        <div
                            class="bg-slate-800/80 p-3 flex justify-between items-center border-b border-slate-700 shrink-0">
                            <h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="map" size="16"
                                    class="text-blue-400"></i><span id="radarTitle">Niederschlag (Live)</span></h3>
                            <div class="flex items-center gap-2">
                                <button onclick="toggleFullscreen()"
                                    class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation"><i
                                        id="fullscreenIcon" data-lucide="maximize-2" size="16"></i></button>
                            </div>
                        </div>
                        <div id="radarFrameContainer"
                            class="relative w-full h-96 bg-slate-900 transition-all duration-300 grow">
                            <div id="radarMap" class="w-full h-full z-0 outline-none"></div>
                            <div
                                class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700/50 flex items-center shadow-lg pointer-events-none z-[400]">
                                <div class="live-dot dot-live" id="radarLiveDot"></div>
                                <span id="radarStatusText"
                                    class="text-[10px] text-slate-400 mr-2 uppercase tracking-wider font-bold">Live</span>
                            </div>
                            <div
                                class="absolute bottom-6 left-4 right-4 bg-slate-900/80 backdrop-blur-md p-2 rounded-xl border border-slate-700/50 flex items-center gap-3 z-[400]">
                                <button onclick="toggleRadarPlayback()" id="radarPlayBtn"
                                    class="p-2 bg-blue-600 rounded-lg text-white hover:bg-blue-500 transition shadow-lg shrink-0 touch-manipulation"><i
                                        data-lucide="pause" size="16"></i></button>
                                <input type="range" id="radarTimeline" min="0" value="0" step="1"
                                    oninput="handleRadarScrub(this.value)"
                                    class="flex-grow h-1 bg-slate-600 rounded-lg cursor-pointer touch-manipulation">
                                <span id="radarTimeLabel"
                                    class="text-xs font-mono font-bold text-white min-w-[40px] text-right">--:--</span>
                            </div>
                        </div>
                    </div>

                    <div id="timelineSection" class="glass-panel rounded-2xl p-4 transition-all duration-300">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300"><i
                                    data-lucide="clock" size="16"></i> Vorhersage</h3>
                            <button onclick="toggleLegend()"
                                class="text-slate-400 hover:text-white transition p-1 bg-slate-800/50 rounded-full hover:bg-slate-700"><i
                                    data-lucide="info" size="16"></i></button>
                        </div>
                        <div id="hourlyContainer"
                            class="flex overflow-x-auto gap-3 pb-2 custom-scrollbar snap-x touch-pan-x scroll-fade-mask"
                            style="touch-action: pan-x;">
                        </div>
                    </div>
                    <div id="forecast7DaySection" class="glass-panel rounded-2xl p-4">
                        <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300 mb-3"><i
                                data-lucide="calendar-days" size="16"></i> 7-Tage Trend</h3>
                        <div id="forecast7List" class="space-y-3"></div>
                    </div>
                </div>

                <div id="startPrompt" class="text-center py-20 text-slate-500 hidden"><i data-lucide="bike"
                        class="mx-auto mb-4 h-16 w-16 opacity-30"></i>
                    <p>Standort wird ermittelt...</p>
                </div>
                <!-- FOOTER ANGEPASST -->
                <div class="text-center text-[10px] text-slate-500 mt-6 pb-4 font-medium tracking-wide opacity-60">
                    MOTO WETTER • RIDE SAFE • N.W.
                </div>
            </main>
        </section> <!-- End Weather View -->

        <!-- === VIEW 2: MOTO ANGLE === -->
        <section id="view-moto"
            class="w-screen h-full flex-shrink-0 snap-center relative bg-slate-950 flex flex-col items-center justify-center overflow-hidden">

            <!-- BACKGROUND LIVE MAP -->
            <!-- BACKGROUND LIVE MAP -->
            <div id="motoLiveMapRefContainer" class="absolute inset-0 z-0 overflow-hidden pointer-events-none">
                <!-- Oversized container for rotation -->
                <div id="motoLiveMap"
                    class="absolute w-[300vw] h-[300vh] left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 opacity-50 grayscale-[80%] transition-transform duration-300 ease-linear origin-center will-change-transform">
                </div>
                <!-- Gradient Overlay for readability -->
                <div
                    class="absolute inset-0 bg-gradient-to-b from-slate-900 via-transparent to-slate-900 pointer-events-none z-[1]">
                </div>
                <div class="absolute inset-0 bg-black/40 pointer-events-none z-[1]"></div>
            </div>

            <div class="relative w-full max-w-md h-full flex flex-col items-center justify-between py-10 z-10 overflow-y-auto custom-scrollbar overscroll-contain px-4"
                style="padding-top: max(2.5rem, env(safe-area-inset-top)); padding-bottom: max(2.5rem, env(safe-area-inset-bottom)); touch-action: pan-y;">
                <!-- Header -->
                <div class="text-center space-y-1 z-20 mt-4">
                    <h2
                        class="text-3xl font-black italic uppercase tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-yellow-500">
                        Moto <span class="text-white">Lean</span></h2>
                    <p class="text-xs font-mono text-slate-500">LIVE ANGLE TRACKING</p>
                </div>

                <!-- CENTER GROUP: Gauge (Higher) -->
                <div class="flex flex-col items-center justify-start w-full flex-grow mt-6">
                    <!-- Main Gauge (Semi-Circle) -->
                    <div class="relative w-64 h-40 flex items-end justify-center">
                        <svg class="absolute inset-0 w-full h-full" viewBox="0 0 200 120"
                            preserveAspectRatio="xMidYMax meet">
                            <!-- Helper grid/lines optional -->
                            <path d="M10,100 A90,90 0 0,1 190,100" stroke="#334155" stroke-width="4" fill="none"
                                stroke-linecap="round" />
                            <!-- 0-Degree Marker -->
                            <path d="M100,10 L100,20" stroke="#475569" stroke-width="2" />

                            <!-- Active Arc (Controlled by JS) -->
                            <path id="motoGaugeArc" d="M100,100 L100,10" stroke="url(#leanGradient)" stroke-width="6"
                                stroke-linecap="round" fill="none" class="transition-all duration-100 ease-linear" />
                            <defs>
                                <linearGradient id="leanGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#3b82f6" />
                                    <stop offset="100%" stop-color="#ef4444" />
                                </linearGradient>
                            </defs>
                        </svg>

                        <!-- Bike Icon (Pivot Point) -->
                        <div id="motoBikeIcon"
                            class="absolute bottom-4 transform transition-transform duration-100 ease-linear origin-bottom text-white drop-shadow-[0_0_15px_rgba(59,130,246,0.6)]">
                            <i data-lucide="bike" size="64"></i>
                        </div>
                    </div>

                </div>


            </div>



            <!-- ZOOM CONTROLS (NEW) -->
            <div class="absolute right-4 top-1/2 -translate-y-1/2 flex flex-col gap-3 z-30">
                <button onclick="if(motoMap) motoMap.zoomIn()"
                    class="p-2 bg-slate-800/80 backdrop-blur-md rounded-full text-white border border-slate-600 shadow-lg active:scale-95 transition"><i
                        data-lucide="plus" size="20"></i></button>
                <button onclick="if(motoMap) motoMap.zoomOut()"
                    class="p-2 bg-slate-800/80 backdrop-blur-md rounded-full text-white border border-slate-600 shadow-lg active:scale-95 transition"><i
                        data-lucide="minus" size="20"></i></button>
            </div>

            <!-- BOTTOM GROUP: Data + Controls (Lower) -->
            <div class="flex flex-col items-center justify-end w-full mb-28 z-20">

                <!-- G-Force Meter (Moved Here) -->
                <div class="flex flex-col items-center w-48 mb-4">
                    <div
                        class="flex justify-between w-full text-[8px] font-bold text-slate-500 uppercase tracking-widest px-1">
                        <span>Brake</span>
                        <span>Accel</span>
                    </div>
                    <div class="relative w-full h-2 bg-slate-800 rounded-full overflow-hidden mt-1">
                        <!-- Center Marker -->
                        <div class="absolute left-1/2 top-0 bottom-0 w-px bg-slate-500 z-10"></div>
                        <!-- Active Bar -->
                        <div id="gForceBar"
                            class="absolute top-0 bottom-0 bg-blue-500 transition-all duration-75 ease-out"
                            style="left: 50%; width: 0%;"></div>
                    </div>
                    <div id="gForceVal" class="text-[9px] font-mono text-slate-400 mt-1">0.0 G</div>
                </div>

                <!-- Digital Readout (Side by Side) -->
                <div class="flex items-center justify-center gap-8 mb-6 w-full max-w-sm">
                    <!-- Angle Side -->
                    <div class="flex flex-col items-center flex-1">
                        <span class="text-[10px] text-slate-500 uppercase font-bold tracking-widest mb-1">Neigung</span>
                        <div class="text-6xl font-black text-white tabular-nums tracking-tighter leading-none"
                            id="motoAngleDisplay">0°</div>
                        <div class="flex gap-4 mt-2 text-[10px] font-bold text-slate-400">
                            <span>L: <span id="maxLeftDisplay" class="text-blue-400">0°</span></span>
                            <span>R: <span id="maxRightDisplay" class="text-blue-400">0°</span></span>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="w-px h-16 bg-slate-700/50"></div>

                    <!-- Speed Side -->
                    <div class="flex flex-col items-center flex-1">
                        <span class="text-[10px] text-blue-500 uppercase font-bold tracking-widest mb-1">Tempo</span>
                        <div class="text-6xl font-black text-blue-400 tabular-nums tracking-tighter leading-none"
                            id="motoSpeedDisplay">0</div>
                        <span class="text-[10px] text-slate-500 mt-2 font-mono">km/h</span>

                    </div>
                </div>

                <!-- Controls -->
                <div class="flex gap-4 z-20 mt-2">
                    <button onclick="resetMotoMax()"
                        class="px-6 py-3 bg-slate-800 rounded-xl font-bold text-sm hover:bg-slate-700 transition active:scale-95 border border-slate-700 shadow-lg">RESET</button>
                    <button id="btnMotoCalibrate" onclick="calibrateMoto()"
                        class="px-6 py-3 bg-blue-900/40 text-blue-300 rounded-xl font-bold text-sm hover:bg-blue-900/60 transition active:scale-95 border border-blue-800/50 shadow-lg">0°
                        Set</button>
                    <button onclick="requestMotoPermission()"
                        class="px-6 py-3 bg-emerald-900/40 text-emerald-300 rounded-xl font-bold text-sm hover:bg-emerald-900/60 transition active:scale-95 border border-emerald-800/50 shadow-lg"
                        id="btnMotoStart">START</button>
                    <button onclick="stopMotoTracking()"
                        class="hidden px-6 py-3 bg-red-900/40 text-red-300 rounded-xl font-bold text-sm hover:bg-red-900/60 transition active:scale-95 border border-red-800/50 shadow-lg"
                        id="btnMotoStop">STOP</button>
                </div>

                <!-- GPS Status Indicator -->
                <div id="motoGpsStatus"
                    class="hidden mt-4 flex items-center gap-2 px-3 py-1 bg-black/40 rounded-full border border-white/10 backdrop-blur-md transition-all">
                    <div id="motoGpsDot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                    <span id="motoGpsText" class="text-[10px] font-bold text-slate-300 uppercase tracking-wider">Suche
                        GPS...</span>
                </div>
            </div>

            <div class="absolute bottom-4">
                <button onclick="scrollToWeather()" region="navigation"
                    class="flex items-center gap-2 text-slate-400 hover:text-white transition px-4 py-2 bg-slate-800/80 backdrop-blur-md rounded-full border border-slate-700/50 shadow-xl">
                    <i data-lucide="arrow-left" size="16"></i> Zurück zum Wetter
                </button>
            </div>
    </div>
    </section>
    </div> <!-- End View Container -->

    <!-- MODALS -->
    <!-- SETTINGS MODAL (Updated with Moto Profile) -->
    <div id="settingsModal" onclick="if(event.target === this) hideModal('settingsModal')"
        class="hidden fixed inset-0 z-[99] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0 modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="toggleSettings()"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="settings-2"
                    size="20"></i> Einstellungen</h3>
            <div class="space-y-3 text-sm max-h-[70vh] overflow-y-auto custom-scrollbar pb-2">

                <!-- History Section (Top Priority) -->
                <button onclick="showRideHistory()"
                    class="w-full p-3 bg-slate-800/50 rounded-xl border border-slate-600/50 flex items-center justify-between text-left hover:bg-white/5 transition group">
                    <span class="text-xs font-bold uppercase text-slate-300 flex items-center gap-2">
                        <i data-lucide="history" size="14" class="text-yellow-400"></i> Fahrtenbuch
                    </span>
                    <i data-lucide="chevron-right" class="text-slate-400 group-hover:text-white transition"></i>
                </button>

                <!-- Moto Profile Section (Collapsible) -->
                <div class="bg-slate-800/50 rounded-xl border border-blue-500/30 overflow-hidden">
                    <button onclick="toggleSettingsSection('profile')"
                        class="w-full p-3 flex items-center justify-between text-left hover:bg-white/5 transition">
                        <h4 class="text-xs font-bold uppercase text-blue-300 flex items-center gap-2"><i
                                data-lucide="user-cog" size="14"></i> Biker Profil</h4>
                        <i id="icon-profile" data-lucide="chevron-right"
                            class="text-slate-400 transition-transform duration-300"></i>
                    </button>
                    <div id="content-profile" class="hidden p-3 pt-0 border-t border-slate-700/50 mt-1">
                        <div class="mb-4 mt-2">
                            <div class="flex justify-between text-xs text-slate-300 mb-1"><span>Min. Temp
                                    (Wohlfühl)</span><span id="dispMinTemp" class="font-bold text-white">10°C</span>
                            </div>
                            <input type="range" min="0" max="25" step="1" id="inputMinTemp"
                                oninput="updateMotoSettings('minTemp', this.value)"
                                class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                                <span>0°</span><span>25°</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="flex justify-between text-xs text-slate-300 mb-1"><span>Max. Wind
                                    (Böen)</span><span id="dispMaxWind" class="font-bold text-white">40 km/h</span>
                            </div>
                            <input type="range" min="20" max="100" step="5" id="inputMaxWind"
                                oninput="updateMotoSettings('maxWind', this.value)"
                                class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                                <span>20</span><span>100</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between mt-2">
                            <span class="text-xs text-slate-300">Regen-Empfindlichkeit</span>
                            <button id="btnRainTol" onclick="toggleRainTolerance()"
                                class="px-3 py-1 rounded-lg text-xs font-bold transition bg-blue-600 text-white border border-blue-500">Streng</button>
                        </div>
                        <div id="rainTolDesc" class="text-[10px] text-slate-500 mt-1 text-right">Kein Tropfen erlaubt!
                        </div>

                        <!-- NEW: Map Opacity -->
                        <div class="mb-4 mt-4">
                            <div class="flex justify-between text-xs text-slate-300 mb-1">
                                <span>Karten-Deckkraft</span><span id="dispMapOpacity"
                                    class="font-bold text-white">50%</span>
                            </div>
                            <input type="range" min="0" max="100" step="5" id="inputMapOpacity"
                                oninput="updateMotoMapSettings('opacity', this.value)"
                                class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-[10px] text-slate-500 mt-1">
                                <span>0%</span><span>100%</span>
                            </div>
                        </div>


                    </div>
                </div>

                <!-- Grid Config Section (Collapsible) -->
                <div class="bg-slate-800/50 rounded-xl border border-slate-600/50 overflow-hidden">
                    <button onclick="toggleSettingsSection('grid')"
                        class="w-full p-3 flex items-center justify-between text-left hover:bg-white/5 transition">
                        <!-- UMBENANNT: Info-Kacheln -> MOTO INDEX INFOS -->
                        <h4 class="text-xs font-bold uppercase text-slate-300 flex items-center gap-2"><i
                                data-lucide="layout-grid" size="14"></i> MOTO INDEX INFOS</h4>
                        <i id="icon-grid" data-lucide="chevron-right"
                            class="text-slate-400 transition-transform duration-300"></i>
                    </button>
                    <div id="content-grid" class="hidden p-3 pt-0 border-t border-slate-700/50 mt-1">
                        <div id="gridConfigList" class="space-y-1 mb-2 mt-2"></div>
                        <div class="text-[10px] text-slate-500 text-right">Maximal 6 Infos</div>
                        <div id="gridAvailableList" class="space-y-1 mt-3 pt-3 border-t border-slate-700/50"></div>
                    </div>
                </div>

                <!-- Layout Section (Collapsible) -->
                <div class="bg-slate-800/50 rounded-xl border border-slate-600/50 overflow-hidden">
                    <button onclick="toggleSettingsSection('layout')"
                        class="w-full p-3 flex items-center justify-between text-left hover:bg-white/5 transition">
                        <h4 class="text-xs font-bold uppercase text-slate-400 flex items-center gap-2"><i
                                data-lucide="eye" size="14"></i> Layout</h4>
                        <i id="icon-layout" data-lucide="chevron-right"
                            class="text-slate-400 transition-transform duration-300"></i>
                    </button>
                    <div id="content-layout" class="hidden p-3 pt-0 border-t border-slate-700/50 mt-1">
                        <div class="space-y-2 mt-2" id="layoutList"></div>
                        <div class="pt-2 mt-2 border-t border-slate-600/50">
                            <div class="flex justify-between items-center bg-slate-800/30 p-2 rounded-lg mb-2">
                                <span>Wetter-Daten</span><button onclick="toggleSubVisibility('weather')"
                                    id="vis-weather-btn" class="text-green-400"><i data-lucide="eye"
                                        size="18"></i></button>
                            </div>
                            <div class="flex justify-between items-center bg-slate-800/30 p-2 rounded-lg"><span>Moto
                                    Index</span><button onclick="toggleSubVisibility('moto')" id="vis-moto-btn"
                                    class="text-green-400"><i data-lucide="eye" size="18"></i></button></div>
                        </div>
                    </div>
                </div>

                <!-- Changelog Button (Manual) -->
                <button onclick="showChangelog()"
                    class="w-full p-3 mt-4 bg-slate-800/50 rounded-xl border border-emerald-500/30 flex items-center justify-between text-left hover:bg-emerald-500/10 transition group">
                    <span class="text-xs font-bold uppercase text-emerald-400 flex items-center gap-2">
                        <i data-lucide="sparkles" size="14"></i> Was ist neu?
                    </span>
                    <i data-lucide="chevron-right" class="text-slate-400 group-hover:text-white transition"></i>
                </button>


                <button onclick="resetLayout()"
                    class="w-full py-2 mt-2 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition">Reset
                    App</button>
            </div>
        </div>
    </div>

    <!-- BEST RIDE DETAILS MODAL -->
    <div id="bestRideModal" onclick="if(event.target === this) hideModal('bestRideModal')"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0 modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border-yellow-500/30 modal-content">
            <button onclick="hideModal('bestRideModal')"
                class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-yellow-300 flex items-center gap-2"><i data-lucide="star"
                    size="20"></i> Beste Zeit Details</h3>

            <div class="flex flex-col items-center mb-6">
                <div id="brDetailScoreCircle"
                    class="w-16 h-16 rounded-full border-4 border-yellow-500 flex items-center justify-center bg-yellow-500/10 mb-2">
                    <span id="brDetailScore" class="text-xl font-black text-yellow-100">--</span>
                </div>
                <div id="brDetailTime" class="text-2xl font-bold text-white">--:-- - --:--</div>
                <div id="brDetailDay" class="text-sm text-yellow-200/80 font-medium uppercase tracking-wider">--</div>
            </div>

            <div class="space-y-3">
                <h4
                    class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-700/50 pb-1 mb-2">
                    Warum diese Zeit?</h4>
                <div id="brReasonsList" class="space-y-2">
                    <!-- Dynamic Reasons -->
                </div>
            </div>
            <p class="text-[10px] text-slate-500 text-center mt-6 italic">Basierend auf Temperatur, Wind, Regenrisiko
                und Tageszeit.</p>
        </div>
    </div>

    <!-- BEST RIDE DETAILS MODAL -->
    <div id="bestRideModal" onclick="if(event.target === this) hideModal('bestRideModal')"
        class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300 opacity-0 modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border-yellow-500/30 modal-content max-h-[85vh] flex flex-col">
            <div class="shrink-0">
                <button onclick="document.getElementById('bestRideModal').classList.add('hidden')"
                    class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i
                        data-lucide="x" size="20"></i></button>
                <h3 class="text-lg font-bold mb-4 text-yellow-300 flex items-center gap-2"><i data-lucide="star"
                        size="20"></i> Beste Zeit Details</h3>
            </div>

            <div class="overflow-y-auto flex-1 min-h-0 -mx-4 px-4 custom-scrollbar">
                <div class="flex flex-col items-center mb-6">
                    <div id="brDetailScoreCircle"
                        class="w-16 h-16 rounded-full border-4 border-yellow-500 flex items-center justify-center bg-yellow-500/10 mb-2">
                        <span id="brDetailScore" class="text-xl font-black text-yellow-100">--</span>
                    </div>
                    <div id="brDetailTime" class="text-2xl font-bold text-white">--:-- - --:--</div>
                    <div id="brDetailDay" class="text-sm text-yellow-200/80 font-medium uppercase tracking-wider mb-2">
                        --
                    </div>

                    <div
                        class="flex items-center gap-2 bg-slate-800/50 px-3 py-1 rounded-full border border-slate-700/50">
                        <i data-lucide="thermometer" size="14" class="text-emerald-400"></i>
                        <span id="brDetailTempDisplay" class="text-sm font-bold text-emerald-100">--°</span>
                    </div>
                </div>

                <div class="space-y-3">
                    <h4
                        class="text-xs font-bold text-slate-400 uppercase tracking-widest border-b border-slate-700/50 pb-1 mb-2">
                        Warum diese Zeit?</h4>
                    <div id="brReasonsList" class="space-y-2">
                        <!-- Dynamic Reasons -->
                    </div>
                </div>
                <p class="text-[10px] text-slate-500 text-center mt-6 italic">Basierend auf Temperatur, Wind,
                    Regenrisiko
                    und Tageszeit.</p>
            </div>
        </div>
    </div>

    <!-- DAILY DETAILS MODAL (Updated) -->
    <div id="dailyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content max-h-[80vh] flex flex-col">
            <div class="shrink-0 mb-2">
                <button onclick="document.getElementById('dailyDetailsModal').classList.add('hidden')"
                    class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                        data-lucide="x" size="20"></i></button>
                <h3 class="text-lg font-bold mb-2 text-blue-100 flex items-center gap-2"><i data-lucide="calendar"
                        size="20"></i> <span id="dailyDetailTitle">Tages-Infos</span></h3>
                <p id="dailyDetailDate" class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Details</p>
            </div>

            <div class="overflow-y-auto flex-1 min-h-0 -mx-4 px-4 custom-scrollbar">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                data-lucide="sunrise" size="12"></i> Aufgang</div>
                        <div id="detailSunrise" class="font-bold">--:--</div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                data-lucide="sunset" size="12"></i> Untergang</div>
                        <div id="detailSunset" class="font-bold">--:--</div>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-4 rounded-xl mb-4 border border-slate-700/50">
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-slate-400 text-xs flex items-center gap-1"><i data-lucide="umbrella"
                                size="12"></i>
                            Regen</div>
                        <div class="text-blue-300 font-bold text-sm"><span id="detailPrecipSum">0</span> mm</div>
                    </div>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mb-1">
                        <div id="detailPrecipProbBar" class="bg-blue-500 h-1.5 rounded-full" style="width:0%"></div>
                    </div>
                    <div class="text-[10px] text-right text-slate-500"><span id="detailPrecipProb">0</span>% Wahrsch.
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                data-lucide="wind" size="12"></i> Max Wind</div>
                        <div class="font-bold text-white"><span id="detailWindMax">--</span> <span
                                class="text-xs font-normal text-slate-400">km/h</span></div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                data-lucide="sun" size="12"></i> Max UV</div>
                        <div class="font-bold text-white"><span id="detailUVMax">--</span></div>
                    </div>
                </div>

                <!-- Current Day Only Logic -->
                <div id="currentDayExtras" class="hidden">
                    <div id="sunCountdownContainer"
                        class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-2 mb-4 text-center">
                        <div class="text-xs text-yellow-200 font-medium flex items-center justify-center gap-2"><i
                                data-lucide="hourglass" size="12"></i> <span id="sunCountdownText">...</span></div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl flex justify-between items-center">
                        <span class="text-sm text-slate-300">Luftqualität (AQI)</span>
                        <div class="flex items-center gap-2"><span id="detailAqiVal"
                                class="font-bold text-white">--</span>
                            <div id="detailAqiBar" class="w-2 h-2 rounded-full bg-slate-600"></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6 mt-4">
                        <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                            <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                    data-lucide="eye" size="12"></i> Sicht</div>
                            <div id="detailVisibility" class="font-bold">--</div>
                        </div>
                        <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                            <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i
                                    data-lucide="sun" size="12"></i> UV</div>
                            <div id="detailUV" class="font-bold">--</div>
                        </div>
                    </div>
                </div>

                <!-- STÜNDLICHER REGEN VERLAUF -->
                <div id="dailyHourlyRain"
                    class="mt-4 mb-2 max-h-48 overflow-y-auto custom-scrollbar border-t border-slate-700/50 pt-2"></div>

                <div id="dailyMotoScore"
                    class="mt-4 p-3 rounded-xl border border-slate-600/50 flex justify-between items-center bg-slate-800">
                    <span class="text-xs uppercase font-bold text-slate-400">Tages-Score</span>
                    <span id="dailyScoreDetailVal" class="font-black text-lg">--</span>
                </div>
            </div>
        </div>
    </div>

    <div id="motoDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="document.getElementById('motoDetailsModal').classList.add('hidden')"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-2 text-white flex items-center gap-2"><i data-lucide="bike" size="24"
                    class="text-blue-400"></i> Moto Analyse</h3>
            <p class="text-xs text-slate-400 mb-4">Details</p>
            <div id="motoAnalysisList" class="space-y-3 mb-6"></div>

        </div>
    </div>
    <div id="hourlyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-xs rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="closeHourlyModal()"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <div class="text-center mb-4">
                <div id="modalTime" class="text-lg font-bold text-blue-200">--:--</div>
                <div id="modalDesc" class="text-sm text-slate-400">--</div>
            </div>
            <div class="flex flex-col items-center justify-center mb-6">
                <div id="modalIcon" class="mb-2 transform scale-125"></div>
                <div class="text-5xl font-bold tracking-tighter"><span id="modalTemp">--</span>°</div>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-4 text-center">
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <div class="text-slate-400 text-[10px] mb-1"><i data-lucide="wind" size="12" class="inline"></i>
                        Wind</div>
                    <div id="modalWind" class="font-bold text-sm">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <div class="text-slate-400 text-[10px] mb-1"><i data-lucide="umbrella" size="12" class="inline"></i>
                        Regen</div>
                    <div id="modalRain" class="font-bold text-sm">--</div>
                </div>
                <div class="bg-slate-800/50 rounded-lg p-2">
                    <div class="text-slate-400 text-[10px] mb-1"><i data-lucide="droplets" size="12" class="inline"></i>
                        Feuchte</div>
                    <div id="modalHum" class="font-bold text-sm">--</div>
                </div>
            </div>
            <div id="modalScoreBg" class="rounded-xl p-3 border flex items-center justify-between"><span
                    class="font-bold uppercase text-xs tracking-wider">Moto Index</span>
                <div class="text-right"><span id="modalScoreVal" class="text-xl font-black">--</span><span
                        class="text-xs opacity-80">/10</span></div>
            </div>
        </div>
    </div>
    <div id="legendModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative max-h-[85vh] overflow-y-auto custom-scrollbar shadow-2xl border-slate-600/50 modal-content">
            <button onclick="toggleLegend()"
                class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-blue-100 flex items-center gap-2"><i data-lucide="cloud-sun"
                    size="20"></i> Legende</h3>
            <div class="grid grid-cols-1 gap-2 text-sm text-slate-300">
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="sun"
                        class="text-yellow-400 w-6 h-6"></i> <span>Klar</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-sun"
                        class="text-blue-200 w-6 h-6"></i> <span>Bewölkt</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-fog"
                        class="text-gray-400 w-6 h-6"></i> <span>Nebel</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-rain"
                        class="text-blue-400 w-6 h-6"></i> <span>Regen</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="snowflake"
                        class="text-white w-6 h-6"></i> <span>Schnee</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-lightning"
                        class="text-purple-400 w-6 h-6"></i> <span>Gewitter</span></div>
            </div>
        </div>
    </div>

    <div id="favoritesModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[150] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-red-500/30 modal-content max-h-[70vh] flex flex-col pointer-events-auto">

            <button onclick="document.getElementById('favoritesModal').classList.add('hidden')"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full z-50 cursor-pointer"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-red-200 flex items-center gap-2"><i data-lucide="heart" size="20"
                    class="text-red-500 fill-red-500"></i> Favoriten</h3>
            <div id="favoritesListContent" class="overflow-y-auto custom-scrollbar flex-1 min-h-0 relative z-10">
                <!-- List -->
            </div>

            <button onclick="document.getElementById('favoritesModal').classList.add('hidden')"
                class="w-full mt-4 py-3 bg-slate-700/50 hover:bg-slate-700 text-slate-300 rounded-xl font-bold transition z-50 cursor-pointer">Schließen</button>
        </div>
    </div>

    <!-- RIDE HISTORY MODAL -->
    <div id="rideHistoryModal" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-blue-500/30 modal-content h-[80vh] flex flex-col">
            <button onclick="document.getElementById('rideHistoryModal').classList.add('hidden')"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="history" size="20"
                    class="text-yellow-400"></i> Fahrtenbuch</h3>

            <div id="rideHistoryList" class="overflow-y-auto flex-1 min-h-0 -mx-4 px-4 custom-scrollbar space-y-3">
                <!-- Dynamic Content -->
            </div>

            <button onclick="clearRideHistory()"
                class="mt-4 w-full py-3 bg-red-900/20 text-red-400 hover:bg-red-900/40 rounded-xl border border-red-900/50 font-bold transition flex items-center justify-center gap-2">
                <i data-lucide="trash-2" size="16"></i> Verlauf löschen
            </button>
        </div>
    </div>

    <!-- CHANGELOG MODAL -->
    <div id="changelogModal"
        class="hidden fixed inset-0 z-[200] flex items-center justify-center p-6 bg-black/60 backdrop-blur-xl animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-3xl p-6 relative shadow-2xl border border-emerald-500/30 flex flex-col items-center text-center pointer-events-auto">

            <div
                class="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mb-4 border border-emerald-500/50 shadow-lg glow-icon">
                <i data-lucide="sparkles" class="text-emerald-400" size="32"></i>
            </div>

            <h2 class="text-2xl font-black text-white mb-1">Was ist neu?</h2>
            <p class="text-xs text-emerald-400 font-bold uppercase tracking-widest mb-6">Version 1.3.0 Update</p>

            <div class="w-full text-left space-y-4 mb-8">
                <div class="flex gap-3">
                    <div class="mt-1 min-w-[20px]"><i data-lucide="heart" class="text-red-400" size="18"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-white">Favorites Fixed</h4>
                        <p class="text-xs text-slate-400">Das "X" und Layout der Favoriten-Liste funktioniert wieder.
                        </p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="mt-1 min-w-[20px]"><i data-lucide="layers" class="text-blue-200" size="18"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-white">Glass is Back</h4>
                        <p class="text-xs text-slate-400">Transparenz bei Popups korrigiert (kein Black-on-Black mehr).
                        </p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="mt-1 min-w-[20px]"><i data-lucide="scan-face" class="text-purple-400" size="18"></i>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-white">Ghost Touch Fix</h4>
                        <p class="text-xs text-slate-400">Listen-Elemente bleiben nicht mehr "kleben" beim Scrollen.</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <div class="mt-1 min-w-[20px]"><i data-lucide="moon" class="text-slate-400" size="18"></i></div>
                    <div>
                        <h4 class="text-sm font-bold text-white">Darker Tiles</h4>
                        <p class="text-xs text-slate-400">Kontrast der Wetter-Kacheln verbessert.</p>
                    </div>
                </div>
            </div>

            <button onclick="closeChangelog()"
                class="w-full py-3.5 bg-white text-black font-bold rounded-xl hover:bg-slate-200 transition active:scale-95 shadow-lg relative z-[201]">
                Cool, verstanden! 🚀
            </button>
        </div>
    </div>

    <!-- RIDE DETAIL MODAL (Overlay) -->
    <div id="rideDetailModal"
        class="fixed inset-0 z-[99] flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-300 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-md pointer-events-auto" onclick="closeRideDetail()">
        </div>
        <div
            class="glass-panel w-full max-w-md m-4 pointer-events-auto transform transition-transform duration-300 scale-95 rounded-3xl border border-white/10 p-6 flex flex-col gap-6 relative">

            <button onclick="closeRideDetail()"
                class="absolute top-4 right-4 p-2 bg-slate-800/50 rounded-full text-slate-400 hover:text-white"><i
                    data-lucide="x" size="20"></i></button>

            <!-- Header -->
            <div class="text-center">
                <div id="detailDate" class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-1">DATA
                    Loading...</div>
                <h2 id="detailTitle" class="text-2xl font-black text-white leading-none">Tour Name</h2>
                <div id="detailTimeDuration" class="text-sm text-slate-400 mt-2 font-mono">12:30 • 45min</div>
            </div>

            <!-- Main Stats Grid -->
            <div class="grid grid-cols-2 gap-4">
                <div
                    class="bg-slate-800/40 p-4 rounded-2xl flex flex-col items-center justify-center border border-slate-700/30">
                    <div class="text-3xl font-black text-white flex items-end gap-1">
                        <span id="detailMaxSpeed">0</span>
                        <span class="text-sm font-bold text-slate-500 mb-1">km/h</span>
                    </div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold mt-1">Top Speed</div>
                </div>
                <!-- Distance Display -->
                <div
                    class="bg-slate-800/40 p-4 rounded-2xl flex flex-col items-center justify-center border border-slate-700/30">
                    <div class="text-3xl font-black text-white flex items-end gap-1">
                        <span id="detailDistance">0.0</span>
                        <span class="text-sm font-bold text-slate-500 mb-1">km</span>
                    </div>
                    <div class="text-[10px] text-slate-400 uppercase font-bold mt-1">Distanz</div>
                </div>
            </div>

            <!-- Secondary Stats -->
            <div class="grid grid-cols-3 gap-2 text-center">
                <div class="bg-slate-800/20 p-2 rounded-xl">
                    <div class="text-[10px] text-slate-500 uppercase">Max G</div>
                    <div id="detailMaxG" class="text-lg font-bold text-white">0.0</div>
                </div>
                <div class="bg-slate-800/20 p-2 rounded-xl">
                    <div class="text-[10px] text-slate-500 uppercase">Lean L</div>
                    <div id="detailLeanL" class="text-lg font-bold text-blue-400">0°</div>
                </div>
                <div class="bg-slate-800/20 p-2 rounded-xl">
                    <div class="text-[10px] text-slate-500 uppercase">Lean R</div>
                    <div id="detailLeanR" class="text-lg font-bold text-blue-400">0°</div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-2 mt-2">
                <button id="btnDetailRename"
                    class="flex-1 py-3 rounded-xl bg-slate-700 hover:bg-slate-600 text-white font-bold text-sm transition flex items-center justify-center gap-2">
                    <i data-lucide="edit-2" size="16"></i> Umbenennen
                </button>
                <button id="btnDetailDelete"
                    class="flex-none w-12 py-3 rounded-xl bg-red-900/20 hover:bg-red-900/40 text-red-400 font-bold text-sm transition flex items-center justify-center border border-red-900/30">
                    <i data-lucide="trash-2" size="18"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- DEV MENU MODAL -->
    <div id="devMenu" onclick="if(event.target === this) this.classList.add('hidden')"
        class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black/50 backdrop-blur-md animate-fade-in modal-overlay">
        <div
            class="glass-panel w-full max-w-sm rounded-2xl p-5 relative shadow-2xl border border-red-500/30 modal-content">
            <button onclick="document.getElementById('devMenu').classList.add('hidden')"
                class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i
                    data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-1 text-red-400 flex items-center gap-2"><i data-lucide="terminal"
                    size="20"></i> Developer FX</h3>
            <p class="text-xs text-slate-500 mb-4 font-mono">Effekte erzwingen (nur visuell)</p>

            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="forceEffect(0, 1)" class="dev-btn">☀️ Klar (Tag)</button>
                <button onclick="forceEffect(0, 0)" class="dev-btn">🌙 Klar (Nacht)</button>
                <button onclick="forceEffect(3, 1)" class="dev-btn">☁️ Wolkig</button>
                <button onclick="forceEffect(61, 1)" class="dev-btn">💧 Regen (Leicht)</button>
                <button onclick="forceEffect(63, 1)" class="dev-btn">🌧️ Regen (Mittel)</button>
                <button onclick="forceEffect(65, 1)" class="dev-btn">⛈️ Regen (Stark)</button>
                <button onclick="forceEffect(71, 1)" class="dev-btn">❄️ Schnee</button>
                <button onclick="forceEffect(45, 1)" class="dev-btn">🌫️ Nebel</button>
                <button onclick="forceEffect(95, 1)" class="dev-btn">⚡ Gewitter</button>
                <button onclick="forceEffect(3, 1, true)" class="dev-btn">🌥️ Bedeckt++</button>
                <!-- NEU: Vögel Button -->
                <button onclick="forceEffect(0, 1, false, true)" class="dev-btn border-yellow-500/50 text-yellow-200">🦅
                    Vögel (Klar)</button>
            </div>

            <button onclick="resetEffects()"
                class="w-full bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                <i data-lucide="refresh-cw" size="16"></i> Reset zu Live
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // State
        let currentLat = 51.1657; let currentLon = 10.4515;
        let lastWeatherData = null;
        let isFullscreen = false; let debounceTimer; let clockInterval;
        let currentHeading = 0;
        let currentRotation = 0; // NEW: Track rotation for smooth wrapping
        let compassTicking = false; // NEW: For animation frame
        let isFirstLoad = true;
        let lightningTimeout;
        let refreshTimer = null; // NEW: Timer for auto-refresh
        let currentCityName = "Standort"; // NEW: Store name for refresh
        let currentCountry = ""; // NEW: Store country for refresh
        let lastPastIndex = 0; // NEW: Store index where history ends

        let motoMap = null;
        let motoMarker = null;
        let motoWatchId = null;
        let isMotoMapInitialized = false;



        // --- HAPTIC FEEDBACK SYSTEM ---
        const vibrate = (pattern = 10) => {
            if (navigator.vibrate) navigator.vibrate(pattern);
        };
        // Global Click Listener for Haptics
        document.addEventListener('click', (e) => {
            if (e.target.closest('button') || e.target.closest('.glass-btn') || e.target.closest('.fav-item') || e.target.closest('.glass-panel[onclick]')) {
                vibrate(8);
            }
        });

        // --- FEATURE: DYNAMIC THEME ENGINE ---
        function updateDynamicTheme(weatherCode, isDay) {
            const body = document.body;
            // Reset all theme classes
            body.className = body.className.replace(/theme-[\w-]+/g, '').trim();

            // 1. Determine Base Theme
            let themeClass = 'theme-clear-day'; // Default

            if (!isDay) {
                // Night Logic
                if ([0, 1].includes(weatherCode)) themeClass = 'theme-clear-night';
                else if ([2, 3, 45, 48].includes(weatherCode)) themeClass = 'theme-cloudy-night';
                else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(weatherCode)) themeClass = 'theme-rain-night';
                else if ([71, 73, 75, 77, 85, 86].includes(weatherCode)) themeClass = 'theme-extreme'; // Snow night
                else if ([95, 96, 99].includes(weatherCode)) themeClass = 'theme-extreme';
                else themeClass = 'theme-cloudy-night';
            } else {
                // Day Logic
                if (weatherCode === 0) themeClass = 'theme-clear-day';
                else if ([1, 2, 3].includes(weatherCode)) themeClass = 'theme-cloudy-day'; // Partly cloudy
                else if ([45, 48].includes(weatherCode)) themeClass = 'theme-cloudy-day'; // Fog
                else if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(weatherCode)) themeClass = 'theme-rain-day';
                else if ([71, 73, 75, 77, 85, 86].includes(weatherCode)) themeClass = 'theme-extreme'; // Snow
                else if ([95, 96, 99].includes(weatherCode)) themeClass = 'theme-extreme';
                else themeClass = 'theme-cloudy-day';
            }

            // Add new class
            body.classList.add(themeClass);

            // Refine Glass panels based on theme (optional, can be done via CSS var)
        }


        // --- FEATURE 7: RAIN GLASS EFFECT CLASS ---
        class RainGlass {
            constructor() {
                this.canvas = document.getElementById('rainGlassCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.drops = [];
                this.active = false;
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.animate = this.animate.bind(this);
            }
            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
            }
            start() {
                if (this.active) return;
                this.active = true;
                this.canvas.style.opacity = 1;
                this.animate();
            }
            stop() {
                this.active = false;
                this.canvas.style.opacity = 0;
                setTimeout(() => this.drops = [], 1000);
            }
            addDrop() {
                this.drops.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    r: Math.random() * 2 + 1,
                    vel: Math.random() * 0.5 + 0.1,
                    life: 100 + Math.random() * 100
                });
            }
            animate() {
                if (!this.active) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                if (Math.random() > 0.8) this.addDrop();

                this.ctx.fillStyle = 'rgba(200, 220, 255, 0.4)'; // Drop body
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)'; // Highlight

                for (let i = 0; i < this.drops.length; i++) {
                    const d = this.drops[i];
                    d.y += d.vel;
                    d.life--;

                    this.ctx.beginPath();
                    this.ctx.arc(d.x, d.y, d.r, 0, Math.PI * 2);
                    this.ctx.fill();

                    // Small highlight to look like glass refraction
                    this.ctx.beginPath();
                    this.ctx.arc(d.x - d.r / 3, d.y - d.r / 3, d.r / 3, 0, Math.PI * 2);
                    this.ctx.fillStyle = 'rgba(255,255,255,0.6)';
                    this.ctx.fill();
                    this.ctx.fillStyle = 'rgba(200, 220, 255, 0.4)'; // Reset

                    if (d.life <= 0 || d.y > this.canvas.height) {
                        this.drops.splice(i, 1);
                        i--;
                    }
                }
                requestAnimationFrame(this.animate);
            }
        }
        const rainGlass = new RainGlass();

        // MOTO PROFILE STATE
        // (Old motoProfile definition removed)

        // --- MOTO GRID CONFIG (CUSTOMIZABLE) ---
        // Definition der verfügbaren Metriken
        const metricDefinitions = {
            grip: { label: 'Grip', id: 'grip' },
            gear: { label: 'Gear', id: 'gear' },
            vis: { label: 'Sicht', id: 'vis' },
            rain: { label: 'Regen in', id: 'rain' },
            sun: { label: 'Sunset', id: 'sun' },
            wind: { label: 'MAX WIND', id: 'wind' }, // UMBENANNT: Wind -> MAX WIND
            uv: { label: 'UV', id: 'uv' },
            clouds: { label: 'Wolken', id: 'clouds' },
            hum: { label: 'Feuchte', id: 'hum' },
            press: { label: 'Druck', id: 'press' }
            // ENTFERNT: rise, avg_wind, feel, dew
        };

        let motoGridConfig = ['grip', 'gear', 'vis', 'rain', 'sun', 'wind']; // Default 6
        try {
            const savedGrid = localStorage.getItem('motoGridConfig_v1');
            if (savedGrid) motoGridConfig = JSON.parse(savedGrid);
        } catch (e) { }

        // RACE TIMER VARIABLES
        // REMOVED

        // SESSION TRACKING (RIDE LOG)
        let sessionStartTime = 0;
        let sessionMaxSpeed = 0;
        let sessionMaxG = 0;
        let sessionDistance = 0; // Meters
        let sessionMaxLeft = 0;
        let sessionMaxRight = 0;
        let radarMap = null;
        let radarMarker = null;
        let radarTimestamps = [];
        let radarLayers = {};
        let currentRadarIndex = 0;
        let radarAnimationInterval = null;
        let isRadarPlaying = false;

        let devTapCount = 0;
        let devTapTimer;

        // --- HELPER TO SAFELY SET TEXT ---
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        // --- MOTO PROFILE FUNCTIONS ---
        function updateMotoSettings(key, value) {
            if (key === 'minTemp') {
                motoProfile.minTemp = parseInt(value);
                safeSetText('dispMinTemp', motoProfile.minTemp + "°C");
            } else if (key === 'maxWind') {
                motoProfile.maxWind = parseInt(value);
                safeSetText('dispMaxWind', motoProfile.maxWind + " km/h");
            }
            saveMotoProfile();
        }

        function toggleRainTolerance() {
            motoProfile.strictRain = !motoProfile.strictRain;
            renderMotoSettingsUI(); // Update texts/colors
            saveMotoProfile();
        }

        function toggleStrictRain() { // Alias for compatibility if needed
            toggleRainTolerance();
        }

        function saveMotoProfile() {
            localStorage.setItem('motoProfile_v1', JSON.stringify(motoProfile));
            if (lastWeatherData) updateUI(null, true); // Recalculate scores live
        }

        // --- GRID CONFIG FUNCTIONS ---
        function toggleGridItem(id) {
            const idx = motoGridConfig.indexOf(id);
            if (idx > -1) {
                // Remove
                motoGridConfig.splice(idx, 1);
            } else {
                // Add if < 6
                if (motoGridConfig.length < 6) {
                    motoGridConfig.push(id);
                } else {
                    // Optional: alert or replace last? Just do nothing for now.
                    alert("Maximal 6 Infos erlaubt!");
                    return;
                }
            }
            saveGridConfig();
            renderSettingsList(); // Update UI
            if (lastWeatherData) updateMainValues(...[0, 0, 0, 0, 0, 0, 0, 0]); // Trigger redraw (hacky way to call update without args, main values will fetch from lastWeatherData inside)
        }

        function moveGridItem(id, direction) {
            const idx = motoGridConfig.indexOf(id);
            if (idx < 0) return;
            const newIdx = idx + direction;
            if (newIdx >= 0 && newIdx < motoGridConfig.length) {
                [motoGridConfig[idx], motoGridConfig[newIdx]] = [motoGridConfig[newIdx], motoGridConfig[idx]];
                saveGridConfig();
                renderSettingsList();
                if (lastWeatherData) updateMainValues(...[0, 0, 0, 0, 0, 0, 0, 0]);
            }
        }

        function saveGridConfig() {
            localStorage.setItem('motoGridConfig_v1', JSON.stringify(motoGridConfig));
        }

        // --- NEW: TOGGLE SETTINGS SECTIONS ---
        function toggleSettingsSection(id) {
            const content = document.getElementById('content-' + id);
            const icon = document.getElementById('icon-' + id);

            // Close others (optional - for accordion feel)
            // ['profile', 'grid', 'layout'].forEach(key => {
            //     if(key !== id) {
            //         document.getElementById('content-'+key).classList.add('hidden');
            //         document.getElementById('icon-'+key).classList.remove('rotate-90');
            //     }
            // });

            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.add('rotate-90');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-90');
            }
        }

        function renderMotoSettingsUI() {
            // Update Inputs
            const inTemp = document.getElementById('inputMinTemp');
            const inWind = document.getElementById('inputMaxWind');
            if (inTemp) inTemp.value = motoProfile.minTemp;
            if (inWind) inWind.value = motoProfile.maxWind;

            // Update Texts
            safeSetText('dispMinTemp', motoProfile.minTemp + "°C");
            safeSetText('dispMaxWind', motoProfile.maxWind + " km/h");

            // Update Button
            const btn = document.getElementById('btnRainTol');
            const desc = document.getElementById('rainTolDesc');
            if (btn) {
                if (motoProfile.strictRain) {
                    btn.innerText = "Streng";
                    btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-blue-600 text-white border border-blue-500";
                    safeSetText('rainTolDesc', "Kein Tropfen erlaubt!");
                } else {
                    btn.innerText = "Locker";
                    btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-slate-600 text-slate-300 border border-slate-500";
                    safeSetText('rainTolDesc', "Leichter Regen okay.");
                }
            }

            // Map Opacity UI init
            const dOp = document.getElementById('dispMapOpacity'); if (dOp) dOp.innerText = Math.round(motoProfile.mapOpacity * 100) + "%";
            const iOp = document.getElementById('inputMapOpacity'); if (iOp) iOp.value = Math.round(motoProfile.mapOpacity * 100);
        }

        // --- DEV MENU TRIGGER (ROBUST VERSION) ---
        function handleDevTrigger() {
            clearTimeout(devTapTimer);
            devTapCount++;
            if (devTapCount >= 3) {
                try {
                    const menu = document.getElementById('devMenu');
                    if (menu) {
                        menu.classList.remove('hidden');
                        lucide.createIcons();
                    }
                } catch (e) { console.error("DevMenu Error", e); }
                devTapCount = 0;
            } else {
                devTapTimer = setTimeout(() => { devTapCount = 0; }, 600);
            }
        }
        window.handleDevTrigger = handleDevTrigger;

        function forceEffect(code, isDay, heavyOverride = false, birdsOverride = false) {
            // Special handling for birds override
            if (birdsOverride) {
                // Force clear day weather for birds
                renderSplashEffects(0, 1);
            } else {
                renderSplashEffects(code, isDay);
            }

            updateSunVisualsDev(isDay);
            const info = getWeatherInfo(code);
            document.getElementById('weatherDesc').innerHTML = `<span class="text-red-400 font-mono">[DEV] ${birdsOverride ? 'Vögel (Klar)' : info.t}</span>`;
            document.getElementById('weatherIconContainer').innerHTML = `<i data-lucide="${info.i}" class="w-12 h-12 text-red-300"></i>`;
            document.getElementById('devMenu').classList.add('hidden');
            lucide.createIcons();

            if (heavyOverride) {
                const con = document.getElementById('splashEffects');
                con.innerHTML += `<div class="cloud-shape" style="top:-5%; left:20%; width:110vw; height:40vh; animation-duration:32s; opacity:0.4;"></div>`;
                con.innerHTML += `<div class="cloud-shape" style="bottom:35%; left:-20%; width:110vw; height:45vh; animation-duration:38s; opacity:0.3;"></div>`;
            }
        }

        function updateSunVisualsDev(isDay) {
            const suns = document.querySelectorAll('.sun-orb');
            suns.forEach(s => s.remove());
            if (isDay === 1) {
                const con = document.getElementById('splashEffects');
                const div = document.createElement('div');
                div.className = 'sun-orb';
                div.style.left = '50%'; div.style.top = '20%';
                con.appendChild(div);
            }
        }

        function resetEffects() {
            if (lastWeatherData) { updateUI(null, true); }
            document.getElementById('devMenu').classList.add('hidden');
        }

        let layoutConfig = { order: ['bestRideSection', 'statusSection', 'rainChartSection', 'radarSection', 'forecast7DaySection', 'timelineSection'], visibility: { bestRideSection: true, statusSection: true, rainChartSection: true, radarSection: true, timelineSection: true, sub_weather: true, sub_moto: true, forecast7DaySection: true } };
        try {
            const s = localStorage.getItem('motoLayoutConfig_v5');
            if (s) {
                const p = JSON.parse(s);
                // Migrate older configs
                if (!p.order.includes('bestRideSection')) p.order.unshift('bestRideSection');
                if (!p.order.includes('rainChartSection')) p.order.splice(1, 0, 'rainChartSection');
                if (!p.order.includes('forecast7DaySection')) p.order.push('forecast7DaySection');

                layoutConfig = { ...layoutConfig, ...p, visibility: { ...layoutConfig.visibility, ...p.visibility } };
                // Ensure new defaults are visible if undefined
                if (layoutConfig.visibility.bestRideSection === undefined) layoutConfig.visibility.bestRideSection = true;
                layoutConfig.visibility.rainChartSection = layoutConfig.visibility.rainChartSection !== false;
                layoutConfig.visibility.forecast7DaySection = layoutConfig.visibility.forecast7DaySection !== false;
            }
        } catch (e) { }

        const cityInput = document.getElementById('cityInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const warningContainer = document.getElementById('warningContainer');
        const offlineBanner = document.getElementById('offlineBanner');
        const splash = document.getElementById('splashScreen');

        function dismissSplash() { splash.classList.add('splash-hidden'); document.body.style.overflow = 'auto'; }

        // NEU: Funktion um Splash Screen wieder anzuzeigen
        function showSplash() {
            splash.classList.remove('splash-hidden');
            document.body.style.overflow = 'hidden';
        }

        function initSplash() { const hour = new Date().getHours(); const isDay = (hour >= 6 && hour < 20) ? 1 : 0; renderSplashEffects(0, isDay); }
        initSplash();

        function applyLayout() {
            const con = document.getElementById('dynamicContent');
            const els = { bestRideSection: document.getElementById('bestRideSection'), statusSection: document.getElementById('statusSection'), rainChartSection: document.getElementById('rainChartSection'), radarSection: document.getElementById('radarSection'), timelineSection: document.getElementById('timelineSection'), forecast7DaySection: document.getElementById('forecast7DaySection') };
            layoutConfig.order.forEach(id => { if (els[id]) { con.appendChild(els[id]); els[id].classList.toggle('hidden', !layoutConfig.visibility[id]); } });
            const wc = document.getElementById('card-weather'), mc = document.getElementById('card-moto');
            wc.classList.toggle('hidden', !layoutConfig.visibility.sub_weather); mc.classList.toggle('hidden', !layoutConfig.visibility.sub_moto);
            wc.classList.remove('col-span-2'); mc.classList.remove('col-span-2');
            if (layoutConfig.visibility.sub_weather && !layoutConfig.visibility.sub_moto) wc.classList.add('col-span-2');
            if (!layoutConfig.visibility.sub_weather && layoutConfig.visibility.sub_moto) mc.classList.add('col-span-2');
            lucide.createIcons();
            setTimeout(() => { if (radarMap) radarMap.invalidateSize(); }, 200);
        }
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            if (m.classList.contains('hidden')) {
                // Opening - Animate
                m.classList.remove('hidden');
                renderSettingsList();
                renderMotoSettingsUI();
                showModal('settingsModal');
            } else {
                // Closing
                hideModal('settingsModal');
            }
        }
        function renderSettingsList() {
            // Render App Layout Settings
            const l = document.getElementById('layoutList'); l.innerHTML = '';
            const n = { bestRideSection: 'Best Ride (Top)', statusSection: 'Übersicht', rainChartSection: 'Niederschlag (1h)', radarSection: 'Radar (Live)', timelineSection: 'Vorhersage', forecast7DaySection: '7-Tage Trend' };
            layoutConfig.order.forEach((id, i) => {
                l.innerHTML += `<div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700"><div class="flex items-center gap-3"><span class="text-slate-400 font-mono text-xs">${i + 1}</span><span class="font-bold text-white">${n[id]}</span></div><div class="flex items-center gap-2"><button onclick="moveItem('${id}',-1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-up" size="16"></i></button><button onclick="moveItem('${id}',1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-down" size="16"></i></button><div class="w-px h-4 bg-slate-600 mx-1"></div><button onclick="toggleVisibility('${id}')" class="${layoutConfig.visibility[id] ? 'text-green-400' : 'text-slate-500'} p-1 hover:bg-slate-700 rounded"><i data-lucide="${layoutConfig.visibility[id] ? 'eye' : 'eye-off'}" size="18"></i></button></div></div>`;
            });
            document.getElementById('vis-weather-btn').className = layoutConfig.visibility.sub_weather ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-weather-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_weather ? 'eye' : 'eye-off'}" size="18"></i>`;
            document.getElementById('vis-moto-btn').className = layoutConfig.visibility.sub_moto ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-moto-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_moto ? 'eye' : 'eye-off'}" size="18"></i>`;

            // Render Moto Grid Settings
            const gl = document.getElementById('gridConfigList'); gl.innerHTML = '';
            motoGridConfig.forEach((id, i) => {
                const def = metricDefinitions[id];
                if (def) {
                    gl.innerHTML += `<div class="flex items-center justify-between bg-slate-900/50 p-2 rounded-lg border border-slate-700/50"><div class="text-xs text-white font-bold">${def.label}</div><div class="flex gap-1"><button onclick="moveGridItem('${id}', -1)" class="p-1 hover:bg-slate-700 rounded text-slate-400"><i data-lucide="arrow-up" size="14"></i></button><button onclick="moveGridItem('${id}', 1)" class="p-1 hover:bg-slate-700 rounded text-slate-400"><i data-lucide="arrow-down" size="14"></i></button><button onclick="toggleGridItem('${id}')" class="ml-2 p-1 bg-red-900/30 hover:bg-red-900/50 text-red-400 rounded"><i data-lucide="x" size="14"></i></button></div></div>`;
                }
            });

            const ga = document.getElementById('gridAvailableList'); ga.innerHTML = '';
            Object.values(metricDefinitions).forEach(def => {
                if (!motoGridConfig.includes(def.id)) {
                    ga.innerHTML += `<div class="flex items-center justify-between p-2 hover:bg-slate-700/30 rounded-lg cursor-pointer group" onclick="toggleGridItem('${def.id}')"><span class="text-xs text-slate-400 group-hover:text-white">${def.label}</span><i data-lucide="plus" size="14" class="text-green-500"></i></div>`;
                }
            });

            lucide.createIcons();
        }
        function moveItem(id, d) { const i = layoutConfig.order.indexOf(id); if (i < 0 || i + d < 0 || i + d >= layoutConfig.order.length) return;[layoutConfig.order[i], layoutConfig.order[i + d]] = [layoutConfig.order[i + d], layoutConfig.order[i]]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleVisibility(id) { layoutConfig.visibility[id] = !layoutConfig.visibility[id]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleSubVisibility(k) { layoutConfig.visibility['sub_' + k] = !layoutConfig.visibility['sub_' + k]; saveLayout(); renderSettingsList(); applyLayout(); }
        function resetLayout() { localStorage.removeItem('motoLayoutConfig_v5'); localStorage.removeItem('motoProfile_v1'); localStorage.removeItem('motoGridConfig_v1'); location.reload(); }
        function saveLayout() { localStorage.setItem('motoLayoutConfig_v5', JSON.stringify(layoutConfig)); }

        function initCompass() {
            // Handle both standard and absolute orientation events
            if (window.DeviceOrientationEvent) {
                // Check if absolute orientation is supported (Modern Android/Chrome)
                if ('ondeviceorientationabsolute' in window) {
                    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
                } else if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    // iOS Permission
                    DeviceOrientationEvent.requestPermission().then(r => {
                        if (r === 'granted') window.addEventListener('deviceorientation', handleOrientation, true);
                    }).catch(console.error);
                } else {
                    // Standard fallback
                    window.addEventListener('deviceorientation', handleOrientation, true);
                }
            }
        }

        function handleOrientation(e) {
            let heading = 0;

            if (e.webkitCompassHeading) {
                // iOS
                heading = e.webkitCompassHeading;
            } else if (e.alpha !== null) {
                // Android (try to use absolute if available)
                if (e.absolute) {
                    heading = 360 - e.alpha;
                } else {
                    // Fallback for relative alpha
                    heading = 360 - e.alpha;
                }
            }

            currentHeading = heading;

            // --- PARALLAX REMOVED ---

            if (!compassTicking) {
                window.requestAnimationFrame(updateWindArrow);
                compassTicking = true;
            }
        }

        // --- NEW ISOLATED MOTION HANDLER FOR SPEED SIMULATION + G-FORCE + RACE TIMER ---
        function handleMotion(event) {
            if (!event.acceleration) return;

            const now = Date.now();
            if (lastAccelTime === 0) {
                lastAccelTime = now;
                return;
            }

            const dt = (now - lastAccelTime) / 1000; // Seconds
            lastAccelTime = now;

            // 1. G-FORCE LOGIC
            // Y-axis is forward/backward in portrait.
            // Accel (Speeding up) = +Y, Braking = -Y.
            const ay = event.acceleration.y || 0;
            const g = (ay / 9.81); // Convert m/s^2 to G

            const gForceBar = document.getElementById('gForceBar');
            const gForceVal = document.getElementById('gForceVal');

            if (gForceBar && gForceVal) {
                // Limit visualization to +/- 1.5G
                let pct = (Math.abs(g) / 1.5) * 50;
                if (pct > 50) pct = 50;

                if (g > 0.05) {
                    // Acceleration (Right side, Green)
                    gForceBar.style.left = '50%';
                    gForceBar.style.width = pct + '%';
                    gForceBar.className = 'absolute top-0 bottom-0 bg-emerald-500 transition-all duration-75 ease-out';
                } else if (g < -0.05) {
                    // Braking (Left side, Red)
                    gForceBar.style.left = (50 - pct) + '%';
                    gForceBar.style.width = pct + '%';
                    gForceBar.className = 'absolute top-0 bottom-0 bg-red-500 transition-all duration-75 ease-out';
                } else {
                    gForceBar.style.width = '0%';
                }
                gForceVal.innerText = g.toFixed(2) + ' G';

                // Track Max G
                if (Math.abs(g) > sessionMaxG) sessionMaxG = Math.abs(g);
            }


            // 2. SPEED SIMULATION REMOVED (User Request: Pure GPS Speed)
            // if (Math.abs(ay) > 0.3) ... REMOVED

            // Just update G-Force display here
            // Speed is handled ONLY in handleGPSPosition
        }

        // DUPLICATE REMOVED


        function updateWindArrow() {
            compassTicking = false;
            if (!lastWeatherData?.current?.wind_direction_10m) return;

            const windDir = lastWeatherData.current.wind_direction_10m;

            // --- ÄNDERUNG: Wehrichtung (Wohin der Wind weht) ---
            // WindDir (API) = Woher er kommt (0 = Nord).
            // Wehrichtung = WindDir + 180.
            // Ziel-Rotation = (WindDir + 180) - Handy-Ausrichtung (Heading)
            const targetRotation = (windDir + 180) - currentHeading;

            // Normalize delta
            let delta = targetRotation - currentRotation;
            while (delta > 180) delta -= 360;
            while (delta < -180) delta += 360;
            currentRotation += delta;

            const a = document.getElementById('windDirArrow');
            if (a) {
                a.style.transform = `rotate(${currentRotation}deg)`;
            }

            // Update Text Direction (Zeige Zielrichtung an)
            const sectors = ['N', 'NO', 'O', 'SO', 'S', 'SW', 'W', 'NW'];
            // Berechne Index basierend auf Zielrichtung (WindDir + 180)
            const targetDir = (windDir + 180) % 360;
            const idx = Math.round(targetDir / 45) % 8;
            const txt = document.getElementById('windDirText');
            if (txt) txt.innerText = `Nach ${sectors[idx]}`;
        }

        function saveToCache(n, d) { try { localStorage.setItem('motoWeather_cache_v3_8', JSON.stringify({ name: n, data: d, timestamp: Date.now() })); } catch (e) { } }
        function loadFromCache() { try { return JSON.parse(localStorage.getItem('motoWeather_cache_v3_8')); } catch (e) { return null; } }

        // Benachrichtigungs-Funktionen ENTFERNT (enableNotifications, checkAndSendNotification)

        function checkWarnings(c) {
            let w = null, col = "bg-yellow-500/80 border-yellow-400", ic = "alert-triangle";
            if (c.weather_code >= 95) { w = "GEWITTER"; col = "bg-red-600/90 border-red-400"; ic = "cloud-lightning" } else if (c.wind_speed_10m >= 75) { w = "STURM"; col = "bg-red-600/90 border-red-400"; ic = "wind" } else if (c.wind_speed_10m >= 50) { w = "Windböen"; col = "bg-orange-500/80 border-orange-400"; ic = "wind" } else if (c.temperature_2m <= 3) { w = "Glätte"; col = "bg-blue-600/80 border-blue-400"; ic = "snowflake" } else if (c.precipitation >= 5) { w = "Starkregen"; col = "bg-blue-700/80 border-blue-400"; ic = "cloud-rain" } if (c.visibility < 1000) { w = "Nebel"; col = "bg-gray-600/90 border-gray-400"; ic = "cloud-fog" }
            if (w) { warningContainer.innerHTML = `<div onclick="showMotoDetails()" class="w-full ${col} border p-3 rounded-xl flex items-center justify-between shadow-lg animate-pulse-slow mb-4 text-white cursor-pointer"><div class="flex items-center gap-3 font-bold"><i data-lucide="${ic}" size="24"></i><span>${w}</span></div><i data-lucide="alert-circle" size="20"></i></div>`; warningContainer.classList.remove('hidden'); } else warningContainer.classList.add('hidden'); lucide.createIcons();
        }

        function toggleLegend() { document.getElementById('legendModal').classList.toggle('hidden'); lucide.createIcons(); }
        function closeHourlyModal() { document.getElementById('hourlyDetailsModal').classList.add('hidden'); }

        async function showDailyDetails(index = 0) {
            try {
                if (!lastWeatherData) return;
                const d = lastWeatherData.daily;
                const c = lastWeatherData.current;
                if (!d || !d.time || !d.time[index]) return;

                const date = new Date(d.time[index]);
                const dayName = index === 0 ? "Heute" : date.toLocaleDateString('de-DE', { weekday: 'long' });
                const dateStr = date.toLocaleDateString('de-DE', { day: 'numeric', month: 'long' });

                safeSetText('dailyDetailTitle', dayName);
                safeSetText('dailyDetailDate', dateStr);

                if (d.sunrise && d.sunrise[index]) safeSetText('detailSunrise', new Date(d.sunrise[index]).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }));
                if (d.sunset && d.sunset[index]) safeSetText('detailSunset', new Date(d.sunset[index]).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }));

                const precipSum = (d.precipitation_sum && d.precipitation_sum[index] !== undefined) ? d.precipitation_sum[index] : 0;
                const precipProb = (d.precipitation_probability_max && d.precipitation_probability_max[index] !== undefined) ? d.precipitation_probability_max[index] : 0;

                safeSetText('detailPrecipSum', precipSum.toFixed(1));
                safeSetText('detailPrecipProb', precipProb);
                const probBar = document.getElementById('detailPrecipProbBar');
                if (probBar) probBar.style.width = precipProb + '%';

                const windMax = (d.wind_speed_10m_max && d.wind_speed_10m_max[index] !== undefined) ? d.wind_speed_10m_max[index] : '--';
                safeSetText('detailWindMax', windMax);
                const uvVal = (d.uv_index_max && d.uv_index_max[index] !== undefined) ? d.uv_index_max[index] : '--';
                safeSetText('detailUVMax', uvVal);

                const extras = document.getElementById('currentDayExtras');
                if (index === 0) {
                    safeSetText('detailVisibility', (c.visibility && c.visibility > 9999) ? ">10 km" : ((c.visibility / 1000).toFixed(1) + " km"));
                    safeSetText('detailUV', c.uv_index || "--");
                    if (extras) extras.classList.remove('hidden');
                    if (d.sunset && d.sunset[0]) {
                        const diff = new Date(d.sunset[0]) - new Date();
                        const cd = document.getElementById('sunCountdownText');
                        if (cd) {
                            if (diff > 0) cd.innerText = `Noch ${Math.floor(diff / 36e5)}h ${Math.floor((diff % 36e5) / 6e4)}m Licht`;
                            else cd.innerText = "Dunkelheit";
                        }
                    }
                    try {
                        const r = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${currentLat}&longitude=${currentLon}&current=european_aqi,pm10,pm2_5`);
                        const ad = await r.json(); const v = ad.current.european_aqi;
                        safeSetText('detailAqiVal', v);
                        let cl = "bg-green-500"; if (v > 40) cl = "bg-yellow-400"; if (v > 60) cl = "bg-orange-500"; if (v > 80) cl = "bg-red-600";
                        const aqiBar = document.getElementById('detailAqiBar'); if (aqiBar) aqiBar.className = `w-2 h-2 rounded-full ${cl}`;
                    } catch (e) { }
                } else {
                    if (extras) extras.classList.add('hidden');
                }

                // --- NEU: Hourly Rain Render ---
                const rainCon = document.getElementById('dailyHourlyRain');
                if (rainCon) {
                    rainCon.innerHTML = '<div class="text-xs font-bold text-slate-400 mb-2 sticky top-0 bg-slate-900/90 py-1 backdrop-blur-sm">Regen-Verlauf</div>';
                    const h = lastWeatherData.hourly;
                    // Find start index for this day
                    const dateMatch = date.toISOString().slice(0, 10);

                    let hasRainEntries = false;
                    for (let k = 0; k < h.time.length; k++) {
                        if (h.time[k].startsWith(dateMatch)) {
                            const prec = h.precipitation[k];
                            // Show even small amounts or if it's "wet" code, but main focus on >0
                            if (prec > 0) {
                                hasRainEntries = true;
                                const timeObj = new Date(h.time[k]);
                                const timeStr = timeObj.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                const barW = Math.min(100, prec * 30); // scale: 3mm approx full bar
                                let barCol = "bg-blue-500";
                                if (prec > 2) barCol = "bg-purple-500";
                                else if (prec < 0.5) barCol = "bg-blue-300";

                                rainCon.innerHTML += `
                                <div class="flex items-center justify-between mb-1.5 p-2 bg-slate-800/40 rounded-lg">
                                    <span class="text-xs text-slate-300 font-mono w-10">${timeStr}</span>
                                    <div class="flex-grow mx-3 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                        <div class="${barCol} h-full" style="width: ${barW}%"></div>
                                    </div>
                                    <span class="text-xs font-bold text-blue-100 w-10 text-right">${prec.toFixed(1)}</span>
                                </div>`;
                            }
                        }
                    }
                    if (!hasRainEntries) {
                        rainCon.innerHTML += `<div class="text-xs text-slate-500 italic text-center py-4">Kein Regen für diesen Tag vorhergesagt.</div>`;
                    }
                }

                const score = calculateMotoScore(
                    d.temperature_2m_max[index] || 15,
                    d.wind_speed_10m_max ? d.wind_speed_10m_max[index] : 10,
                    precipSum,
                    1,
                    d.weather_code[index] || 0
                );
                const col = getScoreColor(score.score);
                const scoreEl = document.getElementById('dailyMotoScore');
                if (scoreEl) scoreEl.className = `mt-4 p-3 rounded-xl border border-slate-600/50 flex justify-between items-center bg-slate-800 ${col.bg} bg-opacity-20`;
                safeSetText('dailyScoreDetailVal', score.score + "/10");

                // renderSplashEffects(d.weather_code[index], 1); // REMOVED: Keep current weather background

                showModal('dailyDetailsModal');
                lucide.createIcons();
            } catch (e) {
                console.error("Detail Error", e);
                showModal('dailyDetailsModal');
            }
        }

        // --- CHANGELOG SYSTEM ---
        // --- CHANGELOG SYSTEM ---
        const CURRENT_APP_VERSION = "1.2.7";

        // Manual Open
        function showChangelog() {
            const m = document.getElementById('changelogModal');
            if (m) {
                m.classList.remove('hidden');
                lucide.createIcons();
            }
        }

        function checkChangelog() {
            // DISABLED AUTO-SHOW per User Request
            /*
             const lastVer = localStorage.getItem('lastRunVersion_v1');
             if(lastVer !== CURRENT_APP_VERSION) {
                  showChangelog();
                  localStorage.setItem('lastRunVersion_v1', CURRENT_APP_VERSION);
             }
             */
            // Still update version silently so we track it? No, irrelevant if we don't show it.
        }

        function closeChangelog() {
            const m = document.getElementById('changelogModal');
            if (m) {
                m.classList.add('hidden');
                // Safety: Ensure splash is gone
                const s = document.getElementById('splashScreen');
                if (s) s.classList.add('splash-hidden');
            }
        }

        // Call init
        // checkChangelog(); // DISABLED

        // Gear Guide Removed
        function showMotoDetails() {
            if (!lastWeatherData) return;
            const c = lastWeatherData.current;
            const ana = calculateMotoAnalysis(c.temperature_2m, c.wind_speed_10m, c.precipitation, c.is_day, c.weather_code);
            const l = document.getElementById('motoAnalysisList');
            l.innerHTML = "";
            ana.pros.forEach(p => l.innerHTML += `<div class="flex items-center gap-3 p-2 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><i data-lucide="check-circle" class="text-emerald-400 flex-shrink-0" size="16"></i><span class="text-xs text-emerald-100">${p}</span></div>`);
            ana.cons.forEach(x => l.innerHTML += `<div class="flex items-center gap-3 p-2 bg-red-500/10 border border-red-500/30 rounded-xl"><i data-lucide="alert-triangle" class="text-red-400 flex-shrink-0" size="16"></i><span class="text-xs text-red-100">${x}</span></div>`);
            if (!ana.pros.length && !ana.cons.length) l.innerHTML = `<div class="text-center text-slate-400 text-xs italic">Alles normal.</div>`;
            showModal('motoDetailsModal');
            lucide.createIcons();
        }
        function calculateMotoAnalysis(t, w, r, d, c) { let p = [], n = []; if (t >= 15 && t <= 28) p.push("Top Temp"); else if (t < 5) n.push("Glätte (<5°)"); else if (t < 10) n.push("Kalt (<10°)"); else if (t > 30) n.push("Hitze (>30°)"); if (w < 15) p.push("Wenig Wind"); else if (w > 40) n.push("Böen (>40kmh)"); if (r > 0) n.push("Nass"); if (c < 3) p.push("Gute Sicht"); if (d === 0) n.push("Nacht"); else p.push("Tag"); return { pros: p, cons: n }; }

        function calculateMotoScore(t, w, r, d, c) {
            let s = 10, rs = "Top";



            // Temperature
            if (t < 0) { s -= 10; rs = "Eis"; }
            else if (t < 5) { s -= 8; rs = "Arschkalt"; }
            else if (t < motoProfile.minTemp) {
                let pen = 5;

                s -= pen; rs = "Zu Kalt";
            }
            else if (t > 35) { s -= 4; rs = "Hitze"; }

            // Weather Code
            if (c >= 95) { s -= 10; rs = "Gewitter"; }
            else if (c >= 66 || c == 71 || c == 73 || c == 75) { s -= 9; rs = "Schnee"; }
            else if (c >= 61) { s -= 7; rs = "Regen"; }
            else if (c >= 51) {
                let pen = 4;

                s -= pen; rs = "Niesel";
            }

            // Rain Amount
            if (r > 0.5) {
                if (!motoProfile.rainTolerance) {
                    s -= 5; rs = "Nass";
                }
            }

            // Wind
            if (w > 60) { s -= 9; rs = "Sturm"; }
            else if (w > motoProfile.maxWind) {
                s -= 5; rs = "Windig";
            }

            if (d === 0) { s -= 2; if (rs === "Top") rs = "Nacht" }

            return { score: Math.max(0, Math.min(10, s)), reason: rs };
        }
        function calculateDailyScore(h) { const off = (lastWeatherData.utc_offset_seconds || 0) * 1000; let ts = 0, c = 0; for (let i = 0; i < h.time.length; i++) { if (new Date(new Date(h.time[i]).getTime() + off).toISOString().slice(0, 10) !== new Date(Date.now() + off).toISOString().slice(0, 10)) continue; if (h.is_day[i]) { ts += calculateMotoScore(h.temperature_2m[i], h.wind_speed_10m[i], h.precipitation[i], h.is_day[i], h.weather_code[i]).score; c++; } } return c === 0 ? "--" : Math.round((ts / c) * 10) / 10; }
        function getScoreColor(s) { if (s >= 8) return { bg: "border-emerald-500 text-emerald-400", hex: "#10b981" }; if (s >= 5) return { bg: "border-yellow-500 text-yellow-400", hex: "#eab308" }; if (s >= 3) return { bg: "border-orange-500 text-orange-400", hex: "#f97316" }; return { bg: "border-red-500 text-red-400", hex: "#ef4444" }; }

        function updateMainValues(t, app_t, w, h, r, c, d, txt, idx = 0) {
            try {
                if (!lastWeatherData || !lastWeatherData.current) return;
                const cur = lastWeatherData.current; // Safe access to full data

                // 1. Update Theme Dynamically
                updateDynamicTheme(c, d);

                // 2. Render Hero Values
                document.getElementById('temperature').innerText = Math.round(t);
                safeSetText('feelsLike', Math.round(app_t));
                safeSetText('tempMin', Math.round(lastWeatherData.daily.temperature_2m_min[0])); // Add Max/Min logic if needed in args, but fetch from daily[0] is safe for "Current" view
                safeSetText('tempMax', Math.round(lastWeatherData.daily.temperature_2m_max[0]));

                document.getElementById('windSpeed').innerText = w;
                document.getElementById('humidity').innerText = h;

                const i = getWeatherInfo(c);
                document.getElementById('weatherDesc').innerText = i.t;
                document.getElementById('weatherIconContainer').innerHTML = `<i data-lucide="${i.i}" size="32"></i>`;

                // 3. Render Moto Score SVG Gauge
                const sc = calculateMotoScore(t, w, r, d, c);
                // const col = getScoreColor(sc.score); // Not needed for SVG Gradient, but maybe for text?

                // SVG Animation
                const circle = document.getElementById('motoScoreGauge');
                if (circle) {
                    const radius = 40;
                    const circumference = 2 * Math.PI * radius;
                    const offset = circumference - ((sc.score / 10) * circumference);
                    circle.style.strokeDasharray = `${circumference} ${circumference}`;
                    circle.style.strokeDashoffset = offset;
                }

                document.getElementById('motoScoreValue').innerText = sc.score;
                document.getElementById('motoScoreText').innerText = sc.reason;

                // --- RENDER DYNAMIC MOTO GRID ---
                const gridContainer = document.getElementById('motoDynamicGrid');
                if (gridContainer) {
                    gridContainer.innerHTML = '';
                    motoGridConfig.slice(0, 6).forEach(metricId => {
                        const def = metricDefinitions[metricId];
                        if (!def) return;

                        let valTxt = "--";
                        let valCls = "text-slate-200";

                        // Calculation Logic for each metric
                        if (metricId === 'grip') {
                            valTxt = "Trocken"; valCls = "text-emerald-400";

                            // 1. Check active wet conditions
                            const isActiveRain = (r > 0.1 || [51, 53, 55, 56, 57, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(c));

                            if (t <= 4) {
                                valTxt = "Eisig!"; valCls = "text-red-400 animate-pulse";
                            } else if (isActiveRain) {
                                valTxt = "Nass"; valCls = "text-blue-400 font-bold"; // Changed color to blue for wet
                            } else {
                                // 2. Check "Drying" Phase (History Check)
                                // If it rained in last 4 hours, and conditions are poor (cold/humid/night), it's "Feucht" or "Nass"
                                let wasWetRecently = false;
                                if (lastWeatherData && lastWeatherData.hourly && lastWeatherData.hourly.precipitation) {
                                    const h = lastWeatherData.hourly;
                                    const nowHr = new Date().getHours();
                                    const todayStr = new Date().toISOString().slice(0, 10);

                                    // Look back up to 4 hours (within same day for simplicity with index)
                                    // Find current hour index
                                    let currentIdx = -1;
                                    for (let k = 0; k < h.time.length; k++) {
                                        const ht = new Date(h.time[k]);
                                        if (ht.getHours() === nowHr && h.time[k].startsWith(todayStr)) {
                                            currentIdx = k; break;
                                        }
                                    }

                                    if (currentIdx > 0) {
                                        for (let back = 1; back <= 4; back++) {
                                            const idx = currentIdx - back;
                                            if (idx >= 0) {
                                                if (h.precipitation[idx] > 0.2) { wasWetRecently = true; break; }
                                            }
                                        }
                                    }
                                }

                                if (wasWetRecently) {
                                    // Drying Logic
                                    // Good drying: Temp > 15, Sun, Wind > 10, Hum < 70
                                    let dryingScore = 0;
                                    if (t > 15) dryingScore++;
                                    if (t > 22) dryingScore++;
                                    if (d === 1) dryingScore++; // Day or Night
                                    if (cur.relative_humidity_2m < 70) dryingScore++;
                                    if (w > 15) dryingScore++;

                                    // If score low, it stays wet/damp
                                    if (dryingScore < 3) {
                                        valTxt = "Feucht";
                                        valCls = "text-orange-400"; // Warn color
                                    }
                                }
                            }
                        }
                        else if (metricId === 'gear') {
                            valTxt = "Standard"; valCls = "text-blue-200";
                            if (t > 26) valTxt = "Mesh/Air";
                            else if (t < 10) valTxt = "Thermo";
                            else if (t < 18) valTxt = "Leder+";
                            else if (r > 0.5) valTxt = "Regen";
                        }
                        else if (metricId === 'vis') {
                            const v = cur.visibility;
                            if (v !== undefined) {
                                if (v >= 10000) { valTxt = ">10 km"; valCls = "text-emerald-400"; }
                                else if (v >= 5000) { valTxt = (v / 1000).toFixed(1) + " km"; valCls = "text-blue-200"; }
                                else { valTxt = (v < 1000 ? v + " m" : (v / 1000).toFixed(1) + " km"); valCls = "text-red-400 font-black"; }
                            }
                        }
                        else if (metricId === 'rain') { // Next Rain
                            valTxt = "Keiner"; valCls = "text-emerald-400";
                            if (r > 0) {
                                valTxt = "Jetzt!"; valCls = "text-red-400 animate-pulse";
                            } else if (lastWeatherData.hourly && lastWeatherData.hourly.precipitation) {
                                const h = lastWeatherData.hourly;
                                const now = Date.now();
                                for (let j = 0; j < h.time.length; j++) {
                                    const tTime = new Date(h.time[j]).getTime();
                                    if (tTime > now && h.precipitation[j] > 0.1) {
                                        const diffHours = (tTime - now) / (1000 * 60 * 60);
                                        if (diffHours > 24) {
                                            valTxt = ">1T";
                                        } else {
                                            valTxt = (diffHours < 1) ? "Gleich" : Math.round(diffHours) + " Std";
                                        }
                                        valCls = "text-blue-300";
                                        break;
                                    }
                                }
                            }
                        }
                        else if (metricId === 'sun') {
                            if (lastWeatherData.daily && lastWeatherData.daily.sunset && lastWeatherData.daily.sunset[0]) {
                                valTxt = new Date(lastWeatherData.daily.sunset[0]).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                                valCls = "text-orange-300";
                            }
                        }
                        else if (metricId === 'wind') { // Gusts
                            const g = cur.wind_gusts_10m;
                            if (g !== undefined) {
                                valTxt = Math.round(g) + " km/h";
                                if (g >= 60) valCls = "text-red-400 animate-pulse";
                                else if (g >= 40) valCls = "text-orange-400";
                                else valCls = "text-emerald-400";
                            }
                        }
                        else if (metricId === 'uv') {
                            const u = cur.uv_index;
                            if (u !== undefined) {
                                valTxt = u.toFixed(1);
                                if (u >= 6) valCls = "text-red-400";
                                else if (u >= 3) valCls = "text-yellow-400";
                                else valCls = "text-emerald-400";
                            }
                        }
                        else if (metricId === 'clouds') {
                            if (cur.cloud_cover !== undefined) valTxt = cur.cloud_cover + "%";
                        }
                        else if (metricId === 'hum') {
                            if (cur.relative_humidity_2m !== undefined) valTxt = cur.relative_humidity_2m + "%";
                        }
                        else if (metricId === 'press') {
                            if (cur.surface_pressure !== undefined) valTxt = Math.round(cur.surface_pressure) + " hPa";
                        }
                        // ENTFERNT: rise, avg_wind, feel, dew Logikblöcke

                        // Generate HTML
                        gridContainer.innerHTML += `
                        <div class="bg-slate-800/40 rounded-lg p-1.5 flex flex-col items-center border border-slate-700/30">
                            <span class="text-[9px] text-slate-500 uppercase tracking-wide truncate w-full text-center">${def.label}</span>
                            <span class="text-[10px] font-bold ${valCls}">${valTxt}</span>
                        </div>`;
                    });
                }
                // --------------------------

                document.getElementById('timeLabel').innerText = "Aktuell"; document.getElementById('timeLabel').classList.remove('opacity-0');
                if (lastWeatherData.daily && lastWeatherData.daily.temperature_2m_max[idx] !== undefined) { document.getElementById('tempMax').innerText = Math.round(lastWeatherData.daily.temperature_2m_max[idx]); document.getElementById('tempMin').innerText = Math.round(lastWeatherData.daily.temperature_2m_min[idx]); }
                updateWindArrow(); lucide.createIcons();
            } catch (e) { console.error("UpdateMain Error", e); }
        }

        function updateSunVisuals() {
            const suns = document.querySelectorAll('.sun-orb');
            if (!suns.length || !lastWeatherData || !lastWeatherData.daily) return;
            const now = Date.now();
            const sunrise = new Date(lastWeatherData.daily.sunrise[0]).getTime();
            const sunset = new Date(lastWeatherData.daily.sunset[0]).getTime();
            if (now < sunrise || now > sunset) return;
            const pct = (now - sunrise) / (sunset - sunrise);
            const leftVal = (pct * 120) - 10;
            const sinVal = Math.sin(pct * Math.PI);
            const topVal = 100 - (sinVal * 90);
            suns.forEach(sun => { sun.style.left = `${leftVal}%`; sun.style.top = `${topVal}%`; });
        }

        function triggerLightningLoop() {
            const layer = document.getElementById('lightningLayer');
            if (!layer) return;
            const nextStrike = Math.random() * 6000 + 2000;
            lightningTimeout = setTimeout(() => {
                layer.style.animation = 'none';
                layer.offsetHeight;
                layer.style.animation = 'lightning-flash 0.6s linear';
                triggerLightningLoop();
            }, nextStrike);
        }

        function renderSplashEffects(c, d) {
            const con = document.getElementById('splashEffects');
            const loc = document.getElementById('splashLocalEffects');
            clearTimeout(lightningTimeout);
            let h = '';
            const isRain = [51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(c);
            const isSnow = [71, 73, 75, 77, 85, 86].includes(c);
            const isFog = [45, 48].includes(c);
            const isStorm = [95, 96, 99].includes(c);
            const isCloudy = c > 0 || isRain || isSnow || isFog;
            const isHeavyCloud = c === 3 || isRain || isSnow || isFog;

            const isClear = (c === 0 || c === 1);

            // --- FEATURE 7: TRIGGER RAIN GLASS ---
            if (isRain || isStorm) rainGlass.start(); else rainGlass.stop();

            if (isStorm) { triggerLightningLoop(); }
            if (d === 1) {
                if (!isRain && !isSnow && !isFog) {
                    h += `<div class="sun-orb" style="top: 100%; left: 0%;"></div>`;
                }
                // BIRDS LOGIC: Show birds if clear weather and day
                if (isClear && !isRain && !isSnow && !isFog) {
                    // Gruppe 1: Links -> Rechts (Standard)
                    h += `<div class="bird-container" style="top: 15%; animation: fly-across 45s linear infinite; animation-delay: 0s;">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:10px; left: 20px; animation-delay: 0.1s;"></div>
                           <div class="bird" style="top:-5px; left: 40px; animation-delay: 0.2s;"></div>
                         </div>`;

                    // Gruppe 2: Links -> Rechts (Fern/Klein)
                    h += `<div class="bird-container" style="top: 30%; animation: fly-across 55s linear infinite; animation-delay: 20s; transform: scale(0.6);">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:15px; left: 15px;"></div>
                         </div>`;

                    // Gruppe 3: Rechts -> Links (Hoch/Schnell)
                    h += `<div class="bird-container" style="top: 10%; animation: fly-across-reverse 38s linear infinite; animation-delay: 5s;">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:8px; left: 15px; animation-delay: 0.1s;"></div>
                           <div class="bird" style="top:20px; left: -5px; animation-delay: 0.3s;"></div>
                           <div class="bird" style="top:12px; left: 30px; animation-delay: 0.2s;"></div>
                         </div>`;

                    // Gruppe 4: Rechts -> Links (Tief/Langsam)
                    h += `<div class="bird-container" style="top: 40%; animation: fly-across-reverse 60s linear infinite; animation-delay: 25s; transform: scale(0.8);">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:5px; left: 20px;"></div>
                         </div>`;
                }
            } else {
                for (let i = 0; i < 100; i++) { h += `<div class="star" style="top:${Math.random() * 60}%;left:${Math.random() * 100}%;width:${1 + Math.random() * 2}px;height:${1 + Math.random() * 2}px;animation-delay:${Math.random() * 2}s;opacity:${0.3 + Math.random() * 0.7}"></div>`; }
            }

            // WOLKEN (Mehr & Besser sichtbar)
            if (isCloudy && !isFog) {
                h += `<div class="cloud-shape" style="top:10%; left:-5%; width:100vw; height:35vh; animation-duration:22s; opacity:0.6;"></div>`;
                h += `<div class="cloud-shape" style="top:25%; right:-15%; width:90vw; height:30vh; animation-duration:28s; animation-direction:reverse; opacity:0.5;"></div>`;
                if (isHeavyCloud) {
                    h += `<div class="cloud-shape" style="top:-5%; left:20%; width:110vw; height:40vh; animation-duration:32s; opacity:0.4;"></div>`;
                    h += `<div class="cloud-shape" style="bottom:35%; left:-20%; width:110vw; height:45vh; animation-duration:38s; opacity:0.3;"></div>`;
                }
            }

            // NIEDERSCHLAG (Regen/Schnee/Nebel)
            if (isRain) {
                let count = 30; // Basis (Leicht)
                let speedBase = 0.8;
                if ([53, 63, 81].includes(c)) { count = 80; speedBase = 0.7; }
                if ([55, 65, 66, 67, 82, 95, 96, 99].includes(c)) { count = 150; speedBase = 0.6; }
                for (let i = 0; i < count; i++) {
                    const speed = speedBase + Math.random() * 0.5;
                    h += `<div class="rain-drop" style="left:${Math.random() * 100}%; animation-delay:${Math.random()}s; animation-duration:${speed}s"></div>`;
                }
            } else if (isSnow) {
                for (let i = 0; i < 30; i++) {
                    h += `<div class="snowflake" style="left:${Math.random() * 100}%; animation-delay:${Math.random() * 2}s; animation-duration:${3 + Math.random() * 2}s; opacity:${Math.random()}"></div>`;
                }
            } else if (isFog) {
                h += `<div class="fog-layer"></div>`;
            }

            if (con) con.innerHTML = h; if (loc) loc.innerHTML = h;
        }

        function renderRainChart(minutely15) {
            const container = document.getElementById('rainBarsContainer');
            if (!minutely15 || !minutely15.precipitation || minutely15.precipitation.length < 4) { container.innerHTML = '<div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">Keine Daten</div>'; return; }
            container.innerHTML = '';
            let startIndex = 0;
            const now = Date.now();
            if (minutely15.time) {
                for (let j = 0; j < minutely15.time.length; j++) {
                    if (new Date(minutely15.time[j]).getTime() >= now - 15 * 60 * 1000) {
                        startIndex = j; break;
                    }
                }
            }
            for (let i = 0; i < 4; i++) {
                const dataIndex = startIndex + i;
                if (dataIndex >= minutely15.precipitation.length) break;
                const val = minutely15.precipitation[dataIndex];
                const height = Math.min(100, (val / 2.0) * 100);
                const color = val > 1.0 ? "bg-blue-500" : "bg-blue-300/70";
                container.innerHTML += `<div class="w-1/4 h-full flex flex-col justify-end items-center gap-1"><div class="w-full rounded-t-md ${color} rain-bar" style="height: ${Math.max(5, height)}%"></div><span class="text-[9px] text-slate-400">${val > 0 ? val.toFixed(1) : '0'}</span></div>`;
            }
        }

        function render7Day() {
            const con = document.getElementById('forecast7List'); con.innerHTML = '';
            const d = lastWeatherData.daily; if (!d) return;
            for (let i = 0; i < d.time.length; i++) {
                const date = new Date(d.time[i]);
                const day = date.toLocaleDateString('de-DE', { weekday: 'long' });
                const code = d.weather_code[i];
                const min = Math.round(d.temperature_2m_min[i]);
                const max = Math.round(d.temperature_2m_max[i]);
                const info = getWeatherInfo(code);
                // ADDED: id="day-item-${i}" for specific transition trigger
                con.innerHTML += `<div id="day-item-${i}" onclick="showDailyDetails(${i})" class="flex items-center justify-between bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 cursor-pointer transition active:scale-95"><span class="w-24 font-bold text-sm">${i === 0 ? 'Heute' : day}</span><div class="flex items-center gap-2 text-blue-200"><i data-lucide="${info.i}" size="18"></i><span class="text-xs w-20 truncate">${info.t}</span></div><div class="flex gap-3 text-sm font-mono"><span class="text-blue-400">${min}°</span><span class="text-slate-500">/</span><span class="text-red-400">${max}°</span></div></div>`;
            }
            lucide.createIcons();
        }

        function initRadarMap() {
            const container = document.getElementById('radarMap');
            if (!container) return;
            if (radarMap) { radarMap.setView([currentLat, currentLon], 8); updateMarker(); return; }
            radarMap = L.map('radarMap', { zoomControl: false, attributionControl: true }).setView([currentLat, currentLon], 8);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO &copy; RainViewer', subdomains: 'abcd', maxZoom: 20 }).addTo(radarMap);
            updateMarker();
            fetchRadarData();
        }

        function updateMarker() {
            if (!radarMap) return;
            if (radarMarker) radarMap.removeLayer(radarMarker);
            const icon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#ef4444; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #ef4444;'></div>", iconSize: [12, 12], iconAnchor: [6, 6] });
            radarMarker = L.marker([currentLat, currentLon], { icon: icon }).addTo(radarMap);
        }

        async function fetchRadarData() {
            // NEW: Added Proxy Fallback mechanism to fix "Offline" issue
            const radarUrl = 'https://api.rainviewer.com/public/weather-maps.json';

            try {
                let data;
                try {
                    // Try direct fetch first
                    const response = await fetch(radarUrl);
                    if (!response.ok) throw new Error("Direct fetch failed");
                    data = await response.json();
                } catch (e) {
                    console.warn("Direct radar fetch failed, trying proxy...", e);
                    // Fallback to CORS proxy
                    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(radarUrl);
                    const response = await fetch(proxyUrl);
                    data = await response.json();
                }

                if (data && data.radar && data.radar.past) {
                    radarTimestamps = data.radar.past;
                    lastPastIndex = radarTimestamps.length - 1;

                    const nowIndex = lastPastIndex;
                    if (data.radar.nowcast) { radarTimestamps = radarTimestamps.concat(data.radar.nowcast); }

                    const timeline = document.getElementById('radarTimeline');
                    if (timeline) {
                        timeline.max = radarTimestamps.length - 1;
                        timeline.value = nowIndex;

                        const total = radarTimestamps.length;
                        const pct = (lastPastIndex / (total - 1)) * 100;
                        timeline.style.setProperty('--past-pct', pct + '%');
                    }

                    currentRadarIndex = nowIndex;
                    showRadarFrame(currentRadarIndex);
                    updatePlayButtonIcon();
                }
            } catch (e) {
                console.error("Radar fetch completely failed", e);
                document.getElementById('radarTimeLabel').innerText = "Offline";
            }
        }

        function startRadarAnimation() {
            if (radarAnimationInterval) clearInterval(radarAnimationInterval);
            isRadarPlaying = true;
            updatePlayButtonIcon();
            if (!radarAnimationInterval) {
                radarAnimationInterval = setInterval(() => {
                    currentRadarIndex = (currentRadarIndex + 1) % radarTimestamps.length;
                    showRadarFrame(currentRadarIndex);
                }, 800);
            }
        }

        function stopRadarAnimation() {
            if (radarAnimationInterval) { clearInterval(radarAnimationInterval); radarAnimationInterval = null; }
            isRadarPlaying = false;
            updatePlayButtonIcon();
        }

        function toggleRadarPlayback() { if (isRadarPlaying) { stopRadarAnimation(); } else { startRadarAnimation(); } }
        function updatePlayButtonIcon() { const btn = document.getElementById('radarPlayBtn'); if (btn) { btn.innerHTML = isRadarPlaying ? '<i data-lucide="pause" size="16"></i>' : '<i data-lucide="play" size="16"></i>'; lucide.createIcons(); } }
        function handleRadarScrub(val) { stopRadarAnimation(); currentRadarIndex = parseInt(val); showRadarFrame(currentRadarIndex); }

        function showRadarFrame(index) {
            if (!radarMap || !radarTimestamps[index]) return;
            const tsObj = radarTimestamps[index];
            const time = new Date(tsObj.time * 1000);
            const hours = time.getHours().toString().padStart(2, '0');
            const minutes = time.getMinutes().toString().padStart(2, '0');
            document.getElementById('radarTimeLabel').innerText = `${hours}:${minutes}`;

            // UI: Handle Future vs Live
            const isFuture = index > lastPastIndex;
            const liveDot = document.getElementById('radarLiveDot');
            const statusText = document.getElementById('radarStatusText');

            if (liveDot && statusText) {
                if (isFuture) {
                    liveDot.className = "live-dot dot-forecast";
                    statusText.innerText = "Prognose";
                    statusText.className = "text-[10px] text-purple-400 mr-2 uppercase tracking-wider font-bold transition-colors duration-300";
                } else {
                    liveDot.className = "live-dot dot-live";
                    statusText.innerText = "Live";
                    statusText.className = "text-[10px] text-slate-400 mr-2 uppercase tracking-wider font-bold transition-colors duration-300";
                }
            }

            const timeline = document.getElementById('radarTimeline');
            if (timeline && isRadarPlaying) { timeline.value = index; }

            const layerUrl = `https://tilecache.rainviewer.com${tsObj.path}/256/{z}/{x}/{y}/2/1_1.png`;
            const newLayer = L.tileLayer(layerUrl, { opacity: 0.7, zIndex: 100 });
            newLayer.addTo(radarMap);
            radarLayers[tsObj.time] = newLayer;
            Object.keys(radarLayers).forEach(key => { if (parseInt(key) !== tsObj.time) { if (radarMap.hasLayer(radarLayers[key])) { radarMap.removeLayer(radarLayers[key]); } delete radarLayers[key]; } });
        }

        function calculateBestRide(h) {
            // Look ahead 48h
            const now = new Date();
            const scores = [];

            // Time offset
            const off = (lastWeatherData.utc_offset_seconds || 0) * 1000;
            const currentTime = now.getTime() + off;

            let startIndex = -1;

            // Build score array for future hours
            for (let i = 0; i < h.time.length; i++) {
                const tTime = new Date(h.time[i]).getTime() + off;
                if (tTime >= currentTime) {
                    if (startIndex === -1) startIndex = i;
                    // Limit to next 48h (approx 48 indices)
                    if (i > startIndex + 48) break;

                    // FIX: STRICTLY EXCLUDE NIGHT
                    if (h.is_day[i] === 0) continue;

                    const sc = calculateMotoScore(h.temperature_2m[i], h.wind_speed_10m[i], h.precipitation[i], h.is_day[i], h.weather_code[i]);
                    scores.push({
                        index: i,
                        time: h.time[i],
                        score: sc.score,
                        reason: sc.reason
                    });
                }
            }

            if (scores.length < 3) return null;

            // Find best window (min 2 hours)
            let bestWindow = { start: 0, end: 0, avgScore: 0, length: 0 };

            // Try to find windows with score >= 8 (GREEN)
            let bestThreshold = 8;
            let found = findWindows(scores, bestThreshold);

            // If nothing great found, lower standard to >= 6 (YELLOW)
            if (!found) {
                bestThreshold = 6;
                found = findWindows(scores, bestThreshold);
            }

            // If still nothing, maybe just show "Next good status" or hide
            if (!found) return null;

            return found;
        }

        function findWindows(scores, threshold) {
            let currentWindow = [];
            let windows = [];

            for (let i = 0; i < scores.length; i++) {
                if (scores[i].score >= threshold) {
                    currentWindow.push(scores[i]);
                } else {
                    if (currentWindow.length >= 2) {
                        windows.push([...currentWindow]);
                    }
                    currentWindow = [];
                }
            }
            if (currentWindow.length >= 2) {
                windows.push([...currentWindow]);
            }

            if (windows.length === 0) return null;

            // Pick longest window, tie-break with avg score
            windows.sort((a, b) => {
                const lenDiff = b.length - a.length;
                if (lenDiff !== 0) return lenDiff;
                const avgA = a.reduce((sum, x) => sum + x.score, 0) / a.length;
                const avgB = b.reduce((sum, x) => sum + x.score, 0) / b.length;
                return avgB - avgA;
            });

            const best = windows[0];
            const avg = best.reduce((sum, x) => sum + x.score, 0) / best.length;

            return {
                start: best[0].time,
                end: best[best.length - 1].time,
                avgScore: avg,
                length: best.length
            };
        }

        let cachedBestRide = null; // Store for modal

        // --- MODAL UTILS FOR SMOOTH TRANSITION ---
        function showModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('hidden');
            // Double RAF to ensure browser renders
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    el.classList.add('active');
                    el.style.opacity = '1';
                });
            });
        }

        function hideModal(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.remove('active');
            el.style.opacity = '0';
            setTimeout(() => {
                if (!el.classList.contains('active')) {
                    el.classList.add('hidden');
                }
            }, 300);
        }

        function updateBestRideUI() {
            const br = calculateBestRide(lastWeatherData.hourly);
            cachedBestRide = br; // Save for modal

            const el = document.getElementById('bestRideSection');
            if (br && br.avgScore >= 6) {
                // Determine layout visibility
                if (layoutConfig.visibility.bestRideSection) {
                    el.classList.remove('hidden');

                    const dStart = new Date(br.start);
                    const dEnd = new Date(br.end);
                    // Add 1 hour to end time for display logic (e.g. 13:00 to 14:00 window covers the 14:00 slot but effectively ends at 15:00 visually, or simply use the hour itself)
                    // Let's keep it simple: Start Hour - End Hour.
                    // If window is [14:00, 15:00], it means riding is good at 14 and 15. So effectively until 16:00 almost.
                    // Let's leave it as Start Hour - End Hour (inclusive).

                    const dayName = dStart.toLocaleDateString('de-DE', { weekday: 'long' });
                    const todayName = new Date().toLocaleDateString('de-DE', { weekday: 'long' });
                    const displayDay = (dayName === todayName) ? "Heute" : dayName;

                    const tStart = dStart.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                    // For end time, showing the start of the last good hour.
                    // Maybe nicer to show range?
                    let endH = dEnd.getHours() + 1; // End of that hour
                    if (endH > 23) endH = 0; // overflow check not critical for display

                    // Simple hack: if end is same as start (length 1), show single hour. But we filtered for length >= 2
                    const tEnd = (endH).toString().padStart(2, '0') + ":00";

                    document.getElementById('bestRideTime').innerText = `${tStart} - ${tEnd}`;
                    document.getElementById('bestRideDay').innerText = displayDay;
                    document.getElementById('bestRideScore').innerText = br.avgScore.toFixed(1);

                    // Calc and show temp on card
                    const h = lastWeatherData.hourly;
                    let cTemp = 0, cCount = 0;
                    let sIdx = 0;
                    while (sIdx < h.time.length && h.time[sIdx] !== br.start) sIdx++;
                    if (sIdx < h.time.length) {
                        for (let k = 0; k < br.length; k++) {
                            if (sIdx + k < h.time.length) { cTemp += h.temperature_2m[sIdx + k]; cCount++; }
                        }
                        if (cCount > 0) cTemp /= cCount;
                    }
                    const trEl = document.getElementById('bestRideTemp');
                    if (trEl) {
                        trEl.innerText = Math.round(cTemp) + "°";
                        trEl.classList.remove('hidden');
                    }

                    // Style score
                    const scEl = document.getElementById('bestRideScore');
                    if (br.avgScore >= 8) {
                        scEl.className = "text-xs font-black bg-emerald-400/20 text-emerald-200 px-2 py-0.5 rounded-full border border-emerald-400/30";
                        document.getElementById('bestRideDesc').innerText = "Top Bedingungen! 🏍️";
                    } else {
                        scEl.className = "text-xs font-black bg-yellow-400/20 text-yellow-200 px-2 py-0.5 rounded-full border border-yellow-400/30";
                        document.getElementById('bestRideDesc').innerText = "Gutes Zeitfenster";
                    }
                } else {
                    console.log("Config hidden bestRideSection");
                    el.classList.add('hidden'); // hidden by config
                }
            } else {
                // FALLBACK: User wants to see *something* instead of nothing.
                if (layoutConfig.visibility.bestRideSection) {
                    el.classList.remove('hidden');
                    document.getElementById('bestRideTime').innerText = "--:--";
                    document.getElementById('bestRideDay').innerText = "Kein Fenster";
                    document.getElementById('bestRideScore').innerText = "--";
                    document.getElementById('bestRideScore').className = "text-xs font-black bg-slate-700/50 text-slate-400 px-2 py-0.5 rounded-full border border-slate-600/50";
                    document.getElementById('bestRideDesc').innerText = "Keine guten Bedingungen nächsten 48h";
                    const trEl = document.getElementById('bestRideTemp');
                    if (trEl) trEl.classList.add('hidden');
                } else {
                    el.classList.add('hidden');
                }
            }
        }
        async function showBestRideDetails() {
            if (!cachedBestRide) return;
            const br = cachedBestRide;

            const dStart = new Date(br.start);
            const dEnd = new Date(br.end);
            const dayName = dStart.toLocaleDateString('de-DE', { weekday: 'long' });
            const todayName = new Date().toLocaleDateString('de-DE', { weekday: 'long' });
            const displayDay = (dayName === todayName) ? "Heute" : dayName;

            const tStart = dStart.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            let endH = dEnd.getHours() + 1;
            const tEnd = (endH > 23 ? 0 : endH).toString().padStart(2, '0') + ":00";

            document.getElementById('brDetailScore').innerText = br.avgScore.toFixed(1);
            document.getElementById('brDetailTime').innerText = `${tStart} - ${tEnd}`;
            document.getElementById('brDetailDay').innerText = displayDay;

            // Re-find indices in hourly
            const h = lastWeatherData.hourly;
            // const off = (lastWeatherData.utc_offset_seconds || 0) * 1000; // Not strictly needed for string match
            let startIdx = -1;
            // Simple string match
            for (let i = 0; i < h.time.length; i++) {
                if (h.time[i] === br.start) { startIdx = i; break; }
            }

            const list = document.getElementById('brReasonsList');
            list.innerHTML = '';

            if (startIdx !== -1) {
                let avgTemp = 0, maxWind = 0, rainSum = 0;
                const len = br.length;

                for (let k = 0; k < len; k++) {
                    const idx = startIdx + k;
                    if (idx < h.time.length) {
                        avgTemp += h.temperature_2m[idx];
                        maxWind = Math.max(maxWind, h.wind_speed_10m[idx]);
                        rainSum += h.precipitation[idx]
                    }
                }
                avgTemp /= len;

                document.getElementById('brDetailTempDisplay').innerText = Math.round(avgTemp) + "°";

                if (avgTemp >= 18 && avgTemp <= 26) list.innerHTML += `<div class="flex items-center gap-3"><i data-lucide="thermometer-sun" class="text-emerald-400"></i><span class="text-sm text-emerald-100">Perfekte Temperatur (~${Math.round(avgTemp)}°)</span></div>`;
                else if (avgTemp >= 15) list.innerHTML += `<div class="flex items-center gap-3"><i data-lucide="thermometer" class="text-emerald-400"></i><span class="text-sm text-emerald-100">Angenehm (~${Math.round(avgTemp)}°)</span></div>`;

                if (rainSum === 0) list.innerHTML += `<div class="flex items-center gap-3"><i data-lucide="droplets" class="text-blue-300"></i><span class="text-sm text-blue-100">Kein Regen vorhergesagt</span></div>`;

                if (maxWind < 15) list.innerHTML += `<div class="flex items-center gap-3"><i data-lucide="wind" class="text-emerald-400"></i><span class="text-sm text-emerald-100">Wenig Wind (< ${Math.round(maxWind)} km/h)</span></div>`;
                else if (maxWind < 30) list.innerHTML += `<div class="flex items-center gap-3"><i data-lucide="wind" class="text-yellow-400"></i><span class="text-sm text-yellow-100">Mäßiger Wind (~${Math.round(maxWind)} km/h)</span></div>`;

                if (br.avgScore >= 9) list.innerHTML += `<div class="flex items-center gap-3 mt-2 pt-2 border-t border-slate-700/50"><i data-lucide="check-check" class="text-emerald-400"></i><span class="text-sm font-bold text-emerald-100">Absoluter Top-Zeitraum!</span></div>`;
            }

            // REPLACED: openWithMorph logic removed, using showModal directly
            showModal('bestRideModal');
            lucide.createIcons();
        }

        function updateRadar() { if (typeof L !== 'undefined') { initRadarMap(); } }
        function toggleFullscreen() { const c = document.getElementById('radarSection'); isFullscreen = !isFullscreen; if (isFullscreen) { c.classList.add('radar-fullscreen'); document.getElementById('fullscreenIcon').setAttribute('data-lucide', 'x'); document.body.style.overflow = 'hidden'; } else { c.classList.remove('radar-fullscreen'); document.getElementById('fullscreenIcon').setAttribute('data-lucide', 'maximize-2'); document.body.style.overflow = ''; } lucide.createIcons(); setTimeout(() => { if (radarMap) radarMap.invalidateSize(); }, 300); }

        function updateUI(name, fromCache = false) {
            try {
                if (name) document.getElementById('cityName').innerText = name; const cur = lastWeatherData.current;
                document.getElementById('splashCity').innerText = name || "Unbekannt"; document.getElementById('splashTemp').innerText = Math.round(cur.temperature_2m);
                const info = getWeatherInfo(cur.weather_code); document.getElementById('splashIcon').innerHTML = `<i data-lucide="${info.i}" class="w-24 h-24"></i>`; document.getElementById('splashDesc').innerText = info.t;
                renderSplashEffects(cur.weather_code, cur.is_day);
                updateSunVisuals();
                // PASS NEW PARAMETER
                updateMainValues(
                    cur.temperature_2m,
                    cur.apparent_temperature, // NEW
                    cur.wind_speed_10m,
                    cur.relative_humidity_2m,
                    cur.precipitation,
                    cur.weather_code,
                    cur.is_day,
                    0
                );
                checkWarnings(cur);
                // checkAndSendNotification AUFRUF ENTFERNT
                if (lastWeatherData.hourly) document.getElementById('dailyScoreValue').innerText = calculateDailyScore(lastWeatherData.hourly) + " / 10";
                updateBestRideUI(); // NEW
                renderRainChart(lastWeatherData.minutely_15); renderHourly(); render7Day(); applyLayout();
                updateFavIconState(); // NEW: Update Favorite Icon
                document.getElementById('startPrompt').classList.add('hidden');
                document.getElementById('dynamicContent').classList.remove('hidden');
                loadingIndicator.classList.add('hidden'); updateRadar();
                if (isFirstLoad) { document.getElementById('splashScreen').classList.remove('splash-hidden'); isFirstLoad = false; }
            } catch (e) { console.error("UpdateUI Error", e); loadingIndicator.classList.add('hidden'); }
        }

        async function fetchWeather(name, country, isBackground = false) { // UPDATED: Background flag
            if (!isBackground) { loadingIndicator.classList.remove('hidden'); offlineBanner.classList.add('hidden'); }

            // Store for auto-refresh
            currentCityName = name;
            currentCountry = country;

            // Reset refresh timer to align with manual fetches
            if (refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if (!document.hidden) {
                    console.log("Auto-refreshing weather...");
                    fetchWeather(currentCityName, currentCountry, true);
                }
            }, 300000); // 5 Minutes (300,000 ms)

            // Added apparent_temperature to current fetch
            // NEU: cloud_cover, wind_gusts_10m, surface_pressure (dew_point_2m entfernt)
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation,is_day,visibility,uv_index,cloud_cover,wind_gusts_10m,surface_pressure&hourly=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,uv_index_max&minutely_15=precipitation&forecast_days=7&timezone=auto&_t=${Date.now()}`;
            try { const r = await fetch(url); if (!r.ok) throw new Error(); lastWeatherData = await r.json(); saveToCache(name, lastWeatherData); updateUI(name); }
            catch (e) {
                if (!isBackground) { // Only show errors if user initiated
                    const c = loadFromCache(); if (c) { lastWeatherData = c.data; offlineBanner.innerText = "Offline"; offlineBanner.classList.remove('hidden'); updateUI(c.name, true); } else { document.getElementById('errorMessage').classList.remove('hidden'); loadingIndicator.classList.add('hidden'); }
                }
            }
        }

        // --- LOCATEME DEFINITION MOVED HERE ---
        function locateMe(silent = false) {
            if (!navigator.geolocation) { console.log("Kein GPS Support"); fetchWeather("Berlin", ""); return; }
            if (!silent) { document.getElementById('loadingIndicator').classList.remove('hidden'); initCompass(); }
            navigator.geolocation.getCurrentPosition(async p => {
                currentLat = p.coords.latitude; currentLon = p.coords.longitude;
                if (document.getElementById('splashCity')) document.getElementById('splashCity').innerText = "Suche Ort...";
                let n = null;
                try { const r = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${currentLat}&longitude=${currentLon}&language=de&format=json`); const d = await r.json(); if (d.results && d.results[0]) n = d.results[0].name || d.results[0].city || d.results[0].town || d.results[0].village || d.results[0].suburb || d.results[0].hamlet; } catch (e) { }
                if (!n) { try { const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLat}&lon=${currentLon}&format=json&accept-language=de`, { headers: { 'User-Agent': 'WetterApp/2.5' } }); const d = await r.json(); if (d.address) n = d.address.city || d.address.town || d.address.village || d.address.hamlet || d.address.suburb || d.address.neighbourhood || d.address.county; } catch (e) { } }
                if (!n) n = `${currentLat.toFixed(2)}, ${currentLon.toFixed(2)}`;
                fetchWeather(n, "");
            }, () => {
                document.getElementById('loadingIndicator').classList.add('hidden');
                console.warn("Standort Zugriff blockiert oder abgebrochen.");
                if (!silent) { document.getElementById('cityName').innerText = "Berlin (Demo)"; currentLat = 52.52; currentLon = 13.41; fetchWeather("Berlin", ""); } else { document.getElementById('gpsErrorPrompt').classList.remove('hidden'); }
            }, { timeout: 10000, enableHighAccuracy: true });
        }
        window.locateMe = locateMe; // Expose globally

        // Search Suggestions Logic
        cityInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const value = e.target.value.trim();

            if (value.length < 2) {
                suggestionsList.classList.add('hidden');
                return;
            }

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(value)}&count=5&language=de&format=json`);
                    const data = await response.json();

                    suggestionsList.innerHTML = '';

                    if (data.results && data.results.length > 0) {
                        suggestionsList.classList.remove('hidden');
                        data.results.forEach(city => {
                            const countryCode = city.country_code ? city.country_code.toLowerCase() : '';
                            const flagUrl = countryCode ? `https://flagcdn.com/24x18/${countryCode}.png` : '';

                            const div = document.createElement('div');
                            div.className = "p-3 cursor-pointer border-b border-slate-700/50 flex items-center justify-between transition-colors";

                            // Left side: Name + Region
                            const infoDiv = document.createElement('div');
                            infoDiv.innerHTML = `<span class="font-bold text-white text-sm block">${city.name}</span><span class="text-xs text-slate-400">${city.admin1 || city.country || ''}</span>`;

                            // Right side: Flag
                            if (flagUrl) {
                                const img = document.createElement('img');
                                img.src = flagUrl;
                                img.className = "w-6 h-4 opacity-80 rounded-sm";
                                div.appendChild(infoDiv);
                                div.appendChild(img);
                            } else {
                                div.appendChild(infoDiv);
                            }

                            div.onclick = () => {
                                cityInput.value = city.name;
                                suggestionsList.classList.add('hidden');
                                currentLat = city.latitude;
                                currentLon = city.longitude;
                                fetchWeather(city.name, city.country);
                            };

                            suggestionsList.appendChild(div);
                        });
                    } else {
                        suggestionsList.classList.add('hidden');
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    suggestionsList.classList.add('hidden');
                }
            }, 300);
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', (e) => {
            if (!cityInput.contains(e.target) && !suggestionsList.contains(e.target)) {
                suggestionsList.classList.add('hidden');
            }
        });

        function selectHour(i) {
            const h = lastWeatherData.hourly;
            const t = Math.round(h.temperature_2m[i]);
            const c = h.weather_code[i];
            const d = new Date(h.time[i]);
            const s = calculateMotoScore(t, h.wind_speed_10m[i], h.precipitation[i], h.is_day[i], c);
            const cl = getScoreColor(s.score);
            document.getElementById('modalTime').innerText = `${d.toLocaleDateString('de-DE', { weekday: 'long' })} ${d.getHours()}:00`;
            document.getElementById('modalTemp').innerText = t;
            document.getElementById('modalDesc').innerText = getWeatherInfo(c).t;
            document.getElementById('modalIcon').innerHTML = `<i data-lucide="${getWeatherInfo(c).i}" size="48"></i>`;
            document.getElementById('modalWind').innerText = h.wind_speed_10m[i] + " km/h";
            document.getElementById('modalRain').innerText = h.precipitation[i] + " mm";
            document.getElementById('modalHum').innerText = h.relative_humidity_2m[i] + "%";
            document.getElementById('modalScoreVal').innerText = s.score;
            document.getElementById('modalScoreBg').className = `rounded-xl p-3 border flex items-center justify-between ${cl.bg} bg-slate-900/50`;
            showModal('hourlyDetailsModal');
            lucide.createIcons();
        }

        function renderHourly() {
            const c = document.getElementById('hourlyContainer'); c.innerHTML = ''; const h = lastWeatherData.hourly;
            const off = (lastWeatherData.utc_offset_seconds || 0) * 1000; const start = h.time.findIndex(t => t.startsWith(new Date(Date.now() + off).toISOString().slice(0, 13))) || 0;
            for (let i = start; i < start + 24; i++) {
                if (!h.time[i]) break; const hr = new Date(h.time[i]).getHours(); const t = Math.round(h.temperature_2m[i]);
                const sc = calculateMotoScore(t, h.wind_speed_10m[i], h.precipitation[i], h.is_day[i], h.weather_code[i]);
                const col = getScoreColor(sc.score); const ic = getWeatherInfo(h.weather_code[i]).i;
                const act = (i === start) ? "bg-slate-700 border-blue-500/50" : "bg-slate-800/50 border-transparent";
                const dnI = h.is_day[i] === 1 ? "sun" : "moon";
                const dnC = h.is_day[i] === 1 ? "text-orange-100/20" : "text-slate-400/10";
                c.innerHTML += `<div onclick="selectHour(${i})" class="relative hour-card cursor-pointer snap-start flex-shrink-0 w-24 p-2 rounded-xl border ${act} flex flex-col items-center justify-between h-32 transition-all"><div class="absolute top-1 right-1 ${dnC}"><i data-lucide="${dnI}" size="8"></i></div><span class="text-xs text-slate-400 font-mono text-center leading-tight">${hr}:00</span><div class="text-blue-200"><i data-lucide="${ic}" size="20"></i></div><span class="text-sm font-bold">${t}°</span><div class="w-full flex justify-center mt-1"><div class="h-1.5 w-8 rounded-full ${col.bg.replace('text-', 'bg-').split(' ')[1]}"></div></div></div>`;
            } lucide.createIcons();
        }

        function getWeatherInfo(c) { const m = { 0: { t: "Klar", i: "sun" }, 1: { t: "Heiter", i: "sun" }, 2: { t: "Wolkig", i: "cloud-sun" }, 3: { t: "Bedeckt", i: "cloud" }, 45: { t: "Nebel", i: "cloud-fog" }, 48: { t: "Nebel", i: "cloud-fog" }, 51: { t: "Niesel", i: "cloud-drizzle" }, 53: { t: "Niesel", i: "cloud-drizzle" }, 55: { t: "Niesel", i: "cloud-drizzle" }, 56: { t: "Gefrier. Niesel", i: "cloud-drizzle" }, 57: { t: "Gefrier. Niesel", i: "cloud-drizzle" }, 61: { t: "Regen", i: "cloud-rain" }, 63: { t: "Regen", i: "cloud-rain" }, 65: { t: "Starkregen", i: "cloud-rain" }, 66: { t: "Gefrier. Regen", i: "cloud-hail" }, 67: { t: "Gefrier. Regen", i: "cloud-hail" }, 71: { t: "Schnee", i: "snowflake" }, 73: { t: "Schnee", i: "snowflake" }, 75: { t: "Schnee", i: "snowflake" }, 77: { t: "Schneegriesel", i: "snowflake" }, 80: { t: "Schauer", i: "cloud-rain-wind" }, 81: { t: "Schauer", i: "cloud-rain-wind" }, 82: { t: "Starkschauer", i: "cloud-rain-wind" }, 85: { t: "Schneeschauer", i: "snowflake" }, 86: { t: "Schneeschauer", i: "snowflake" }, 95: { t: "Gewitter", i: "cloud-lightning" }, 96: { t: "Gewitter", i: "cloud-lightning" }, 99: { t: "Gewitter", i: "cloud-lightning" } }; return m[c] || { t: "Unbekannt", i: "help-circle" }; }

        function startClock() {
            const c = document.getElementById('liveClock');
            if (c) c.innerText = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            updateSunVisuals();
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(() => {
                if (c) c.innerText = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                updateSunVisuals();
            }, 1000);
        }
        startClock(); document.addEventListener('DOMContentLoaded', () => { if (typeof locateMe === 'function') locateMe(true); });

        // --- INTELLIGENT GARAGE LOGIC ---
        let motoProfile = {
            minTemp: 10,
            maxWind: 30,
            rainTolerance: false,
            mapOpacity: 0.5 // Default Opacity
        };
        try { const saved = localStorage.getItem('motoWeather_profile'); if (saved) motoProfile = { ...motoProfile, ...JSON.parse(saved) }; } catch (e) { }

        function updateMotoMapSettings(key, val) {
            if (key === 'opacity') {
                motoProfile.mapOpacity = parseInt(val) / 100;
                document.getElementById('dispMapOpacity').innerText = val + "%";
                // Apply immediately
                const mapEl = document.getElementById('motoLiveMap');
                if (mapEl) mapEl.style.opacity = motoProfile.mapOpacity;
            }
            saveMotoProfile();
        }

        function updateMotoSettings(key, val) {
            if (key === 'minTemp') motoProfile.minTemp = parseInt(val);
            if (key === 'maxWind') motoProfile.maxWind = parseInt(val);
            saveMotoProfile();
            updateUI(currentCityName, false);
        }
        function toggleRainTolerance() { motoProfile.rainTolerance = !motoProfile.rainTolerance; saveMotoProfile(); updateUI(currentCityName, false); }
        function saveMotoProfile() {
            localStorage.setItem('motoWeather_profile', JSON.stringify(motoProfile));
            const dMin = document.getElementById('dispMinTemp'); if (dMin) dMin.innerText = motoProfile.minTemp + "°C";
            const dWind = document.getElementById('dispMaxWind'); if (dWind) dWind.innerText = motoProfile.maxWind + " km/h";
            const iMin = document.getElementById('inputMinTemp'); if (iMin) iMin.value = motoProfile.minTemp;
            const iWind = document.getElementById('inputMaxWind'); if (iWind) iWind.value = motoProfile.maxWind;

            // Map Opacity UI init
            const dOp = document.getElementById('dispMapOpacity'); if (dOp) dOp.innerText = Math.round(motoProfile.mapOpacity * 100) + "%";
            const iOp = document.getElementById('inputMapOpacity'); if (iOp) iOp.value = Math.round(motoProfile.mapOpacity * 100);
            const mapEl = document.getElementById('motoLiveMap'); if (mapEl) mapEl.style.opacity = motoProfile.mapOpacity;

            const btn = document.getElementById('btnRainTol');
            const desc = document.getElementById('rainTolDesc');
            if (btn && desc) {
                if (motoProfile.rainTolerance) { btn.innerText = "Egal"; btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-slate-700 text-slate-300 border border-slate-600"; desc.innerText = "Regenkombi am Start!"; }
                else { btn.innerText = "Streng"; btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-blue-600 text-white border border-blue-500"; desc.innerText = "Kein Tropfen erlaubt!"; }
            }
        }

        // --- SETTINGS LIST RENDER ---
        function renderSettingsLists() {
            // 1. Grid Config (Moto Index Factors)
            const gridList = document.getElementById('gridConfigList');
            if (gridList) {
                gridList.innerHTML = '';
                const factors = [
                    { id: 'f_temp', label: 'Temperatur', active: true, desc: 'Einfluss auf Grip' },
                    { id: 'f_wind', label: 'Wind/Böen', active: true, desc: 'Stabilität' },
                    { id: 'f_rain', label: 'Niederschlag', active: true, desc: 'Rutschgefahr' },
                    { id: 'f_day', label: 'Tageszeit', active: true, desc: 'Sichtbarkeit' }
                ];
                factors.forEach(f => {
                    gridList.innerHTML += `
                        <div class="flex items-center justify-between p-2 bg-slate-700/30 rounded-lg">
                            <div>
                                <div class="text-xs font-bold text-slate-300">${f.label}</div>
                                <div class="text-[10px] text-slate-500">${f.desc}</div>
                            </div>
                            <div class="h-4 w-4 rounded border ${f.active ? 'bg-blue-500 border-blue-500' : 'border-slate-500'} flex items-center justify-center">
                                ${f.active ? '<i data-lucide="check" size="10" class="text-white"></i>' : ''}
                            </div>
                        </div>`;
                });
                lucide.createIcons();
            }

            // 2. Layout List
            const layoutList = document.getElementById('layoutList');
            if (layoutList) {
                layoutList.innerHTML = '';
                const layouts = [
                    { id: 'l_weather', label: 'Wetter Dashboard', icon: 'cloud-sun', active: true },
                    { id: 'l_moto', label: 'Moto Dashboard', icon: 'gauge', active: true }
                ];
                layouts.forEach(l => {
                    layoutList.innerHTML += `
                        <div class="flex items-center justify-between p-2 bg-slate-700/30 rounded-lg">
                            <div class="flex items-center gap-2">
                                <i data-lucide="${l.icon}" size="14" class="text-slate-400"></i>
                                <span class="text-xs font-bold text-slate-300">${l.label}</span>
                            </div>
                            <button class="text-green-400"><i data-lucide="eye" size="16"></i></button>
                        </div>`;
                });
                lucide.createIcons();
            }
        }

        // Init UI on load
        document.addEventListener('DOMContentLoaded', () => {
            saveMotoProfile();
            renderSettingsLists(); // NEW: Populate settings
            try { initMotoMap(); } catch (e) { }
        });

        function initMotoMap() {
            if (motoMap || !document.getElementById('motoLiveMap')) return;

            // Create Map
            motoMap = L.map('motoLiveMap', {
                zoomControl: false,
                attributionControl: false,
                dragging: true,
                touchZoom: true,
                scrollWheelZoom: true,
                doubleClickZoom: true,
                boxZoom: false,
                keyboard: false
            }).setView([currentLat, currentLon], 15);

            // Add Dark Tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(motoMap);

            // User Marker (Custom Pulse)
            const icon = L.divIcon({
                className: 'custom-moto-icon',
                html: `<div class="relative w-4 h-4">
                          <div class="absolute inset-0 bg-blue-500 rounded-full animate-ping opacity-75"></div>
                          <div class="relative w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow-lg"></div>
                        </div>`,
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });

            motoMarker = L.marker([currentLat, currentLon], { icon: icon }).addTo(motoMap);
            isMotoMapInitialized = true;
        }

        function updateMotoMapPosition(lat, lon) {
            if (!motoMap || !motoMarker) return;

            // Move marker
            motoMarker.setLatLng([lat, lon]);

            // Strict Centering
            // Strict Centering (Preserve Zoom)
            motoMap.setView([lat, lon], motoMap.getZoom(), { animate: true });

            // ROTATION (Heading Up)
            const heading = pos.coords.heading;
            const mapContainer = document.getElementById('motoLiveMap');
            if (heading !== null && heading !== undefined && !isNaN(heading)) {
                // Rotate container opposite to heading
                if (mapContainer) mapContainer.style.transform = `translate(-50%, -50%) rotate(${-heading}deg)`;
            } else {
                // No Heading? Reset rotation (North Up)
                if (mapContainer) mapContainer.style.transform = `translate(-50%, -50%) rotate(0deg)`;
            }

            // Speed Update
            let kmh = 0;
            if (spd && spd > 0.5) kmh = spd * 3.6;
            document.getElementById('motoSpeedDisplay').innerText = Math.round(kmh);
            if (kmh > sessionMaxSpeed) sessionMaxSpeed = kmh;

            // Distance (Simple)
            // ... (Omitting Distance calc for brevity here, logic was in old duplicate block, ideally revived if needed)
            // Ideally we re-insert that small logic:
            if (!window.lastMotoPosTime) window.lastMotoPosTime = 0;
            const now = Date.now();
            if (window.lastMotoPosTime > 0 && spd !== null) {
                const dt = (now - window.lastMotoPosTime) / 1000;
                if (dt < 10) sessionDistance += spd * dt;
            }
            window.lastMotoPosTime = now;
        }

        // --- ROUTE WEATHER LOGIC ---
        function openRouteModal() {
            document.getElementById('routeStartName').innerText = currentCityName || "Unbekannt";
            document.getElementById('routeDestInput').value = "";
            document.getElementById('routeModal').classList.remove('hidden');
            document.getElementById('routeDestInput').focus();
        }

        async function calculateRouteWeather() {
            const destName = document.getElementById('routeDestInput').value;
            if (!destName || destName.length < 2) return;

            const btn = document.querySelector('#routeModal button[onclick="calculateRouteWeather()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<div class="loader-sm border-white"></div> Prüfe Route...`;
            btn.disabled = true;

            try {
                // 1. Geocode Destination
                const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(destName)}&count=1&language=de&format=json`);
                const geoData = await geoRes.json();

                if (!geoData.results || geoData.results.length === 0) {
                    alert("Zielort nicht gefunden.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                const destLat = geoData.results[0].latitude;
                const destLon = geoData.results[0].longitude;
                const destRealName = geoData.results[0].name;

                // 2. Fetch Destination Weather (Reuse current city data for Start)
                // Use simplified fetch for destination (only current & daily needed)
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${destLat}&longitude=${destLon}&current=temperature_2m,precipitation,weather_code,wind_speed_10m,is_day&daily=weather_code,temperature_2m_max&timezone=auto`;
                const r = await fetch(url);
                const destData = await r.json();

                // 3. Compare & Display
                // Start Data
                const startCur = lastWeatherData.current;
                const startScore = calculateMotoScore(startCur.temperature_2m, startCur.wind_speed_10m, startCur.precipitation, startCur.is_day, startCur.weather_code);

                // End Data
                const endCur = destData.current;
                const endScore = calculateMotoScore(endCur.temperature_2m, endCur.wind_speed_10m, endCur.precipitation, endCur.is_day, endCur.weather_code);

                // Build Result UI
                const modalContent = document.querySelector('#routeModal .modal-content');

                // Colorize Scores
                const sCol = getScoreColor(startScore.score);
                const eCol = getScoreColor(endScore.score);

                modalContent.innerHTML = `
                    <button onclick="resetRouteModal()" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
                    <h3 class="text-lg font-bold mb-4 text-blue-300 flex items-center gap-2"><i data-lucide="map" size="20"></i> Route Check</h3>
                    
                    <div class="flex items-center justify-between mb-4 bg-slate-800/50 p-3 rounded-xl border border-slate-700/50">
                        <div class="text-center">
                            <div class="text-[10px] text-slate-500 uppercase font-bold">Start</div>
                            <div class="font-bold text-white text-sm">${currentCityName}</div>
                            <div class="text-xs text-slate-400">${Math.round(startCur.temperature_2m)}°</div>
                        </div>
                        <i data-lucide="arrow-right" class="text-slate-600"></i>
                        <div class="text-center">
                            <div class="text-[10px] text-slate-500 uppercase font-bold">Ziel</div>
                            <div class="font-bold text-white text-sm">${destRealName}</div>
                            <div class="text-xs text-slate-400">${Math.round(endCur.temperature_2m)}°</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div class="bg-slate-800/30 p-4 rounded-xl border ${sCol.bg} flex flex-col items-center">
                            <div class="text-xs text-slate-500 mb-1">Start Score</div>
                            <div class="text-3xl font-black ${sCol.bg.split(' ')[1]}">${startScore.score}</div>
                            <div class="text-[10px] text-slate-400">${startScore.reason}</div>
                        </div>
                        <div class="bg-slate-800/30 p-4 rounded-xl border ${eCol.bg} flex flex-col items-center">
                            <div class="text-xs text-slate-500 mb-1">Ziel Score</div>
                            <div class="text-3xl font-black ${eCol.bg.split(' ')[1]}">${endScore.score}</div>
                            <div class="text-[10px] text-slate-400">${endScore.reason}</div>
                        </div>
                    </div>

                    <div class="text-center">
                        ${(startScore.score > 7 && endScore.score > 7)
                        ? '<div class="text-emerald-400 font-bold bg-emerald-500/10 p-2 rounded-lg border border-emerald-500/20">Gute Fahrt! 🏍️💨</div>'
                        : (endScore.score < 4)
                            ? '<div class="text-red-400 font-bold bg-red-500/10 p-2 rounded-lg border border-red-500/20">Zielwetter ist mies! ⚠️</div>'
                            : '<div class="text-blue-200 font-bold bg-blue-500/10 p-2 rounded-lg border border-blue-500/20">Fahr vorsichtig.</div>'
                    }
                    </div>
                `;
                lucide.createIcons();

            } catch (e) {
                console.error(e);
                alert("Fehler beim Abrufen der Route.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // Reset Logic Removed

        // --- FAVORITES LOGIC ---
        let favorites = [];
        try { const f = localStorage.getItem('motoWeather_favorites_v1'); if (f) favorites = JSON.parse(f); } catch (e) { }
        function isFavorite(n) { return favorites.some(fav => fav.name.toLowerCase() === n.toLowerCase()); }

        async function toggleFavoriteCurrent() {
            if (!currentCityName) return;
            // Slightly normalize name
            const n = currentCityName; const c = currentCountry || "";
            const idx = favorites.findIndex(fav => fav.name.toLowerCase() === n.toLowerCase());

            if (idx > -1) {
                favorites.splice(idx, 1);
            } else {
                // Fix: Save current coordinates with favorite
                favorites.push({ name: n, country: c, lat: currentLat, lon: currentLon });
            }
            saveFavorites(); updateFavIconState();
        }

        function saveFavorites() { localStorage.setItem('motoWeather_favorites_v1', JSON.stringify(favorites)); renderFavoritesList(); }

        function updateFavIconState() {
            const btn = document.getElementById('favToggleBtn'); if (!btn || !currentCityName) return;
            const isFav = isFavorite(currentCityName);
            btn.innerHTML = isFav ? `<i data-lucide="heart" class="text-red-500 fill-red-500" size="20"></i>` : `<i data-lucide="heart" class="text-slate-500" size="20"></i>`;
            lucide.createIcons();
        }

        function renderFavoritesList() {
            const l = document.getElementById('favoritesListContent'); if (!l) return;
            l.innerHTML = '';
            if (favorites.length === 0) { l.innerHTML = '<div class="text-center text-slate-500 py-6 italic text-sm">Noch keine Favoriten gespeichert.<br>Tippe auf das Herz beim Ort!</div>'; return; }
            favorites.forEach(fav => {
                l.innerHTML += `<div class="flex items-center justify-between bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 mb-2 fav-item group hover:bg-slate-700/50">
                    <div onclick="loadFavorite('${fav.name}', '${fav.country}', ${fav.lat}, ${fav.lon})" class="flex-grow font-bold text-slate-200 text-sm flex items-center justify-start gap-2 text-left"><i data-lucide="map-pin" size="14" class="text-slate-500 shrink-0"></i> ${fav.name}</div>
                    <button onclick="removeFavorite('${fav.name}')" class="p-2 text-slate-500 hover:text-red-400 transition bg-slate-800 rounded-lg hover:bg-slate-900 border border-slate-700"><i data-lucide="trash-2" size="14"></i></button>
                </div>`;
            });
            lucide.createIcons();
        }

        async function loadFavorite(n, c, lat, lon) {
            document.getElementById('favoritesModal').classList.add('hidden');

            // Case 1: Coordinates exist (New favorites)
            if (lat && lon && !isNaN(lat) && !isNaN(lon)) {
                currentLat = parseFloat(lat);
                currentLon = parseFloat(lon);
                fetchWeather(n, c);
                return;
            }

            // Case 2: Legacy favorite (missing coords) - Fetch them!
            loadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(n)}&count=1&language=de&format=json`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    currentLat = data.results[0].latitude;
                    currentLon = data.results[0].longitude;

                    // Optional: Update the legacy favorite to prevent future lookups
                    const idx = favorites.findIndex(fav => fav.name.toLowerCase() === n.toLowerCase());
                    if (idx > -1) {
                        favorites[idx].lat = currentLat;
                        favorites[idx].lon = currentLon;
                        saveFavorites();
                    }

                    fetchWeather(n, c);
                } else {
                    document.getElementById('errorMessage').classList.remove('hidden');
                    loadingIndicator.classList.add('hidden');
                }
            } catch (e) {
                console.error("Fav Geo Error", e);
                loadingIndicator.classList.add('hidden');
            }
        }
        function removeFavorite(n) { const idx = favorites.findIndex(fav => fav.name.toLowerCase() === n.toLowerCase()); if (idx > -1) { favorites.splice(idx, 1); saveFavorites(); } }
    </script>
    <script>
        // --- MOTO LEAN ANGLE LOGIC ---
        let maxLeft = 0;
        let maxRight = 0;
        let calibrationOffset = 0;
        let currentGamma = 0;
        // SPEED VARIABLES
        let currentMotoSpeed = 0; // km/h
        let lastAccelTime = 0;
        const speedSmoothingFactor = 0.1; // Simple low-pass filter if needed

        const motoGaugeArc = document.getElementById('motoGaugeArc');
        const motoBikeIcon = document.getElementById('motoBikeIcon');
        const motoAngleDisplay = document.getElementById('motoAngleDisplay');
        const motoSpeedDisplay = document.getElementById('motoSpeedDisplay'); // NEW
        const maxLeftDisplay = document.getElementById('maxLeftDisplay');
        const maxRightDisplay = document.getElementById('maxRightDisplay');

        function handleMotoOrientation(event) {
            let tilt = event.gamma;
            if (tilt === null) return;
            currentGamma = tilt;

            tilt = tilt - calibrationOffset;

            // Clamp
            if (tilt > 90) tilt = 90;
            if (tilt < -90) tilt = -90;

            // Update UI
            updateMotoUI(tilt);

            // Update Max
            if (tilt < 0 && tilt < maxLeft) {
                maxLeft = tilt;
                maxLeftDisplay.innerText = Math.abs(Math.round(maxLeft)) + "°";
            }
            if (tilt > 0 && tilt > maxRight) {
                maxRight = tilt;
                maxRightDisplay.innerText = Math.round(maxRight) + "°";
            }
        }

        function updateMotoUI(tilt) {
            if (!motoAngleDisplay) return;
            const absTilt = Math.abs(tilt);
            motoAngleDisplay.innerText = Math.round(absTilt) + "°";

            motoBikeIcon.style.transform = `rotate(${tilt}deg)`;

            const startX = 100;
            const startY = 10;
            const angleRad = (tilt - 90) * (Math.PI / 180);
            const r = 90;
            const endX = 100 + r * Math.cos(angleRad);
            const endY = 100 + r * Math.sin(angleRad);
            const sweep = tilt >= 0 ? 1 : 0;

            const d = `M${startX},${startY} A${r},${r} 0 0,${sweep} ${endX},${endY}`;
            motoGaugeArc.setAttribute('d', d);

            if (absTilt < 20) motoGaugeArc.setAttribute('stroke', '#3b82f6');
            else if (absTilt < 40) motoGaugeArc.setAttribute('stroke', '#fbbf24');
            else motoGaugeArc.setAttribute('stroke', '#ef4444');
        }

        function resetMotoMax() {
            maxLeft = 0;
            maxRight = 0;
            if (maxLeftDisplay) maxLeftDisplay.innerText = "0°";
            if (maxRightDisplay) maxRightDisplay.innerText = "0°";
        }

        window.calibrateMoto = function () {
            calibrationOffset = currentGamma;
            localStorage.setItem('motoCalibration_v1', calibrationOffset); // PERSISTENCE
            resetMotoMax();

            // Visual Feedback
            const btn = document.getElementById('btnMotoCalibrate');
            if (btn) {
                const oldText = btn.innerText;
                btn.innerText = "OK!";
                btn.classList.add('bg-green-500', 'text-white');
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.classList.remove('bg-green-500', 'text-white');
                }, 1000);
            }
        };

        // Load Calibration on Start
        try {
            const savedCal = localStorage.getItem('motoCalibration_v1');
            if (savedCal !== null) calibrationOffset = parseFloat(savedCal);
        } catch (e) { }

        // --- WAKE LOCK (KEEP SCREEN ON) ---
        let wakeLock = null;
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                }
            } catch (err) {
                console.error(`${err.name}, ${err.message}`);
            }
        }
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release().then(() => { wakeLock = null; });
                console.log('Wake Lock released');
            }
        }
        // Re-acquire lock if visibility changes (e.g. switch apps and back)
        document.addEventListener('visibilitychange', async () => {
            if (wakeLock !== null && document.visibilityState === 'visible') {
                requestWakeLock();
            }
        });

        // --- SENSORS & GPS FUSION ---
        // Duplicate/Old Logic Removed to favor Unified 'startMotoTracking'


        // --- RIDE HISTORY FUNCTIONS ---
        function saveRideLog() {
            if (sessionStartTime === 0) return;
            const durationMs = Date.now() - sessionStartTime;

            // Weather Context (Robust Fallback)
            let weatherSummary = "Unbekannt";
            let mainTemp = "--";

            // Try Data Object
            if (lastWeatherData && lastWeatherData.current_weather) {
                mainTemp = Math.round(lastWeatherData.current_weather.temperature);
                weatherSummary = getWeatherInfo(lastWeatherData.current_weather.weathercode).t;
            } else {
                // FALLBACK: Read from DOM
                const tDom = document.getElementById('temperature');
                const dDom = document.getElementById('weatherDesc');
                if (tDom && tDom.innerText !== '--') mainTemp = tDom.innerText;
                if (dDom && dDom.innerText !== '--') weatherSummary = dDom.innerText;
            }

            const logEntry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('de-DE'),
                time: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }),
                // NEW: Explicit Name Generation
                name: `Tour am ${new Date().toLocaleDateString('de-DE')} - ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })} Uhr`,
                duration: durationMs,
                stats: {
                    maxSpeed: Math.round(sessionMaxSpeed),
                    maxG: sessionMaxG.toFixed(2),
                    leanL: Math.round(Math.abs(maxLeft || 0)),
                    leanR: Math.round(Math.abs(maxRight || 0)),
                    distance: Math.round(sessionDistance) // Meters
                },
                weather: {
                    temp: mainTemp,
                    desc: weatherSummary
                }
            };

            try {
                let logs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]');
                logs.unshift(logEntry);
                if (logs.length > 20) logs.pop();
                localStorage.setItem('motoRideLogs_v1', JSON.stringify(logs));

                // Feedback for user
                // alert("Fahrt gespeichert! (" + (durationMs/1000).toFixed(1) + "s)"); 
                vibrate([50, 100]);
            } catch (e) {
                console.error("Save failed:", e);
                alert("Fehler beim Speichern: " + e.message);
            }

            sessionStartTime = 0;
        }

        function showRideHistory() {
            // Hide settings modal if it's open
            const settingsModal = document.getElementById('settingsModal');
            if (settingsModal && !settingsModal.classList.contains('hidden')) {
                hideModal('settingsModal');
            }
            renderRideHistory();
            showModal('rideHistoryModal');
        }

        function clearRideHistory() {
            if (confirm("Wirklich alles löschen?")) {
                localStorage.removeItem('motoRideLogs_v1');
                renderRideHistory();
            }
        }

        function renderRideHistory() {
            const list = document.getElementById('rideHistoryList');
            if (!list) return;
            list.innerHTML = '';

            let logs = [];
            try { logs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]'); } catch (e) { }

            if (logs.length === 0) {
                list.innerHTML = '<div class="text-center text-slate-500 mt-10 italic">Keine Fahrten gespeichert.</div>';
                return;
            }

            // Reverse order (newest first)
            logs.slice().reverse().forEach(log => {
                const durMin = Math.floor(log.duration / 60000);
                const durSec = Math.floor((log.duration % 60000) / 1000);

                // Calculate Time Range
                // log.id is typically Date.now() at save time (End Time)
                const endTime = new Date(log.id);
                const startTime = new Date(log.id - log.duration);
                const formatTime = (d) => d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                const timeRange = `${formatTime(startTime)} - ${formatTime(endTime)} `;

                const displayName = log.name ? log.name : `${log.date} • ${timeRange} `;
                const displayMeta = log.name ? `${log.date} • ${timeRange} ` : '';

                // Distance Text
                const distKm = log.stats.distance ? (log.stats.distance / 1000).toFixed(1) : "0.0";

                const el = document.createElement('div');
                // Removed 'hover:bg-slate-800' -> using 'ride-item-hover' via CSS
                el.className = "bg-slate-800/50 rounded-xl p-3 border border-slate-700/50 cursor-pointer ride-item-hover transition active:scale-95";
                el.onclick = () => openRideDetail(log.id); // OPEN DETAIL ON CLICK

                el.innerHTML = `
                    <div class="flex justify-between items-start mb-2 border-b border-slate-700/50 pb-2 pointer-events-none">
                        <div class="flex-1">
                             <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-white">${displayName}</span>
                             </div>
                            ${displayMeta ? `<div class="text-[10px] text-slate-400 font-mono">${displayMeta}</div>` : ''}
                            
                            <div class="text-xs text-slate-300 font-bold flex items-center gap-2 mt-1">
                                <span>${log.weather.desc}</span> 
                                <span class="bg-blue-500/20 text-blue-300 px-1.5 rounded text-[10px]">${log.weather.temp}°</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-xs text-slate-500 font-mono">${durMin}m ${durSec}s</div>
                            ${log.stats.distance ? `<div class="text-[10px] text-blue-400 font-bold">${distKm}km</div>` : ''}
                        </div>
                    </div>
                <div class="grid grid-cols-4 gap-2 text-center pointer-events-none">
                    <div>
                        <div class="text-[8px] text-slate-500 uppercase">Max Speed</div>
                        <div class="text-sm font-bold text-white">${log.stats.maxSpeed} <span class="text-[9px] text-slate-400 font-normal">km/h</span></div>
                    </div>
                    <div>
                        <div class="text-[8px] text-slate-500 uppercase">Max G</div>
                        <div class="text-sm font-bold text-white">${log.stats.maxG}</div>
                    </div>
                    <div>
                        <div class="text-[8px] text-slate-500 uppercase">Lean L</div>
                        <div class="text-sm font-bold text-blue-400">${log.stats.leanL}°</div>
                    </div>
                    <div>
                        <div class="text-[8px] text-slate-500 uppercase">Lean R</div>
                        <div class="text-sm font-bold text-blue-400">${log.stats.leanR}°</div>
                    </div>
                </div>
            `;
                list.appendChild(el);
            });
            lucide.createIcons();
        }

        // --- NEW: DETAIL VIEW LOGIC ---
        let currentDetailId = null;

        function openRideDetail(id) {
            let logs = [];
            try { logs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]'); } catch (e) { }
            const log = logs.find(l => l.id === id);
            if (!log) return;

            currentDetailId = id;

            // Fill Data
            safeSetText('detailDate', log.date);
            safeSetText('detailTitle', log.name || "Fahrt");

            const durMin = Math.floor(log.duration / 60000);
            const mLabel = durMin + " Min";

            // Time Range Calc
            const endTime = new Date(log.id);
            const startTime = new Date(log.id - log.duration);
            const formatTime = (d) => d.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const timeRange = `${formatTime(startTime)} - ${formatTime(endTime)} `;

            safeSetText('detailTimeDuration', `${timeRange} • ${mLabel}`);

            safeSetText('detailMaxSpeed', log.stats.maxSpeed);
            safeSetText('detailMaxG', log.stats.maxG);
            safeSetText('detailLeanL', log.stats.leanL + "°");
            safeSetText('detailLeanR', log.stats.leanR + "°");

            // Distance
            const dist = log.stats.distance ? (log.stats.distance / 1000).toFixed(1) : "0.0";
            safeSetText('detailDistance', dist);

            // Weather
            safeSetText('detailTemp', log.weather.temp);
            safeSetText('detailWeather', log.weather.desc);

            const m = document.getElementById('rideDetailModal');
            if (m) {
                m.classList.remove('hidden');
                setTimeout(() => m.classList.remove('opacity-0'), 10);
            }

            // Wire buttons
            const btnRename = document.getElementById('btnDetailRename');
            if (btnRename) btnRename.onclick = () => {
                renameRideLog(id);
                // Update title immediately
                setTimeout(() => {
                    // Refetch
                    let rlogs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]');
                    const rlog = rlogs.find(l => l.id === id);
                    if (rlog) safeSetText('detailTitle', rlog.name || "Fahrt");

                    // Also refresh list behind
                    renderRideHistory();
                }, 500);
            };

            const btnDelete = document.getElementById('btnDetailDelete');
            if (btnDelete) btnDelete.onclick = () => deleteSingleLog(id);
        }

        function closeRideDetail() {
            const m = document.getElementById('rideDetailModal');
            if (m) {
                m.classList.add('opacity-0');
                setTimeout(() => m.classList.add('hidden'), 300);
            }
        }

        function deleteSingleLog(id) {
            if (confirm("Diesen Eintrag löschen?")) {
                let logs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]');
                logs = logs.filter(l => l.id !== id);
                localStorage.setItem('motoRideLogs_v1', JSON.stringify(logs));

                closeRideDetail();
                renderRideHistory();
            }
        }

        function renameRideLog(id) {
            let logs = [];
            try { logs = JSON.parse(localStorage.getItem('motoRideLogs_v1') || '[]'); } catch (e) { }
            const log = logs.find(l => l.id === id);
            if (!log) return;

            const newName = prompt("Name für diese Fahrt:", log.name || "");
            if (newName !== null) {
                log.name = newName;
                localStorage.setItem('motoRideLogs_v1', JSON.stringify(logs));
                renderRideHistory();
            }
        }

        // Attempt auto-start on load for non-iOS
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission !== 'function') {
            window.addEventListener('deviceorientation', handleMotoOrientation);
            window.addEventListener('devicemotion', handleMotion); // NEW
            // document.getElementById('btnMotoStart').style.display = 'none';
        }

        // --- MOTO SENSOR LOGIC (UNIFIED) ---
        let gpsRetryMode = false; // NEW: Track high vs low accuracy

        function requestMotoPermission() {
            const reqMotion = () => {
                if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') return DeviceMotionEvent.requestPermission();
                return Promise.resolve('granted');
            };
            const reqOrient = () => {
                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') return DeviceOrientationEvent.requestPermission();
                return Promise.resolve('granted');
            };

            reqOrient().then(r => reqMotion()).then(r => {
                startMotoTracking();
            }).catch(e => {
                alert("Sensoren abgelehnt? GPS läuft trotzdem!");
                startMotoTracking();
            });
        }

        function startMotoTracking() {
            document.getElementById('btnMotoStart').classList.add('hidden');
            document.getElementById('btnMotoStop').classList.remove('hidden');
            document.getElementById('motoGpsStatus').classList.remove('hidden');
            const gpsDot = document.getElementById('motoGpsDot');
            const gpsText = document.getElementById('motoGpsText');

            // MAP INIT
            initMotoMap();
            try { lockOrientation(); } catch (e) { }
            try { navigator.wakeLock.request('screen'); } catch (e) { }

            // Reset Session
            sessionStartTime = Date.now();
            sessionMaxSpeed = 0; sessionMaxG = 0; sessionDistance = 0;
            ridePathLatLons = [];
            gpsRetryMode = false;

            // 1. FAST FIX (Get location IMMEDIATELY via Network)
            if (gpsText) { gpsText.innerText = "Suche (Schnell)..."; gpsDot.className = "w-2 h-2 rounded-full bg-orange-500 animate-pulse"; }

            navigator.geolocation.getCurrentPosition(
                pos => handleMotoPosition(pos, "FAST"),
                err => console.log("Fast Fix failed (OK, waiting for Sat)", err),
                { enableHighAccuracy: false, timeout: 3000, maximumAge: 60000 }
            );

            // 2. SATELLITE WATCH (Precision)
            startSatWatch(true);

            // Motion Sensors (Compass + G + Lean)
            window.addEventListener('deviceorientation', handleCompass); // Map Rotation
            window.addEventListener('deviceorientation', handleMotoOrientation); // Lean Angle
            window.addEventListener('devicemotion', handleMotion);
        }

        function handleCompass(e) {
            // Handle Map Rotation based on Phone Heading
            let heading = 0;

            // iOS vs Android
            if (e.webkitCompassHeading) {
                heading = e.webkitCompassHeading;
            } else if (e.alpha) {
                heading = 360 - e.alpha; // Android (roughly)
            }

            const mapContainer = document.getElementById('motoLiveMap');
            if (mapContainer && heading) {
                mapContainer.style.transform = `translate(-50%, -50%) rotate(${-heading}deg)`;
            }
        }

        function startSatWatch(highAcc) {
            if (motoWatchId) navigator.geolocation.clearWatch(motoWatchId);
            const gpsText = document.getElementById('motoGpsText');
            if (gpsText) gpsText.innerText = highAcc ? "Suche (Sat)..." : "Suche (Netz)...";

            motoWatchId = navigator.geolocation.watchPosition(
                pos => handleMotoPosition(pos, "WATCH"),
                err => {
                    console.warn("GPS Watch Error", err.code);
                    const txt = document.getElementById('motoGpsText');
                    // Fallback Logic
                    if ((err.code === 2 || err.code === 3) && !gpsRetryMode) {
                        gpsRetryMode = true;
                        if (txt) txt.innerText = "Versuche Netz...";
                        setTimeout(() => startSatWatch(false), 200); // Switch to Low Acc
                    } else {
                        if (txt) txt.innerText = "Kein Signal";
                    }
                },
                { enableHighAccuracy: highAcc, timeout: 10000, maximumAge: 0 }
            );
        }

        function handleMotoPosition(pos, source) {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const spd = pos.coords.speed;
            const acc = pos.coords.accuracy;

            currentLat = lat; currentLon = lon;

            // Update Status Badge
            const gpsDot = document.getElementById('motoGpsDot');
            const gpsText = document.getElementById('motoGpsText');

            if (acc < 20) {
                gpsDot.className = "w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
                gpsText.innerText = `GPS OK (${Math.round(acc)}m)`;
                gpsText.className = "text-[10px] font-bold text-emerald-400 uppercase tracking-wider";
            } else {
                gpsDot.className = "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
                gpsText.innerText = source === "FAST" ? "Netz OK (Warte...)" : `Signal schwach (${Math.round(acc)}m)`;
                gpsText.className = "text-[10px] font-bold text-yellow-500 uppercase tracking-wider";
            }

            // Map Update
            if (motoMap && motoMarker) {
                motoMarker.setLatLng([lat, lon]);

                // Strict Centering
                // Strict Centering (Preserve Zoom)
                motoMap.setView([lat, lon], motoMap.getZoom(), { animate: true });

                // ROTATION: Handled by Compass (handleCompass) for smoother "Phone" orientation
                // But if no compass, we could fallback to GPS heading.
                // For now, let's let handleCompass take priority.
            }

            // Speed Update
            let kmh = 0;
            if (spd && spd > 0.5) kmh = spd * 3.6;
            document.getElementById('motoSpeedDisplay').innerText = Math.round(kmh);
            if (kmh > sessionMaxSpeed) sessionMaxSpeed = kmh;

            // Distance (Simple)
            // ... (Omitting Distance calc for brevity here, logic was in old duplicate block, ideally revived if needed)
            // Ideally we re-insert that small logic:
            if (!window.lastMotoPosTime) window.lastMotoPosTime = 0;
            const now = Date.now();
            if (window.lastMotoPosTime > 0 && spd !== null) {
                const dt = (now - window.lastMotoPosTime) / 1000;
                if (dt < 10) sessionDistance += spd * dt;
            }
            window.lastMotoPosTime = now;
        }

        function stopMotoTracking() {
            document.getElementById('btnMotoStart').classList.remove('hidden');
            document.getElementById('btnMotoStop').classList.add('hidden');
            document.getElementById('motoGpsStatus').classList.add('hidden');

            if (motoWatchId) navigator.geolocation.clearWatch(motoWatchId);
            window.removeEventListener('deviceorientation', handleCompass); // STOP Compass
            window.removeEventListener('deviceorientation', handleMotoOrientation); // STOP Lean
            window.removeEventListener('devicemotion', handleMotion);

            saveRideLog();
            try { unlockOrientation(); } catch (e) { }
            try { if (navigator.wakeLock) navigator.wakeLock.release ? navigator.wakeLock.release() : null; } catch (e) { }
        }

        // SMOOTHING VARS
        let smoothAx = 0, smoothAy = 0, smoothAz = 0;
        const alpha = 0.15; // Low-Pass Filter Factor

        function handleMotion(event) {
            // Raw Inputs
            const ay = event.acceleration.y || 0;
            const ax = event.acceleration.x || 0;
            const az = event.acceleration.z || 0;

            // Low-Pass Filter operation
            smoothAx = smoothAx + alpha * (ax - smoothAx);
            smoothAy = smoothAy + alpha * (ay - smoothAy);
            smoothAz = smoothAz + alpha * (az - smoothAz);

            // 1. Total G-Force (Linear Acceleration Magnitude)
            // event.acceleration EXCLUDES gravity, so 0 when still.
            // No need to subtract 1G again.
            const g = Math.sqrt(smoothAx * smoothAx + smoothAy * smoothAy + smoothAz * smoothAz) / 9.81;

            // Update Session Max
            if (g > sessionMaxG) sessionMaxG = g;

            const gForceBar = document.getElementById('gForceBar');
            const gForceVal = document.getElementById('gForceVal');

            if (gForceBar && gForceVal) {
                // UI: Acceleration / Braking (longitudinal G)
                // Using Smoothed Y
                // Phone Orientation assumption: Top forward.
                // Braking -> Phone tends to continue forward -> +Y acceleration (if excluding gravity) ? 
                // Let's rely on previous polarity logic: "User said Accel shows as Brake -> Inverted val".

                const val = -(smoothAy / 9.81);

                // Bar Width Logic
                let barPct = Math.min((Math.abs(val) / 0.8) * 50, 50);

                if (val > 0.05) {
                    // Accel (Green/Right)
                    gForceBar.style.left = '50%';
                    gForceBar.style.width = barPct + '%';
                    gForceBar.className = 'absolute top-0 bottom-0 bg-emerald-500 transition-all duration-75 ease-out';
                } else if (val < -0.05) {
                    // Brake (Red/Left)
                    gForceBar.style.left = (50 - barPct) + '%';
                    gForceBar.style.width = barPct + '%';
                    gForceBar.className = 'absolute top-0 bottom-0 bg-red-500 transition-all duration-75 ease-out';
                } else {
                    gForceBar.style.width = '0%';
                }

                // Display Total G Magnitude
                gForceVal.innerText = g.toFixed(2) + ' G';
            }
        }



        // --- ORIENTATION LOCK ---
        async function lockOrientation() {
            try {
                if (screen.orientation && screen.orientation.lock) {
                    await screen.orientation.lock('portrait');
                    console.log("Orientation locked to portrait");
                }
            } catch (e) {
                // Fails on some browsers if not fullscreen, just log it
                console.warn("Orientation lock failed (likely needs fullscreen):", e);
            }
        }

        function unlockOrientation() {
            try {
                if (screen.orientation && screen.orientation.unlock) {
                    screen.orientation.unlock();
                    console.log("Orientation unlocked");
                }
            } catch (e) {
                console.warn("Orientation unlock failed:", e);
            }
        }

        // --- VIEW NAVIGATION ---
        function scrollToMoto() {
            document.getElementById('view-moto').scrollIntoView({ behavior: 'smooth' });
            // Init map slightly delayed so layout is ready
            setTimeout(initMotoMap, 500);
            // Attempt lock (might fail if not triggered by direct interaction, but try anyway)
            lockOrientation();
        }


        function scrollToWeather() {
            document.getElementById('view-weather').scrollIntoView({ behavior: 'smooth' });
            unlockOrientation();
        }

        // FIX: Re-center map on resize/orientation change to prevent "Spinning" / Off-center
        window.addEventListener('resize', () => {
            if (motoMap) {
                motoMap.invalidateSize();
                if (motoMarker) {
                    const ll = motoMarker.getLatLng();
                    motoMap.setView(ll, motoMap.getZoom(), { animate: false });
                }
            }
        });
    </script>
</body>

</html>
