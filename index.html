<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="apple-mobile-web-app-title" content="Wetter">
    
    <!-- NEUES ICON (Hochauflösend von Icons8, mit Cache-Buster ?v=2) -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    
    <title>Wetter Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: 1rem; padding-right: 1rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: white; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3b82f6; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; }
        .radar-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 50; background: #0f172a; border-radius: 0 !important; padding: env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 40px) 0; margin: 0 !important; }
        .live-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .hour-card-active { background-color: rgba(59, 130, 246, 0.2) !important; border-color: rgba(59, 130, 246, 0.8) !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .modal-overlay { cursor: pointer; }
        .modal-content { cursor: default; }
        #suggestionsList { z-index: 100 !important; }
        
        /* Warn-Animation */
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="flex flex-col items-center">

    <main class="w-full max-w-lg space-y-4 pt-4 pb-10">
        
        <div class="glass-panel rounded-2xl p-4 shadow-xl z-20 relative">
            <div class="flex justify-between items-center mb-3">
                <!-- HIER GEÄNDERT: Sichtbarer Name -->
                <h1 class="text-sm font-bold text-blue-200 uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="bike" size="16"></i> Wetter
                </h1>
                <button onclick="enableNotifications()" id="notifyBtn" class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative">
                    <i data-lucide="bell" size="18"></i>
                    <span id="notifyBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-blue-500 rounded-full"></span>
                </button>
            </div>

            <form onsubmit="event.preventDefault(); searchCity();" class="flex gap-2 relative">
                <div class="relative flex-grow">
                    <input type="search" id="cityInput" placeholder="Stadt eingeben..." class="w-full bg-slate-800/50 border border-slate-600 rounded-xl py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition appearance-none" autocomplete="off">
                    <div id="suggestionsList" class="hidden absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto"></div>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="search"></i></button>
                <button type="button" onclick="locateMe()" class="bg-emerald-600 hover:bg-emerald-500 active:bg-emerald-700 text-white p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="map-pin"></i></button>
            </form>
            
            <div id="cityName" class="text-xl font-bold mt-4 text-center tracking-wide text-blue-100">--</div>
            <div id="timeLabel" class="text-xs text-slate-400 text-center uppercase tracking-wider mb-1 font-semibold opacity-0 transition-opacity duration-300">Aktuell</div>
            <div id="errorMessage" class="hidden text-red-400 text-center text-sm mt-2 font-semibold bg-red-500/10 p-2 rounded-lg border border-red-500/20">Stadt nicht gefunden.</div>
        </div>

        <div id="loadingIndicator" class="hidden flex justify-center py-10"><div class="loader"></div></div>

        <!-- WARN CONTAINER -->
        <div id="warningContainer" class="hidden w-full max-w-lg animate-fade-in"></div>

        <div id="weatherContent" class="hidden space-y-4 animate-fade-in">
            <div class="grid grid-cols-2 gap-4">
                <div onclick="showDailyDetails()" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 relative group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="maximize-2" size="12"></i></div>
                    <div id="weatherIconContainer" class="mb-1 text-blue-300"><i data-lucide="cloud" size="40"></i></div>
                    <div class="text-4xl font-bold mb-1"><span id="temperature">--</span>°</div>
                    <div id="weatherDesc" class="text-xs text-slate-300">--</div>
                    <div class="flex gap-4 text-sm font-semibold text-blue-200 mt-2 mb-2">
                        <span class="flex items-center"><i data-lucide="arrow-up" size="14" class="mr-1 text-red-400"></i><span id="tempMax">--</span>°</span>
                        <span class="flex items-center"><i data-lucide="arrow-down" size="14" class="mr-1 text-blue-400"></i><span id="tempMin">--</span>°</span>
                    </div>
                    <div class="flex gap-3 mt-1 text-xs text-slate-400">
                        <span class="flex items-center gap-1"><i data-lucide="wind" size="12"></i> <span id="windSpeed">--</span></span>
                        <span class="flex items-center gap-1"><i data-lucide="droplets" size="12"></i> <span id="humidity">--</span></span>
                    </div>
                </div>
                <div onclick="showMotoDetails()" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="info" size="12"></i></div>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Moto Index</h3>
                    <div id="motoScoreCircle" class="w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner">
                        <span id="motoScoreValue" class="text-2xl font-black">--</span>
                    </div>
                    <div id="motoScoreText" class="text-xs font-semibold mb-2">--</div>
                    <div class="border-t border-slate-600/50 w-full pt-2 mt-1">
                        <div class="flex justify-between items-center px-1 text-xs">
                            <span class="text-slate-400">Heute Ø</span>
                            <span id="dailyScoreValue" class="font-bold text-blue-100">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="radarCard" class="glass-panel rounded-2xl overflow-hidden shadow-lg transition-all duration-300 flex flex-col">
                <div class="bg-slate-800/80 p-3 flex justify-between items-center border-b border-slate-700 shrink-0">
                    <h3 class="text-sm font-semibold flex items-center gap-2">
                        <i data-lucide="map" size="16" class="text-blue-400"></i>
                        <span id="radarTitle">Regen (Vorschau)</span>
                    </h3>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleLayerMenu()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation flex items-center gap-2"><i data-lucide="layers" size="16"></i></button>
                        <button onclick="toggleFullscreen()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation"><i id="fullscreenIcon" data-lucide="maximize-2" size="16"></i></button>
                    </div>
                </div>
                <div id="radarFrameContainer" class="relative w-full h-96 bg-slate-900 transition-all duration-300 grow">
                    <iframe id="radarFrame" class="w-full h-full border-none" src=""></iframe>
                    <div class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700/50 flex items-center shadow-lg pointer-events-none z-10">
                        <div class="live-dot"></div>
                        <span class="text-[10px] text-slate-400 mr-2 uppercase tracking-wider">Live</span>
                        <span id="liveClock" class="text-xs font-mono font-bold text-white tracking-wider">--:--</span>
                    </div>
                    <div id="radarOverlay" class="absolute inset-0 pointer-events-none border border-slate-700/20"></div>
                </div>
            </div>

            <div id="timelineCard" class="glass-panel rounded-2xl p-4 transition-all duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300"><i data-lucide="clock" size="16"></i> Vorhersage</h3>
                    <button onclick="toggleLegend()" class="text-slate-400 hover:text-white transition p-1 bg-slate-800/50 rounded-full hover:bg-slate-700"><i data-lucide="info" size="16"></i></button>
                </div>
                <div id="hourlyContainer" class="flex overflow-x-auto gap-3 pb-2 custom-scrollbar snap-x touch-pan-x"></div>
            </div>
        </div>
        
        <!-- Footer & Start Prompt -->
        <div id="startPrompt" class="text-center py-20 text-slate-500"><i data-lucide="bike" class="mx-auto mb-4 h-16 w-16 opacity-30"></i><p>Standort wird ermittelt...</p></div>
        
        <!-- VERSION FOOTER -->
        <div class="text-center text-[10px] text-slate-600 mt-4 pb-2 opacity-50">
            v1.0 • n.w.
        </div>
    </main>

    <!-- Modals (Same as before) -->
    <div id="dailyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="document.getElementById('dailyDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-6 text-blue-100 flex items-center gap-2"><i data-lucide="calendar" size="20"></i> Tages-Infos (Heute)</h3>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunrise" size="12"></i> Aufgang</div><div id="detailSunrise" class="font-bold">--:--</div></div>
                <div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunset" size="12"></i> Untergang</div><div id="detailSunset" class="font-bold">--:--</div></div>
            </div>
            <div class="mb-2"><h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">Luftqualität</h4><div class="bg-slate-800/50 p-4 rounded-xl"><div class="flex justify-between items-center mb-2"><span class="text-sm text-slate-300">AQI (Europa)</span><span id="detailAqiVal" class="font-bold text-white">--</span></div><div class="w-full bg-slate-700 rounded-full h-2 mb-3"><div id="detailAqiBar" class="bg-green-500 h-2 rounded-full" style="width: 0%"></div></div><div id="detailAqiText" class="text-xs text-center text-slate-400 italic">Wird geladen...</div></div></div>
        </div>
    </div>

    <div id="motoDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="document.getElementById('motoDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-2 text-white flex items-center gap-2"><i data-lucide="bike" size="24" class="text-blue-400"></i> Moto Analyse</h3>
            <p class="text-xs text-slate-400 mb-6">Warum ist der Score so?</p>
            <div id="motoAnalysisList" class="space-y-3"></div>
        </div>
    </div>

    <div id="hourlyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-xs rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="closeHourlyModal()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <div class="text-center mb-4"><div id="modalTime" class="text-lg font-bold text-blue-200">--:--</div><div id="modalDesc" class="text-sm text-slate-400">--</div></div>
            <div class="flex flex-col items-center justify-center mb-6"><div id="modalIcon" class="mb-2 transform scale-125"></div><div class="text-5xl font-bold tracking-tighter"><span id="modalTemp">--</span>°</div></div>
            <div class="grid grid-cols-3 gap-2 mb-4 text-center"><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="wind" size="12" class="inline"></i> Wind</div><div id="modalWind" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="umbrella" size="12" class="inline"></i> Regen</div><div id="modalRain" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="droplets" size="12" class="inline"></i> Feuchte</div><div id="modalHum" class="font-bold text-sm">--</div></div></div>
            <div id="modalScoreBg" class="rounded-xl p-3 border flex items-center justify-between"><span class="font-bold uppercase text-xs tracking-wider">Moto Index</span><div class="text-right"><span id="modalScoreVal" class="text-xl font-black">--</span><span class="text-xs opacity-80">/10</span></div></div>
        </div>
    </div>

    <div id="legendModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative max-h-[85vh] overflow-y-auto custom-scrollbar shadow-2xl border-slate-600/50 modal-content">
            <button onclick="toggleLegend()" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-blue-100 flex items-center gap-2"><i data-lucide="cloud-sun" size="20"></i> Wetter-Legende</h3>
            <div class="grid grid-cols-1 gap-2 text-sm text-slate-300">
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="sun" class="text-yellow-400 w-6 h-6"></i> <span>Klar / Heiter</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-sun" class="text-blue-200 w-6 h-6"></i> <span>Wolkig / Bedeckt</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-fog" class="text-slate-400 w-6 h-6"></i> <span>Nebel</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-drizzle" class="text-blue-300 w-6 h-6"></i> <span>Nieselregen</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-rain" class="text-blue-400 w-6 h-6"></i> <span>Regen</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-rain-wind" class="text-blue-500 w-6 h-6"></i> <span>Schauer / Sturm</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="snowflake" class="text-white w-6 h-6"></i> <span>Schnee / Eis</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-lightning" class="text-yellow-500 w-6 h-6"></i> <span>Gewitter</span></div>
                <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-hail" class="text-white w-6 h-6"></i> <span>Hagel / Eisregen</span></div>
            </div>
        </div>
    </div>

    <!-- LAYER MENU -->
    <div id="layerMenuModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="toggleLayerMenu()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="layers" size="20"></i> Kartenart wählen</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="selectLayer('rain', 'Regen (Vorschau)')" class="flex flex-col items-center justify-center p-4 bg-slate-800 hover:bg-blue-600 rounded-xl transition gap-2 border border-slate-700 hover:border-blue-400 group"><i data-lucide="cloud-rain" size="24" class="text-blue-300 group-hover:text-white"></i><span class="text-sm font-medium">Regen (Vorschau)</span><span class="text-[10px] text-slate-400 group-hover:text-blue-200">Mit Zukunft</span></button>
                <button onclick="selectLayer('radar', 'Radar (Live/Ist)')" class="flex flex-col items-center justify-center p-4 bg-slate-800 hover:bg-blue-600 rounded-xl transition gap-2 border border-slate-700 hover:border-blue-400 group"><i data-lucide="radar" size="24" class="text-yellow-300 group-hover:text-white"></i><span class="text-sm font-medium">Radar (Live/Ist)</span><span class="text-[10px] text-slate-400 group-hover:text-blue-200">Vergangenheit</span></button>
                <button onclick="selectLayer('wind', 'Wind')" class="flex flex-col items-center justify-center p-4 bg-slate-800 hover:bg-blue-600 rounded-xl transition gap-2 border border-slate-700 hover:border-blue-400"><i data-lucide="wind" size="24" class="text-teal-300"></i><span class="text-sm font-medium">Wind</span></button>
                <button onclick="selectLayer('clouds', 'Wolken')" class="flex flex-col items-center justify-center p-4 bg-slate-800 hover:bg-blue-600 rounded-xl transition gap-2 border border-slate-700 hover:border-blue-400"><i data-lucide="cloud" size="24" class="text-gray-300"></i><span class="text-sm font-medium">Wolken</span></button>
                <button onclick="selectLayer('temp', 'Temperatur')" class="flex flex-col items-center justify-center p-4 bg-slate-800 hover:bg-blue-600 rounded-xl transition gap-2 border border-slate-700 hover:border-blue-400"><i data-lucide="thermometer" size="24" class="text-red-400"></i><span class="text-sm font-medium">Temperatur</span></button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // State
        let currentLat = 51.1657; let currentLon = 10.4515;
        let currentRadarType = 'rain'; let currentRadarTitle = 'Regen (Vorschau)'; 
        let lastWeatherData = null;
        let isFullscreen = false; let debounceTimer; let clockInterval;

        const cityInput = document.getElementById('cityInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const warningContainer = document.getElementById('warningContainer');
        
        async function enableNotifications() {
            if (!("Notification" in window)) { alert("Nicht unterstützt."); return; }
            if (Notification.permission === "granted") { alert("Aktiv!"); checkAndSendNotification(10); } 
            else if (Notification.permission !== "denied") {
                const permission = await Notification.requestPermission();
                if (permission === "granted") document.getElementById('notifyBadge').classList.remove('hidden');
            } else alert("Blockiert.");
        }
        function checkAndSendNotification(score) {
            if (Notification.permission === "granted" && score >= 8) {
                const lastNotified = sessionStorage.getItem('lastNotificationTime');
                const now = Date.now();
                if (!lastNotified || (now - lastNotified > 4 * 60 * 60 * 1000)) {
                    new Notification("Biker-Wetter!", { body: `Score: ${score}/10`, icon: "https://cdn-icons-png.flaticon.com/512/3799/3799969.png" });
                    sessionStorage.setItem('lastNotificationTime', now);
                }
            }
        }
        if ("Notification" in window && Notification.permission === "granted") document.getElementById('notifyBadge').classList.remove('hidden');

        function checkWarnings(cur) {
            let warning = null; let colorClass = "bg-yellow-500/80 border-yellow-400"; let icon = "alert-triangle";
            if (cur.weather_code >= 95) { warning = "GEWITTER-WARNUNG"; colorClass = "bg-red-600/90 border-red-400"; icon = "cloud-lightning"; } 
            else if (cur.wind_speed_10m >= 75) { warning = "STURM-WARNUNG"; colorClass = "bg-red-600/90 border-red-400"; icon = "wind"; } 
            else if (cur.wind_speed_10m >= 50) { warning = "Starke Windböen"; colorClass = "bg-orange-500/80 border-orange-400"; icon = "wind"; } 
            else if (cur.temperature_2m <= 3) { warning = "Glättegefahr"; colorClass = "bg-blue-600/80 border-blue-400"; icon = "snowflake"; } 
            else if (cur.precipitation >= 5) { warning = "Starkregen"; colorClass = "bg-blue-700/80 border-blue-400"; icon = "cloud-rain"; }
            if (warning) { warningContainer.innerHTML = `<div class="w-full ${colorClass} border p-3 rounded-xl flex items-center justify-between shadow-lg animate-pulse-slow mb-4 text-white"><div class="flex items-center gap-3 font-bold"><i data-lucide="${icon}" size="24"></i><span>${warning}</span></div><i data-lucide="alert-circle" size="20"></i></div>`; warningContainer.classList.remove('hidden'); lucide.createIcons(); } 
            else { warningContainer.innerHTML = ""; warningContainer.classList.add('hidden'); }
        }

        function toggleLegend() { document.getElementById('legendModal').classList.toggle('hidden'); lucide.createIcons(); }
        function closeHourlyModal() { document.getElementById('hourlyDetailsModal').classList.add('hidden'); }
        function toggleLayerMenu() { document.getElementById('layerMenuModal').classList.toggle('hidden'); lucide.createIcons(); }
        async function showDailyDetails() { if(!lastWeatherData) return; const daily = lastWeatherData.daily; document.getElementById('detailSunrise').innerText = new Date(daily.sunrise[0]).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); document.getElementById('detailSunset').innerText = new Date(daily.sunset[0]).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); try { const res = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${currentLat}&longitude=${currentLon}&current=european_aqi,pm10,pm2_5`); const aqData = await res.json(); const aqi = aqData.current.european_aqi; document.getElementById('detailAqiVal').innerText = aqi; let color = "bg-green-500", text = "Sehr Gut", width = "20%"; if(aqi > 20) { color = "bg-teal-400"; text = "Gut"; width="40%"; } if(aqi > 40) { color = "bg-yellow-400"; text = "Mittel"; width="60%"; } if(aqi > 60) { color = "bg-orange-500"; text = "Schlecht"; width="80%"; } if(aqi > 80) { color = "bg-red-600"; text = "Sehr Schlecht"; width="100%"; } const bar = document.getElementById('detailAqiBar'); bar.className = `h-2 rounded-full ${color}`; bar.style.width = width; document.getElementById('detailAqiText').innerText = text; } catch(e) { document.getElementById('detailAqiText').innerText = "Nicht verfügbar"; } document.getElementById('dailyDetailsModal').classList.remove('hidden'); lucide.createIcons(); }
        function showMotoDetails() { if(!lastWeatherData) return; const cur = lastWeatherData.current; const analysis = calculateMotoAnalysis(cur.temperature_2m, cur.wind_speed_10m, cur.precipitation, cur.is_day, cur.weather_code); const list = document.getElementById('motoAnalysisList'); list.innerHTML = ""; analysis.pros.forEach(p => { list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><i data-lucide="check-circle" class="text-emerald-400 flex-shrink-0"></i><span class="text-sm text-emerald-100">${p}</span></div>`; }); analysis.cons.forEach(c => { list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-red-500/10 border border-red-500/30 rounded-xl"><i data-lucide="alert-triangle" class="text-red-400 flex-shrink-0"></i><span class="text-sm text-red-100">${c}</span></div>`; }); if(analysis.pros.length === 0 && analysis.cons.length === 0) list.innerHTML = `<div class="text-center text-slate-400 italic">Keine besonderen Vorkommnisse.</div>`; document.getElementById('motoDetailsModal').classList.remove('hidden'); lucide.createIcons(); }
        function calculateMotoAnalysis(temp, wind, rain, isDay, code) { let pros = [], cons = []; if(temp >= 15 && temp <= 28) pros.push("Perfekte Temperatur"); else if(temp < 5) cons.push("Eisgefahr & Kälte (< 5°C)"); else if(temp < 10) cons.push("Ziemlich kalt (< 10°C)"); else if(temp > 30) cons.push("Hitze (> 30°C)"); if(wind < 15) pros.push("Kaum Wind"); else if(wind > 40) cons.push("Starke Böen (> 40km/h)"); else if(wind > 60) cons.push("Sturmwarnung!"); if(rain > 0) cons.push("Nasse Straße möglich"); if(code < 3) pros.push("Gute Sicht"); if(code >= 51) cons.push("Niederschlag aktiv"); if(isDay === 0) cons.push("Dunkelheit (Nachtfahrt)"); else pros.push("Tageslicht"); return { pros, cons }; }
        function calculateMotoScore(temp, wind, rain, isDay, code) { let score = 10, reason = "Perfekt"; if (temp < 0) { score -= 10; reason = "Eisgefahr"; } else if (temp < 5) { score -= 8; reason = "Zu kalt"; } else if (temp < 10) { score -= 5; reason = "Kalt"; } else if (temp > 35) { score -= 4; reason = "Hitze"; } if (code >= 51 && code <= 99) { if (code >= 95) { score -= 10; reason = "Gewitter"; } else if (code >= 66 && code <= 77) { score -= 9; reason = "Eis/Schnee"; } else if (code >= 61) { score -= 7; reason = "Regen"; } else { score -= 4; reason = "Niesel"; } } if (rain > 0.5) { score -= 5; reason = "Nass"; } if (wind > 60) { score -= 9; reason = "Sturm"; } else if (wind > 40) { score -= 5; reason = "Windig"; } else if (wind > 20) { score -= 2; } if (isDay === 0) { score -= 2; if(reason === "Perfekt") reason = "Nacht"; } return { score: Math.max(0, Math.min(10, score)), reason: reason }; }
        function calculateDailyScore(hourly) { const offsetMs = (lastWeatherData.utc_offset_seconds || 0) * 1000; let totalScore = 0; let count = 0; for (let i = 0; i < hourly.time.length; i++) { const timeMs = new Date(hourly.time[i]).getTime(); const pointDateStr = new Date(timeMs + offsetMs).toISOString().slice(0, 10); const nowDateStr = new Date(Date.now() + offsetMs).toISOString().slice(0, 10); if (pointDateStr !== nowDateStr) continue; if (hourly.is_day[i] === 1) { totalScore += calculateMotoScore(hourly.temperature_2m[i], hourly.wind_speed_10m[i], hourly.precipitation[i], hourly.is_day[i], hourly.weather_code[i]).score; count++; } } return count === 0 ? "--" : Math.round((totalScore / count) * 10) / 10; }
        function getScoreColor(score) { if (score >= 8) return { bg: "border-emerald-500 text-emerald-400", hex: "#10b981" }; if (score >= 5) return { bg: "border-yellow-500 text-yellow-400", hex: "#eab308" }; if (score >= 3) return { bg: "border-orange-500 text-orange-400", hex: "#f97316" }; return { bg: "border-red-500 text-red-400", hex: "#ef4444" }; }
        
        function updateMainValues(temp, wind, hum, rain, code, isDay, timeText, dayIndex = 0) { document.getElementById('temperature').innerText = Math.round(temp); document.getElementById('windSpeed').innerText = wind + " km/h"; document.getElementById('humidity').innerText = hum + "%"; const wInfo = getWeatherInfo(code); document.getElementById('weatherDesc').innerText = wInfo.t; document.getElementById('weatherIconContainer').innerHTML = `<i data-lucide="${wInfo.i}" class="w-12 h-12"></i>`; const scoreInfo = calculateMotoScore(temp, wind, rain, isDay, code); const scoreColor = getScoreColor(scoreInfo.score); const scoreEl = document.getElementById('motoScoreCircle'); scoreEl.className = `w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner ${scoreColor.bg}`; document.getElementById('motoScoreValue').innerText = scoreInfo.score; document.getElementById('motoScoreText').innerText = scoreInfo.reason; document.getElementById('timeLabel').innerText = "Aktuell"; document.getElementById('timeLabel').classList.remove('opacity-0'); if (lastWeatherData && lastWeatherData.daily && lastWeatherData.daily.temperature_2m_max[dayIndex] !== undefined) { document.getElementById('tempMax').innerText = Math.round(lastWeatherData.daily.temperature_2m_max[dayIndex]); document.getElementById('tempMin').innerText = Math.round(lastWeatherData.daily.temperature_2m_min[dayIndex]); } lucide.createIcons(); }
        function updateUI(name) { if(name) document.getElementById('cityName').innerText = name; const cur = lastWeatherData.current; updateMainValues(cur.temperature_2m, cur.wind_speed_10m, cur.relative_humidity_2m, cur.precipitation, cur.weather_code, cur.is_day, 0); checkWarnings(cur); checkAndSendNotification(calculateMotoScore(cur.temperature_2m, cur.wind_speed_10m, cur.precipitation, cur.is_day, cur.weather_code).score); document.getElementById('dailyScoreValue').innerText = calculateDailyScore(lastWeatherData.hourly) + " / 10"; renderHourly(); document.getElementById('startPrompt').classList.add('hidden'); document.getElementById('weatherContent').classList.remove('hidden'); loadingIndicator.classList.add('hidden'); updateRadar(); }
        async function fetchWeather(name, country) { loadingIndicator.classList.remove('hidden'); const url = `https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,precipitation,is_day&hourly=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&forecast_days=3&timezone=auto`; try { const res = await fetch(url); lastWeatherData = await res.json(); updateUI(name); } catch (e) { document.getElementById('errorMessage').classList.remove('hidden'); loadingIndicator.classList.add('hidden'); } }
        function locateMe(silent = false) { if (!navigator.geolocation) { if(!silent) alert("Kein GPS"); return; } document.getElementById('loadingIndicator').classList.remove('hidden'); navigator.geolocation.getCurrentPosition(pos => { currentLat = pos.coords.latitude; currentLon = pos.coords.longitude; fetchWeather("Mein Standort", ""); }, () => { document.getElementById('loadingIndicator').classList.add('hidden'); if(!silent) alert("Standort verweigert"); else { document.getElementById('startPrompt').innerText = "Tippe oben, um zu starten."; document.getElementById('startPrompt').classList.remove('hidden'); }}); }
        async function searchCity() { const val = cityInput.value.trim(); if (!val) return; suggestionsList.classList.add('hidden'); errorMessage.classList.add('hidden'); loadingIndicator.classList.remove('hidden'); try { const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=10&language=de&format=json`; const res = await fetch(url); if (!res.ok) throw new Error(); const data = await res.json(); if (!data.results || data.results.length === 0) throw new Error(); const loc = data.results[0]; currentLat = loc.latitude; currentLon = loc.longitude; fetchWeather(loc.name, loc.country); } catch (e) { loadingIndicator.classList.add('hidden'); errorMessage.classList.remove('hidden'); setTimeout(() => errorMessage.classList.add('hidden'), 3000); } }
        cityInput.addEventListener('input', (e) => { clearTimeout(debounceTimer); const val = e.target.value.trim(); if (val.length < 2) { suggestionsList.classList.add('hidden'); return; } debounceTimer = setTimeout(async () => { try { const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=5&language=de&format=json`); const data = await res.json(); suggestionsList.innerHTML = ''; if (data.results && data.results.length > 0) { data.results.forEach(place => { const div = document.createElement('div'); div.className = "p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50 last:border-0 flex flex-col"; div.innerHTML = `<span class="font-bold text-white text-sm">${place.name}</span><span class="text-xs text-slate-400">${[place.admin1, place.country].filter(Boolean).join(', ')}</span>`; div.onclick = () => { cityInput.value = place.name; suggestionsList.classList.add('hidden'); cityInput.blur(); currentLat = place.latitude; currentLon = place.longitude; fetchWeather(place.name, place.country); }; suggestionsList.appendChild(div); }); suggestionsList.classList.remove('hidden'); } else { suggestionsList.classList.add('hidden'); } } catch (e) {} }, 300); });
        document.addEventListener('click', (e) => { if (!cityInput.contains(e.target) && !suggestionsList.contains(e.target)) suggestionsList.classList.add('hidden'); });
        
        function selectHour(index) { const h = lastWeatherData.hourly; const temp = Math.round(h.temperature_2m[index]); const wind = h.wind_speed_10m[index]; const hum = h.relative_humidity_2m[index]; const rain = h.precipitation[index]; const code = h.weather_code[index]; const isDay = h.is_day[index]; const date = new Date(h.time[index]); const day = date.toLocaleDateString('de-DE', {weekday: 'long'}); const hour = date.getHours(); const timeStr = `${day} ${hour}:00`; const scoreInfo = calculateMotoScore(temp, wind, rain, isDay, code); const scoreColor = getScoreColor(scoreInfo.score); document.getElementById('modalTime').innerText = timeStr; document.getElementById('modalTemp').innerText = temp; document.getElementById('modalDesc').innerText = getWeatherInfo(code).t; document.getElementById('modalIcon').innerHTML = `<i data-lucide="${getWeatherInfo(code).i}" size="48"></i>`; document.getElementById('modalWind').innerText = wind + " km/h"; document.getElementById('modalRain').innerText = rain + " mm"; document.getElementById('modalHum').innerText = hum + "%"; document.getElementById('modalScoreVal').innerText = scoreInfo.score; document.getElementById('modalScoreBg').className = `rounded-xl p-3 border flex items-center justify-between ${scoreColor.bg} bg-slate-900/50`; document.getElementById('hourlyDetailsModal').classList.remove('hidden'); lucide.createIcons(); }
        function renderHourly() { const container = document.getElementById('hourlyContainer'); container.innerHTML = ''; const hourly = lastWeatherData.hourly; const offsetMs = (lastWeatherData.utc_offset_seconds || 0) * 1000; const currentHourISO = new Date(Date.now() + offsetMs).toISOString().slice(0, 13); let startIndex = hourly.time.findIndex(t => t.startsWith(currentHourISO)); if(startIndex === -1) startIndex = 0; for (let i = startIndex; i < startIndex + 24; i++) { if(!hourly.time[i]) break; const hour = new Date(hourly.time[i]).getHours(); const temp = Math.round(hourly.temperature_2m[i]); const color = getScoreColor(calculateMotoScore(temp, hourly.wind_speed_10m[i], hourly.precipitation[i], hourly.is_day[i], hourly.weather_code[i]).score); const icon = getWeatherInfo(hourly.weather_code[i]).i; const activeClass = (i === startIndex) ? "bg-slate-700 border-blue-500/50" : "bg-slate-800/50 border-transparent"; container.innerHTML += `<div onclick="selectHour(${i})" class="hour-card cursor-pointer snap-start flex-shrink-0 w-24 p-2 rounded-xl border ${activeClass} flex flex-col items-center justify-between h-32 hover:bg-slate-700 transition-all"><span class="text-xs text-slate-400 font-mono text-center leading-tight">${hour}:00</span><div class="text-blue-200"><i data-lucide="${icon}" size="20"></i></div><span class="text-sm font-bold">${temp}°</span><div class="w-full flex justify-center mt-1"><div class="h-1.5 w-8 rounded-full ${color.bg.replace('text-', 'bg-').split(' ')[1]}"></div></div></div>`; } lucide.createIcons(); }
        function getWeatherInfo(code) { const map = { 0:{t:"Klar",i:"sun"},1:{t:"Heiter",i:"sun"},2:{t:"Wolkig",i:"cloud-sun"},3:{t:"Bedeckt",i:"cloud"},45:{t:"Nebel",i:"cloud-fog"},48:{t:"Nebel",i:"cloud-fog"},51:{t:"Niesel",i:"cloud-drizzle"},53:{t:"Niesel",i:"cloud-drizzle"},55:{t:"Niesel",i:"cloud-drizzle"},56:{t:"Gefrier. Niesel",i:"cloud-drizzle"},57:{t:"Gefrier. Niesel",i:"cloud-drizzle"},61:{t:"Regen",i:"cloud-rain"},63:{t:"Regen",i:"cloud-rain"},65:{t:"Starkregen",i:"cloud-rain"},66:{t:"Gefrier. Regen",i:"cloud-hail"},67:{t:"Gefrier. Regen",i:"cloud-hail"},71:{t:"Schnee",i:"snowflake"},73:{t:"Schnee",i:"snowflake"},75:{t:"Schnee",i:"snowflake"},77:{t:"Schneegriesel",i:"snowflake"},80:{t:"Schauer",i:"cloud-rain-wind"},81:{t:"Schauer",i:"cloud-rain-wind"},82:{t:"Starkschauer",i:"cloud-rain-wind"},85:{t:"Schneeschauer",i:"snowflake"},86:{t:"Schneeschauer",i:"snowflake"},95:{t:"Gewitter",i:"cloud-lightning"},96:{t:"Gewitter",i:"cloud-lightning"},99:{t:"Gewitter",i:"cloud-lightning"} }; return map[code] || {t:"Unbekannt",i:"help-circle"}; }

        function selectLayer(type, title) {
            currentRadarType = type;
            document.getElementById('radarTitle').innerText = title;
            toggleLayerMenu();
            updateRadar();
        }

        function updateRadar() {
            const h = isFullscreen ? 1000 : 384;
            // WICHTIG: Standardmäßig KEIN radarRange Parameter, damit "Regen (Vorschau)" auch Zukunft zeigt.
            // Falls 'radar' (Vergangenheit) gewählt wird, zeigt Windy das automatisch korrekt.
            const src = `https://embed.windy.com/embed2.html?lat=${currentLat}&lon=${currentLon}&detailLat=${currentLat}&detailLon=${currentLon}&width=650&height=${h}&zoom=8&level=surface&overlay=${currentRadarType}&product=ecmwf&menu=&message=&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C`;
            document.getElementById('radarFrame').src = src;
        }

        function toggleFullscreen() { 
            const card = document.getElementById('radarCard'); 
            isFullscreen = !isFullscreen; 
            if (isFullscreen) { 
                card.classList.add('radar-fullscreen'); 
                document.getElementById('fullscreenIcon').setAttribute('data-lucide', 'x'); 
                document.getElementById('radarOverlay').classList.add('hidden'); 
                document.body.style.overflow = 'hidden'; 
            } else { 
                card.classList.remove('radar-fullscreen'); 
                document.getElementById('fullscreenIcon').setAttribute('data-lucide', 'maximize-2'); 
                document.getElementById('radarOverlay').classList.remove('hidden'); 
                document.body.style.overflow = ''; 
            } 
            lucide.createIcons(); 
            updateRadar();
        }

        function startClock() { const liveClock = document.getElementById('liveClock'); if(liveClock) liveClock.innerText = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }); if (clockInterval) clearInterval(clockInterval); clockInterval = setInterval(() => { if(liveClock) liveClock.innerText = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }); }, 1000); }
        startClock();
        document.addEventListener('DOMContentLoaded', () => locateMe(true));

    </script>
</body>
</html>
