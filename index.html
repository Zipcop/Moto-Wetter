<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Wetter">
    
    <!-- ZUR√úCK ZUM ORIGINAL: Web-Icon -->
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    
    <title>Wetter Live</title>
    
    <!-- LEAFLET CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- LEAFLET JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* touch-action: pan-y verhindert horizontales Wischen auf Browserebene */
        html, body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; overflow-x: hidden; width: 100%; touch-action: pan-y; }
        
        /* ZUR√úCKGESETZT: Originaler blauer Hintergrund ohne Bild */
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: 1rem; padding-right: 1rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: white; }
        
        /* Z-INDEX LAYERING (Repariert) */
        /* Layer 1: Wetter-Effekte (Regen, Wolken, V√∂gel) */
        #splashEffects { position: fixed; inset: 0; z-index: 1; pointer-events: none; overflow: hidden; }
        
        /* Layer 50: Hauptinhalt (App UI) - Muss h√∂her sein als Effekte, damit klickbar */
        main { position: relative; z-index: 50; }
        
        /* Layer 100: Ladescreen */
        #splashScreen { 
            position: fixed; inset: 0; z-index: 100; 
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px);
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1), opacity 0.6s ease-out;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 2.5rem; overflow: hidden;
            cursor: pointer; 
        }
        .splash-hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
        #splashLocalEffects { position: absolute; inset: 0; z-index: -1; pointer-events: none; overflow: hidden; }
        .splash-content { position: relative; z-index: 10; }

        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-btn { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(71, 85, 105, 1); color: white; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3b82f6; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; }
        
        .radar-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 200 !important; background: #0f172a; border-radius: 0 !important; padding: env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 40px) 0; margin: 0 !important; }
        
        .live-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse-red 2s infinite; }
        
        .hour-card-active { background-color: rgba(59, 130, 246, 0.2) !important; border-color: rgba(59, 130, 246, 0.8) !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .hour-card-night { background-color: rgba(10, 15, 30, 0.9) !important; border-color: rgba(255,255,255,0.05) !important; } 
        .modal-overlay { cursor: pointer; }
        .modal-content { cursor: default; }
        #suggestionsList { z-index: 100 !important; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .rain-bar { transition: height 0.5s ease-out; }

        /* DEV MENU STYLES */
        #devMenu { z-index: 9999; }
        .dev-btn { @apply bg-slate-700 hover:bg-slate-600 text-white text-xs font-mono py-2 px-3 rounded border border-slate-600 transition-colors; }
        .dev-btn-active { @apply bg-blue-600 border-blue-400; }

        /* LEAFLET CUSTOM STYLES */
        .leaflet-container { background: #0f172a !important; font-family: inherit !important; }
        .leaflet-control-attribution { background: rgba(15, 23, 42, 0.8) !important; color: #64748b !important; }
        .leaflet-control-attribution a { color: #94a3b8 !important; }
        .leaflet-control-zoom { border: none !important; margin-right: 12px !important; margin-top: 50px !important; }
        .leaflet-bar a { background-color: rgba(30, 41, 59, 0.9) !important; color: white !important; border-bottom: 1px solid rgba(255,255,255,0.1) !important; }
        .leaflet-bar a:hover { background-color: #3b82f6 !important; }

        /* TIMELINE SLIDER STYLES */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: #3b82f6; cursor: pointer; margin-top: -4px; box-shadow: 0 0 0 2px rgba(15, 23, 42, 1); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
        input[type=range]:focus { outline: none; }

        /* Animations */
        @keyframes floatUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-float-up { animation: floatUp 0.8s ease-out forwards; }
        .delay-100 { animation-delay: 0.1s; } .delay-200 { animation-delay: 0.2s; } .delay-300 { animation-delay: 0.3s; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        
        /* Splash FX */
        @keyframes rain-fall { 0% { transform: translateY(-10vh) translateX(-5vh) rotate(15deg); } 100% { transform: translateY(110vh) translateX(10vh) rotate(15deg); } }
        .rain-drop { position: absolute; width: 2px; height: 15px; background: rgba(255,255,255,0.4); top: -20px; animation: rain-fall 0.8s linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(-10vh) translateX(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(110vh) translateX(20px); opacity: 0.3; } }
        .snowflake { position: absolute; width: 6px; height: 6px; background: white; border-radius: 50%; top: -10px; filter: blur(1px); animation: snow-fall 4s linear infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; box-shadow: 0 0 6px rgba(255,255,255,0.9); }
        @keyframes fog-drift { 0% { transform: translateX(-10%); opacity: 0.4; } 50% { transform: translateX(10%); opacity: 0.7; } 100% { transform: translateX(-10%); opacity: 0.4; } }
        .fog-layer { position: absolute; left: -20%; right: -20%; top: 20%; height: 60%; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.2), transparent); filter: blur(25px); animation: fog-drift 10s infinite ease-in-out; }
        @keyframes cloud-drift { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }
        .cloud-shape { position: absolute; background: radial-gradient(circle, rgba(255,255,255,0.45) 0%, rgba(255,255,255,0.15) 60%, transparent 70%); border-radius: 50%; filter: blur(25px); animation: cloud-drift linear infinite; }
        .sun-orb { position: absolute; width: 250px; height: 250px; background: radial-gradient(circle, rgba(253, 224, 71, 0.8) 0%, rgba(253, 224, 71, 0.3) 50%, transparent 70%); filter: blur(30px); animation: pulse-sun 6s infinite ease-in-out; z-index: -1; transform: translate(-50%, -50%); transition: top 1s linear, left 1s linear; }
        @keyframes pulse-sun { 0%,100%{transform: translate(-50%, -50%) scale(1); opacity: 0.8;} 50%{transform: translate(-50%, -50%) scale(1.1); opacity: 1;} }
        .compass-active { border-color: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
        
        /* Layer 20: Blitze */
        #lightningLayer { position: fixed; inset: 0; z-index: 20; background: white; opacity: 0; pointer-events: none; mix-blend-mode: overlay; }
        @keyframes lightning-flash { 0% { opacity: 0; } 2% { opacity: 0.6; } 4% { opacity: 0; } 6% { opacity: 0.8; } 8% { opacity: 0; } 100% { opacity: 0; } }

        /* BIRD ANIMATION (Z-Index 2 damit vor Wolken) */
        .bird-container { position: absolute; left: -10%; width: 100px; height: 50px; pointer-events: none; z-index: 2; opacity: 0.6; }
        .bird { position: absolute; width: 10px; height: 6px; border-bottom: 2px solid rgba(255,255,255,0.5); border-left: 2px solid rgba(255,255,255,0.5); transform: rotate(-45deg) skew(10deg); animation: wing-flap 0.8s ease-in-out infinite alternate; }
        
        /* Flug von Links nach Rechts */
        @keyframes fly-across { 
            0% { left: -20%; transform: translateY(0) scale(0.8); } 
            25% { transform: translateY(-20px) scale(0.9); } 
            50% { transform: translateY(10px) scale(1); } 
            75% { transform: translateY(-15px) scale(0.9); } 
            100% { left: 120%; transform: translateY(0) scale(0.8); } 
        }
        
        /* Flug von Rechts nach Links (gespiegelt mit scaleX(-1)) */
        @keyframes fly-across-reverse { 
            0% { left: 120%; transform: translateY(0) scale(0.8) scaleX(-1); } 
            25% { transform: translateY(-15px) scale(0.9) scaleX(-1); } 
            50% { transform: translateY(10px) scale(1) scaleX(-1); } 
            75% { transform: translateY(-20px) scale(0.9) scaleX(-1); } 
            100% { left: -20%; transform: translateY(0) scale(0.8) scaleX(-1); } 
        }
        
        @keyframes wing-flap { 
            0% { transform: rotate(-45deg) skew(10deg) scaleY(0.7); } 
            100% { transform: rotate(-45deg) skew(10deg) scaleY(1.3); } 
        }
    </style>
</head>
<body class="flex flex-col items-center">

    <!-- BACKGROUND EFFECTS -->
    <div id="splashEffects"></div>
    <div id="lightningLayer"></div>

    <div id="splashScreen" onclick="dismissSplash()">
        <div id="splashLocalEffects"></div>
        <div class="mt-10 text-center opacity-0 animate-float-up splash-content">
            <div class="flex items-center justify-center gap-2 text-blue-300 mb-2 uppercase tracking-widest text-xs font-bold"><i data-lucide="map-pin" size="14"></i> Aktueller Standort</div>
            <h1 id="splashCity" class="text-4xl font-bold tracking-tight drop-shadow-lg">Ortung...</h1>
        </div>
        <div class="flex flex-col items-center justify-center opacity-0 animate-float-up delay-100 splash-content">
            <div id="splashIcon" class="mb-4 transform scale-150 drop-shadow-2xl text-blue-200"><div class="loader border-t-white/50"></div></div>
            <div class="text-8xl font-black tracking-tighter drop-shadow-xl"><span id="splashTemp">--</span><span class="text-4xl align-top text-blue-200/80">¬∞</span></div>
            <div id="splashDesc" class="text-xl font-medium text-blue-100/80 mt-2">Einen Moment...</div>
        </div>
        <div class="mb-10 flex flex-col items-center gap-2 opacity-0 animate-float-up delay-200 cursor-pointer splash-content">
            <span class="text-xs font-medium text-white/50 uppercase tracking-wider">Zum Starten tippen</span>
            <div class="bg-white/10 p-3 rounded-full backdrop-blur-md animate-bounce-slow hover:bg-white/20 transition"><i data-lucide="chevron-up" class="text-white"></i></div>
        </div>
    </div>

    <main class="w-full max-w-lg space-y-4 pt-4 pb-10 relative z-10">
        <div class="glass-panel rounded-2xl p-4 shadow-xl z-20 relative">
            <div class="flex justify-between items-center mb-3">
                <!-- TRIGGER F√úR DEV MENU: 3x Tappen f√ºr einfachere Bedienung -->
                <h1 onclick="handleDevTrigger()" class="text-sm font-bold text-blue-200 uppercase tracking-widest flex items-center gap-2 select-none cursor-pointer active:scale-95 transition-transform touch-manipulation"><i data-lucide="bike" size="16"></i> Wetter</h1>
                <div class="flex items-center gap-3">
                    <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative" title="Einstellungen"><i data-lucide="settings-2" size="18"></i></button>
                    <button onclick="enableNotifications()" id="notifyBtn" class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative"><i data-lucide="bell" size="18"></i><span id="notifyBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-blue-500 rounded-full"></span></button>
                </div>
            </div>
            <form onsubmit="event.preventDefault(); searchCity();" class="flex gap-2 relative">
                <div class="relative flex-grow">
                    <input type="search" id="cityInput" placeholder="Stadt eingeben..." class="w-full bg-slate-800/50 border border-slate-600 rounded-xl py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition appearance-none" autocomplete="off">
                    <div id="suggestionsList" class="hidden absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto"></div>
                </div>
                <button type="submit" class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="search"></i></button>
                <button type="button" onclick="locateMe()" class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="map-pin"></i></button>
            </form>
            <div id="cityName" class="text-xl font-bold mt-4 text-center tracking-wide text-blue-100">--</div>
            <div id="offlineBanner" class="hidden flex items-center justify-center gap-2 text-[10px] text-orange-300 font-bold mb-1 bg-orange-500/20 rounded py-1 px-3 mx-auto w-fit animate-pulse cursor-pointer hover:bg-orange-500/30 transition" onclick="fetchWeather(lastWeatherData?.name || 'Standort', '')"><span>OFFLINE-MODUS</span> <i data-lucide="refresh-cw" size="10"></i></div>
            <div id="timeLabel" class="text-xs text-slate-400 text-center uppercase tracking-wider mb-1 font-semibold opacity-0 transition-opacity duration-300">Aktuell</div>
            <div id="errorMessage" class="hidden text-red-400 text-center text-sm mt-2 font-semibold bg-red-500/10 p-2 rounded-lg border border-red-500/20">Stadt nicht gefunden.</div>
        </div>
        
        <div id="loadingIndicator" class="hidden flex justify-center py-10"><div class="loader"></div></div>
        <div id="gpsErrorPrompt" class="hidden text-center py-10 animate-fade-in"><div class="bg-slate-800/50 p-4 rounded-2xl inline-flex flex-col items-center gap-3 border border-slate-600/50"><i data-lucide="map-off" size="32" class="text-slate-400"></i><p class="text-sm text-slate-300">Standortzugriff verweigert</p><button onclick="locateMe()" class="glass-btn text-xs font-bold py-2 px-4 rounded-xl transition">Erneut versuchen</button></div></div>
        <div id="warningContainer" class="hidden w-full max-w-lg animate-fade-in"></div>

        <div id="dynamicContent" class="hidden w-full max-w-lg space-y-4 animate-fade-in">
            <div id="statusSection" class="grid grid-cols-2 gap-4 transition-all duration-300">
                <div id="card-weather" onclick="showDailyDetails(0)" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 relative group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="maximize-2" size="12"></i></div>
                    <div id="weatherIconContainer" class="mb-1 text-blue-300"><i data-lucide="cloud" size="40"></i></div>
                    <div class="text-4xl font-bold mb-1"><span id="temperature">--</span>¬∞</div>
                    <div class="text-sm font-semibold text-blue-200 mb-2">Gef√ºhlt <span id="feelsLike">--</span>¬∞</div>
                    <div id="weatherDesc" class="text-xs text-slate-300">--</div>
                    <div class="flex gap-4 text-sm font-semibold text-blue-200 mt-2 mb-2"><span class="flex items-center"><i data-lucide="arrow-up" size="14" class="mr-1 text-red-400"></i><span id="tempMax">--</span>¬∞</span><span class="flex items-center"><i data-lucide="arrow-down" size="14" class="mr-1 text-blue-400"></i><span id="tempMin">--</span>¬∞</span></div>
                    <div class="flex gap-3 mt-1 text-xs text-slate-400"><span class="flex items-center gap-1"><div class="bg-slate-700 border border-slate-600 rounded-full p-1 transform transition-transform duration-700" id="windDirArrow"><i data-lucide="arrow-up" size="12" class="text-blue-200"></i></div><span id="windSpeed">--</span></span><span class="flex items-center gap-1"><i data-lucide="droplets" size="12"></i> <span id="humidity">--</span></span></div>
                </div>
                <div id="card-moto" onclick="showMotoDetails()" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="info" size="12"></i></div>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Moto Index</h3>
                    <div id="motoScoreCircle" class="w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner"><span id="motoScoreValue" class="text-2xl font-black">--</span></div>
                    <div id="motoScoreText" class="text-xs font-semibold mb-2">--</div>
                    <div class="border-t border-slate-600/50 w-full pt-2 mt-1"><div class="flex justify-between items-center px-1 text-xs"><span class="text-slate-400">Heute √ò</span><span id="dailyScoreValue" class="font-bold text-blue-100">--</span></div></div>
                </div>
            </div>
            
            <div id="rainChartSection" class="glass-panel rounded-2xl p-4">
                <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300 mb-3"><i data-lucide="umbrella" size="16"></i> Niederschlag (1h)</h3>
                <div class="flex justify-between items-end h-24 gap-2" id="rainBarsContainer"><div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">Keine Daten</div></div>
                <div class="flex justify-between text-[10px] text-slate-500 mt-1 px-1"><span>Jetzt</span><span>15m</span><span>30m</span><span>45m</span></div>
            </div>

            <!-- RADAR SECTION -->
            <div id="radarSection" class="glass-panel rounded-2xl overflow-hidden shadow-lg transition-all duration-300 flex flex-col">
                <div class="bg-slate-800/80 p-3 flex justify-between items-center border-b border-slate-700 shrink-0">
                    <h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="map" size="16" class="text-blue-400"></i><span id="radarTitle">Niederschlag (Live)</span></h3>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleFullscreen()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation"><i id="fullscreenIcon" data-lucide="maximize-2" size="16"></i></button>
                    </div>
                </div>
                <div id="radarFrameContainer" class="relative w-full h-96 bg-slate-900 transition-all duration-300 grow">
                    <div id="radarMap" class="w-full h-full z-0 outline-none"></div>
                    <div class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700/50 flex items-center shadow-lg pointer-events-none z-[400]"><div class="live-dot"></div><span class="text-[10px] text-slate-400 mr-2 uppercase tracking-wider">Radar</span></div>
                    <div class="absolute bottom-6 left-4 right-4 bg-slate-900/80 backdrop-blur-md p-2 rounded-xl border border-slate-700/50 flex items-center gap-3 z-[400]">
                        <button onclick="toggleRadarPlayback()" id="radarPlayBtn" class="p-2 bg-blue-600 rounded-lg text-white hover:bg-blue-500 transition shadow-lg shrink-0 touch-manipulation"><i data-lucide="pause" size="16"></i></button>
                        <input type="range" id="radarTimeline" min="0" value="0" step="1" oninput="handleRadarScrub(this.value)" class="flex-grow h-1 bg-slate-600 rounded-lg cursor-pointer touch-manipulation">
                        <span id="radarTimeLabel" class="text-xs font-mono font-bold text-white min-w-[40px] text-right">--:--</span>
                    </div>
                </div>
            </div>
            
            <div id="timelineSection" class="glass-panel rounded-2xl p-4 transition-all duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300"><i data-lucide="clock" size="16"></i> Vorhersage</h3>
                    <button onclick="toggleLegend()" class="text-slate-400 hover:text-white transition p-1 bg-slate-800/50 rounded-full hover:bg-slate-700"><i data-lucide="info" size="16"></i></button>
                </div>
                <div id="hourlyContainer" class="flex overflow-x-auto gap-3 pb-2 custom-scrollbar snap-x touch-pan-x"></div>
            </div>
            <div id="forecast7DaySection" class="glass-panel rounded-2xl p-4">
                <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300 mb-3"><i data-lucide="calendar-days" size="16"></i> 7-Tage Trend</h3>
                <div id="forecast7List" class="space-y-3"></div>
            </div>
        </div>
        
        <div id="startPrompt" class="text-center py-20 text-slate-500 hidden"><i data-lucide="bike" class="mx-auto mb-4 h-16 w-16 opacity-30"></i><p>Standort wird ermittelt...</p></div>
        <div class="text-center text-[10px] text-slate-600 mt-4 pb-2 opacity-50">v4.13 ‚Ä¢ Auto-Refresh (5m) ‚Ä¢ N.W.</div>
    </main>

    <!-- MODALS -->
    <!-- SETTINGS MODAL (Updated with Moto Profile) -->
    <div id="settingsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[99] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="toggleSettings()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="settings-2" size="20"></i> Einstellungen</h3>
            <div class="space-y-4 text-sm max-h-[70vh] overflow-y-auto custom-scrollbar">
                
                <!-- Moto Profile Section -->
                <div class="p-3 bg-slate-800/50 rounded-xl border border-blue-500/30">
                    <h4 class="text-xs font-bold uppercase text-blue-300 mb-3 flex items-center gap-2"><i data-lucide="user-cog" size="14"></i> Biker Profil</h4>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-slate-300 mb-1"><span>Min. Temp (Wohlf√ºhl)</span><span id="dispMinTemp" class="font-bold text-white">10¬∞C</span></div>
                        <input type="range" min="0" max="25" step="1" id="inputMinTemp" oninput="updateMotoProfile('minTemp', this.value)" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1"><span>0¬∞</span><span>25¬∞</span></div>
                    </div>

                    <div class="mb-4">
                        <div class="flex justify-between text-xs text-slate-300 mb-1"><span>Max. Wind (B√∂en)</span><span id="dispMaxWind" class="font-bold text-white">40 km/h</span></div>
                        <input type="range" min="20" max="100" step="5" id="inputMaxWind" oninput="updateMotoProfile('maxWind', this.value)" class="w-full h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-[10px] text-slate-500 mt-1"><span>20</span><span>100</span></div>
                    </div>

                    <div class="flex items-center justify-between mt-2">
                        <span class="text-xs text-slate-300">Regen-Empfindlichkeit</span>
                        <button id="btnRainTol" onclick="toggleRainTolerance()" class="px-3 py-1 rounded-lg text-xs font-bold transition bg-blue-600 text-white border border-blue-500">Streng</button>
                    </div>
                    <div id="rainTolDesc" class="text-[10px] text-slate-500 mt-1 text-right">Kein Tropfen erlaubt!</div>
                </div>

                <!-- Layout Section -->
                <div>
                    <h4 class="text-xs font-bold uppercase text-slate-400 mb-2">Layout & Sichtbarkeit</h4>
                    <div class="space-y-2" id="layoutList"></div>
                    <div class="pt-2 mt-2 border-t border-slate-600/50">
                        <div class="flex justify-between items-center bg-slate-800/30 p-2 rounded-lg mb-2"><span>Wetter-Daten</span><button onclick="toggleSubVisibility('weather')" id="vis-weather-btn" class="text-green-400"><i data-lucide="eye" size="18"></i></button></div>
                        <div class="flex justify-between items-center bg-slate-800/30 p-2 rounded-lg"><span>Moto Index</span><button onclick="toggleSubVisibility('moto')" id="vis-moto-btn" class="text-green-400"><i data-lucide="eye" size="18"></i></button></div>
                    </div>
                </div>
                
                <button onclick="resetLayout()" class="w-full py-2 mt-2 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition">Reset App</button>
            </div>
        </div>
    </div>
    
    <!-- DAILY DETAILS MODAL (Updated) -->
    <div id="dailyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content">
            <button onclick="document.getElementById('dailyDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-2 text-blue-100 flex items-center gap-2"><i data-lucide="calendar" size="20"></i> <span id="dailyDetailTitle">Tages-Infos</span></h3>
            <p id="dailyDetailDate" class="text-xs text-slate-400 mb-6 uppercase tracking-wider">Details</p>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                    <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunrise" size="12"></i> Aufgang</div>
                    <div id="detailSunrise" class="font-bold">--:--</div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                    <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunset" size="12"></i> Untergang</div>
                    <div id="detailSunset" class="font-bold">--:--</div>
                </div>
            </div>
            
            <div class="bg-slate-800/50 p-4 rounded-xl mb-4 border border-slate-700/50">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-slate-400 text-xs flex items-center gap-1"><i data-lucide="umbrella" size="12"></i> Regen</div>
                    <div class="text-blue-300 font-bold text-sm"><span id="detailPrecipSum">0</span> mm</div>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-1.5 mb-1">
                    <div id="detailPrecipProbBar" class="bg-blue-500 h-1.5 rounded-full" style="width:0%"></div>
                </div>
                <div class="text-[10px] text-right text-slate-500"><span id="detailPrecipProb">0</span>% Wahrsch.</div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                    <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="wind" size="12"></i> Max Wind</div>
                    <div class="font-bold text-white"><span id="detailWindMax">--</span> <span class="text-xs font-normal text-slate-400">km/h</span></div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                    <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sun" size="12"></i> Max UV</div>
                    <div class="font-bold text-white"><span id="detailUVMax">--</span></div>
                </div>
            </div>
            
            <!-- Current Day Only Logic -->
            <div id="currentDayExtras" class="hidden">
                <div id="sunCountdownContainer" class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-2 mb-4 text-center">
                    <div class="text-xs text-yellow-200 font-medium flex items-center justify-center gap-2"><i data-lucide="hourglass" size="12"></i> <span id="sunCountdownText">...</span></div>
                </div>
                <div class="bg-slate-800/50 p-3 rounded-xl flex justify-between items-center">
                    <span class="text-sm text-slate-300">Luftqualit√§t (AQI)</span>
                    <div class="flex items-center gap-2"><span id="detailAqiVal" class="font-bold text-white">--</span> <div id="detailAqiBar" class="w-2 h-2 rounded-full bg-slate-600"></div></div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 mb-6 mt-4">
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="eye" size="12"></i> Sicht</div>
                        <div id="detailVisibility" class="font-bold">--</div>
                    </div>
                    <div class="bg-slate-800/50 p-3 rounded-xl text-center">
                        <div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sun" size="12"></i> UV</div>
                        <div id="detailUV" class="font-bold">--</div>
                    </div>
                </div>
            </div>
            
            <div id="dailyMotoScore" class="mt-4 p-3 rounded-xl border border-slate-600/50 flex justify-between items-center bg-slate-800">
                <span class="text-xs uppercase font-bold text-slate-400">Tages-Score</span>
                <span id="dailyScoreDetailVal" class="font-black text-lg">--</span>
            </div>
        </div>
    </div>

    <div id="motoDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="document.getElementById('motoDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-2 text-white flex items-center gap-2"><i data-lucide="bike" size="24" class="text-blue-400"></i> Moto Analyse</h3><p class="text-xs text-slate-400 mb-4">Details</p><div id="motoAnalysisList" class="space-y-3 mb-6"></div><h3 class="text-md font-bold mb-2 text-white flex items-center gap-2 border-t border-slate-600 pt-4"><i data-lucide="shirt" size="20" class="text-orange-400"></i> Gear Guide</h3><div class="bg-slate-800/50 p-3 rounded-xl border border-slate-600/50 flex items-center gap-3"><div id="gearIcon" class="text-2xl">üß•</div><div class="text-sm font-medium text-slate-200" id="gearText">...</div></div></div></div>
    <div id="hourlyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-xs rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="closeHourlyModal()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><div class="text-center mb-4"><div id="modalTime" class="text-lg font-bold text-blue-200">--:--</div><div id="modalDesc" class="text-sm text-slate-400">--</div></div><div class="flex flex-col items-center justify-center mb-6"><div id="modalIcon" class="mb-2 transform scale-125"></div><div class="text-5xl font-bold tracking-tighter"><span id="modalTemp">--</span>¬∞</div></div><div class="grid grid-cols-3 gap-2 mb-4 text-center"><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="wind" size="12" class="inline"></i> Wind</div><div id="modalWind" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="umbrella" size="12" class="inline"></i> Regen</div><div id="modalRain" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="droplets" size="12" class="inline"></i> Feuchte</div><div id="modalHum" class="font-bold text-sm">--</div></div></div><div id="modalScoreBg" class="rounded-xl p-3 border flex items-center justify-between"><span class="font-bold uppercase text-xs tracking-wider">Moto Index</span><div class="text-right"><span id="modalScoreVal" class="text-xl font-black">--</span><span class="text-xs opacity-80">/10</span></div></div></div></div>
    <div id="legendModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative max-h-[85vh] overflow-y-auto custom-scrollbar shadow-2xl border-slate-600/50 modal-content"><button onclick="toggleLegend()" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-4 text-blue-100 flex items-center gap-2"><i data-lucide="cloud-sun" size="20"></i> Legende</h3>
        <div class="grid grid-cols-1 gap-2 text-sm text-slate-300">
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="sun" class="text-yellow-400 w-6 h-6"></i> <span>Klar</span></div>
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-sun" class="text-blue-200 w-6 h-6"></i> <span>Bew√∂lkt</span></div>
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-fog" class="text-gray-400 w-6 h-6"></i> <span>Nebel</span></div>
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-rain" class="text-blue-400 w-6 h-6"></i> <span>Regen</span></div>
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="snowflake" class="text-white w-6 h-6"></i> <span>Schnee</span></div>
            <div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-lightning" class="text-purple-400 w-6 h-6"></i> <span>Gewitter</span></div>
        </div>
    </div></div>

    <!-- DEV MENU MODAL -->
    <div id="devMenu" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 flex items-center justify-center p-4 bg-black/90 backdrop-blur-md animate-fade-in modal-overlay">
        <div class="glass-panel w-full max-w-sm rounded-2xl p-5 relative shadow-2xl border border-red-500/30 modal-content">
            <button onclick="document.getElementById('devMenu').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button>
            <h3 class="text-lg font-bold mb-1 text-red-400 flex items-center gap-2"><i data-lucide="terminal" size="20"></i> Developer FX</h3>
            <p class="text-xs text-slate-500 mb-4 font-mono">Effekte erzwingen (nur visuell)</p>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <button onclick="forceEffect(0, 1)" class="dev-btn">‚òÄÔ∏è Klar (Tag)</button>
                <button onclick="forceEffect(0, 0)" class="dev-btn">üåô Klar (Nacht)</button>
                <button onclick="forceEffect(3, 1)" class="dev-btn">‚òÅÔ∏è Wolkig</button>
                <button onclick="forceEffect(61, 1)" class="dev-btn">üíß Regen (Leicht)</button>
                <button onclick="forceEffect(63, 1)" class="dev-btn">üåßÔ∏è Regen (Mittel)</button>
                <button onclick="forceEffect(65, 1)" class="dev-btn">‚õàÔ∏è Regen (Stark)</button>
                <button onclick="forceEffect(71, 1)" class="dev-btn">‚ùÑÔ∏è Schnee</button>
                <button onclick="forceEffect(45, 1)" class="dev-btn">üå´Ô∏è Nebel</button>
                <button onclick="forceEffect(95, 1)" class="dev-btn">‚ö° Gewitter</button>
                <button onclick="forceEffect(3, 1, true)" class="dev-btn">üå•Ô∏è Bedeckt++</button>
                <!-- NEU: V√∂gel Button -->
                <button onclick="forceEffect(0, 1, false, true)" class="dev-btn border-yellow-500/50 text-yellow-200">ü¶Ö V√∂gel (Klar)</button>
            </div>
            
            <button onclick="resetEffects()" class="w-full bg-green-600/20 hover:bg-green-600/40 text-green-400 border border-green-600/50 py-3 rounded-xl font-bold transition flex items-center justify-center gap-2">
                <i data-lucide="refresh-cw" size="16"></i> Reset zu Live
            </button>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // State
        let currentLat = 51.1657; let currentLon = 10.4515;
        let lastWeatherData = null;
        let isFullscreen = false; let debounceTimer; let clockInterval;
        let currentHeading = 0;
        let isFirstLoad = true; 
        let lightningTimeout;
        let refreshTimer = null; // NEW: Timer for auto-refresh
        let currentCityName = "Standort"; // NEW: Store name for refresh
        let currentCountry = ""; // NEW: Store country for refresh
        
        // MOTO PROFILE STATE
        let motoProfile = { minTemp: 10, maxWind: 40, strictRain: true };
        try {
            const saved = localStorage.getItem('motoProfile_v1');
            if(saved) motoProfile = { ...motoProfile, ...JSON.parse(saved) };
        } catch(e){}

        // RADAR VARIABLES
        let radarMap = null;
        let radarMarker = null;
        let radarTimestamps = [];
        let radarLayers = {}; 
        let currentRadarIndex = 0;
        let radarAnimationInterval = null;
        let isRadarPlaying = false; 
        
        let devTapCount = 0;
        let devTapTimer;
        
        // --- HELPER TO SAFELY SET TEXT ---
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerText = text;
        }

        // --- MOTO PROFILE FUNCTIONS ---
        function updateMotoProfile(key, value) {
            if(key === 'minTemp') {
                motoProfile.minTemp = parseInt(value);
                safeSetText('dispMinTemp', motoProfile.minTemp + "¬∞C");
            } else if(key === 'maxWind') {
                motoProfile.maxWind = parseInt(value);
                safeSetText('dispMaxWind', motoProfile.maxWind + " km/h");
            }
            saveMotoProfile();
        }

        function toggleRainTolerance() {
            motoProfile.strictRain = !motoProfile.strictRain;
            renderMotoSettingsUI(); // Update texts/colors
            saveMotoProfile();
        }
        
        function toggleStrictRain() { // Alias for compatibility if needed
            toggleRainTolerance();
        }

        function saveMotoProfile() {
            localStorage.setItem('motoProfile_v1', JSON.stringify(motoProfile));
            if(lastWeatherData) updateUI(null, true); // Recalculate scores live
        }

        function renderMotoSettingsUI() {
            // Update Inputs
            const inTemp = document.getElementById('inputMinTemp');
            const inWind = document.getElementById('inputMaxWind');
            if(inTemp) inTemp.value = motoProfile.minTemp;
            if(inWind) inWind.value = motoProfile.maxWind;
            
            // Update Texts
            safeSetText('dispMinTemp', motoProfile.minTemp + "¬∞C");
            safeSetText('dispMaxWind', motoProfile.maxWind + " km/h");
            
            // Update Button
            const btn = document.getElementById('btnRainTol');
            const desc = document.getElementById('rainTolDesc');
            if(btn) {
                if(motoProfile.strictRain) {
                    btn.innerText = "Streng";
                    btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-blue-600 text-white border border-blue-500";
                    safeSetText('rainTolDesc', "Kein Tropfen erlaubt!");
                } else {
                    btn.innerText = "Locker";
                    btn.className = "px-3 py-1 rounded-lg text-xs font-bold transition bg-slate-600 text-slate-300 border border-slate-500";
                    safeSetText('rainTolDesc', "Leichter Regen okay.");
                }
            }
        }

        // --- DEV MENU TRIGGER (ROBUST VERSION) ---
        function handleDevTrigger() {
            clearTimeout(devTapTimer);
            devTapCount++;
            if (devTapCount >= 3) {
                try {
                    const menu = document.getElementById('devMenu');
                    if(menu) {
                        menu.classList.remove('hidden');
                        lucide.createIcons(); 
                    }
                } catch(e) { console.error("DevMenu Error", e); }
                devTapCount = 0; 
            } else {
                devTapTimer = setTimeout(() => { devTapCount = 0; }, 600); 
            }
        }
        window.handleDevTrigger = handleDevTrigger;
        
        function forceEffect(code, isDay, heavyOverride = false, birdsOverride = false) {
            // Special handling for birds override
            if(birdsOverride) {
                // Force clear day weather for birds
                renderSplashEffects(0, 1); 
            } else {
                renderSplashEffects(code, isDay);
            }
            
            updateSunVisualsDev(isDay); 
            const info = getWeatherInfo(code);
            document.getElementById('weatherDesc').innerHTML = `<span class="text-red-400 font-mono">[DEV] ${birdsOverride ? 'V√∂gel (Klar)' : info.t}</span>`;
            document.getElementById('weatherIconContainer').innerHTML=`<i data-lucide="${info.i}" class="w-12 h-12 text-red-300"></i>`;
            document.getElementById('devMenu').classList.add('hidden');
            lucide.createIcons();
            
            if(heavyOverride) {
                 const con = document.getElementById('splashEffects');
                 con.innerHTML += `<div class="cloud-shape" style="top:-5%; left:20%; width:110vw; height:40vh; animation-duration:32s; opacity:0.4;"></div>`;
                 con.innerHTML += `<div class="cloud-shape" style="bottom:35%; left:-20%; width:110vw; height:45vh; animation-duration:38s; opacity:0.3;"></div>`;
            }
        }
        
        function updateSunVisualsDev(isDay) {
            const suns = document.querySelectorAll('.sun-orb');
            suns.forEach(s => s.remove());
            if(isDay === 1) {
                const con = document.getElementById('splashEffects');
                const div = document.createElement('div');
                div.className = 'sun-orb';
                div.style.left = '50%'; div.style.top = '20%'; 
                con.appendChild(div);
            }
        }

        function resetEffects() {
            if(lastWeatherData) { updateUI(null, true); }
            document.getElementById('devMenu').classList.add('hidden');
        }

        let layoutConfig = { order: ['statusSection', 'rainChartSection', 'radarSection', 'forecast7DaySection', 'timelineSection'], visibility: { statusSection: true, rainChartSection: true, radarSection: true, timelineSection: true, sub_weather: true, sub_moto: true, forecast7DaySection: true } };
        try { 
            const s = localStorage.getItem('motoLayoutConfig_v4'); 
            if(s) { 
                const p = JSON.parse(s); 
                if(!p.order.includes('rainChartSection')) p.order.splice(1,0,'rainChartSection');
                if(!p.order.includes('forecast7DaySection')) p.order.push('forecast7DaySection');
                layoutConfig = { ...layoutConfig, ...p, visibility: { ...layoutConfig.visibility, ...p.visibility } }; 
                layoutConfig.visibility.rainChartSection = layoutConfig.visibility.rainChartSection !== false;
                layoutConfig.visibility.forecast7DaySection = layoutConfig.visibility.forecast7DaySection !== false;
            } 
        } catch(e){}

        const cityInput = document.getElementById('cityInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const warningContainer = document.getElementById('warningContainer');
        const offlineBanner = document.getElementById('offlineBanner');
        const splash = document.getElementById('splashScreen');

        function dismissSplash() { splash.classList.add('splash-hidden'); document.body.style.overflow = 'auto'; }
        function initSplash() { const hour = new Date().getHours(); const isDay = (hour >= 6 && hour < 20) ? 1 : 0; renderSplashEffects(0, isDay); }
        initSplash();

        function applyLayout() {
            const con = document.getElementById('dynamicContent');
            const els = { statusSection: document.getElementById('statusSection'), rainChartSection: document.getElementById('rainChartSection'), radarSection: document.getElementById('radarSection'), timelineSection: document.getElementById('timelineSection'), forecast7DaySection: document.getElementById('forecast7DaySection') };
            layoutConfig.order.forEach(id => { if(els[id]) { con.appendChild(els[id]); els[id].classList.toggle('hidden', !layoutConfig.visibility[id]); } });
            const wc=document.getElementById('card-weather'), mc=document.getElementById('card-moto');
            wc.classList.toggle('hidden', !layoutConfig.visibility.sub_weather); mc.classList.toggle('hidden', !layoutConfig.visibility.sub_moto);
            wc.classList.remove('col-span-2'); mc.classList.remove('col-span-2');
            if(layoutConfig.visibility.sub_weather && !layoutConfig.visibility.sub_moto) wc.classList.add('col-span-2');
            if(!layoutConfig.visibility.sub_weather && layoutConfig.visibility.sub_moto) mc.classList.add('col-span-2');
            lucide.createIcons();
            setTimeout(() => { if(radarMap) radarMap.invalidateSize(); }, 200);
        }
        function toggleSettings() { 
            const m = document.getElementById('settingsModal');
            m.classList.toggle('hidden'); 
            if(!m.classList.contains('hidden')) {
                renderSettingsList(); 
                renderMotoSettingsUI(); // NEW: Render moto settings when opening
            }
        }
        function renderSettingsList() {
            const l=document.getElementById('layoutList'); l.innerHTML='';
            const n={statusSection:'√úbersicht', rainChartSection: 'Niederschlag (1h)', radarSection:'Radar (Live)',timelineSection:'Vorhersage', forecast7DaySection:'7-Tage Trend'};
            layoutConfig.order.forEach((id,i)=>{
                l.innerHTML+=`<div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700"><div class="flex items-center gap-3"><span class="text-slate-400 font-mono text-xs">${i+1}</span><span class="font-bold text-white">${n[id]}</span></div><div class="flex items-center gap-2"><button onclick="moveItem('${id}',-1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-up" size="16"></i></button><button onclick="moveItem('${id}',1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-down" size="16"></i></button><div class="w-px h-4 bg-slate-600 mx-1"></div><button onclick="toggleVisibility('${id}')" class="${layoutConfig.visibility[id]?'text-green-400':'text-slate-500'} p-1 hover:bg-slate-700 rounded"><i data-lucide="${layoutConfig.visibility[id]?'eye':'eye-off'}" size="18"></i></button></div></div>`;
            });
            document.getElementById('vis-weather-btn').className = layoutConfig.visibility.sub_weather ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-weather-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_weather?'eye':'eye-off'}" size="18"></i>`;
            document.getElementById('vis-moto-btn').className = layoutConfig.visibility.sub_moto ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-moto-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_moto?'eye':'eye-off'}" size="18"></i>`;
            lucide.createIcons();
        }
        function moveItem(id, d) { const i=layoutConfig.order.indexOf(id); if(i<0||i+d<0||i+d>=layoutConfig.order.length)return; [layoutConfig.order[i],layoutConfig.order[i+d]]=[layoutConfig.order[i+d],layoutConfig.order[i]]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleVisibility(id) { layoutConfig.visibility[id]=!layoutConfig.visibility[id]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleSubVisibility(k) { layoutConfig.visibility['sub_'+k]=!layoutConfig.visibility['sub_'+k]; saveLayout(); renderSettingsList(); applyLayout(); }
        function resetLayout() { localStorage.removeItem('motoLayoutConfig_v4'); localStorage.removeItem('motoProfile_v1'); location.reload(); }
        function saveLayout() { localStorage.setItem('motoLayoutConfig_v4', JSON.stringify(layoutConfig)); }

        function initCompass() { if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') { DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')window.addEventListener('deviceorientation',handleOrientation,true)}).catch(console.error); } else if (window.addEventListener) window.addEventListener('deviceorientation', handleOrientation, true); }
        function handleOrientation(e) { if (e.webkitCompassHeading) currentHeading=e.webkitCompassHeading; else if (e.alpha!==null) currentHeading=360-e.alpha; if(lastWeatherData) updateWindArrow(); }
        function updateWindArrow() { if(!lastWeatherData?.current?.wind_direction_10m)return; const a=document.getElementById('windDirArrow'); if(a) a.style.transform=`rotate(${lastWeatherData.current.wind_direction_10m+180-currentHeading}deg)`; }

        function saveToCache(n, d) { try{localStorage.setItem('motoWeather_cache_v3_8', JSON.stringify({name:n,data:d,timestamp:Date.now()}));}catch(e){} }
        function loadFromCache() { try{return JSON.parse(localStorage.getItem('motoWeather_cache_v3_8'));}catch(e){return null;} }
        async function enableNotifications() { if(!("Notification" in window))return alert("N/A"); if(Notification.permission==="granted"){alert("Aktiv!");checkAndSendNotification(10);} else if(Notification.permission!=="denied"){const p=await Notification.requestPermission();if(p==="granted")document.getElementById('notifyBadge').classList.remove('hidden');} else alert("Blockiert"); }
        function checkAndSendNotification(s) { if(Notification.permission==="granted"&&s>=8){const l=sessionStorage.getItem('lastNotificationTime'); if(!l||Date.now()-l>14400000){new Notification("Biker-Wetter!",{body:`Score: ${s}/10`,icon:"https://img.icons8.com/fluency/512/weather.png?v=2"});sessionStorage.setItem('lastNotificationTime',Date.now());}} }
        if ("Notification" in window && Notification.permission === "granted") document.getElementById('notifyBadge').classList.remove('hidden');

        function checkWarnings(c) { let w=null, col="bg-yellow-500/80 border-yellow-400", ic="alert-triangle"; 
        if(c.weather_code>=95){w="GEWITTER";col="bg-red-600/90 border-red-400";ic="cloud-lightning"}else if(c.wind_speed_10m>=75){w="STURM";col="bg-red-600/90 border-red-400";ic="wind"}else if(c.wind_speed_10m>=50){w="Windb√∂en";col="bg-orange-500/80 border-orange-400";ic="wind"}else if(c.temperature_2m<=3){w="Gl√§tte";col="bg-blue-600/80 border-blue-400";ic="snowflake"}else if(c.precipitation>=5){w="Starkregen";col="bg-blue-700/80 border-blue-400";ic="cloud-rain"}if(c.visibility<1000){w="Nebel";col="bg-gray-600/90 border-gray-400";ic="cloud-fog"}
        if(w){warningContainer.innerHTML=`<div onclick="showMotoDetails()" class="w-full ${col} border p-3 rounded-xl flex items-center justify-between shadow-lg animate-pulse-slow mb-4 text-white cursor-pointer"><div class="flex items-center gap-3 font-bold"><i data-lucide="${ic}" size="24"></i><span>${w}</span></div><i data-lucide="alert-circle" size="20"></i></div>`;warningContainer.classList.remove('hidden');}else warningContainer.classList.add('hidden'); lucide.createIcons(); }

        function toggleLegend() { document.getElementById('legendModal').classList.toggle('hidden'); lucide.createIcons(); }
        function closeHourlyModal() { document.getElementById('hourlyDetailsModal').classList.add('hidden'); }
        
        async function showDailyDetails(index = 0) { 
            try {
                if(!lastWeatherData) return; 
                const d = lastWeatherData.daily; 
                const c = lastWeatherData.current; 
                if(!d || !d.time || !d.time[index]) return;

                const date = new Date(d.time[index]);
                const dayName = index === 0 ? "Heute" : date.toLocaleDateString('de-DE', {weekday: 'long'});
                const dateStr = date.toLocaleDateString('de-DE', {day: 'numeric', month: 'long'});
                
                safeSetText('dailyDetailTitle', dayName);
                safeSetText('dailyDetailDate', dateStr);

                if(d.sunrise && d.sunrise[index]) safeSetText('detailSunrise', new Date(d.sunrise[index]).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})); 
                if(d.sunset && d.sunset[index]) safeSetText('detailSunset', new Date(d.sunset[index]).toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})); 
                
                const precipSum = (d.precipitation_sum && d.precipitation_sum[index] !== undefined) ? d.precipitation_sum[index] : 0;
                const precipProb = (d.precipitation_probability_max && d.precipitation_probability_max[index] !== undefined) ? d.precipitation_probability_max[index] : 0;
                
                safeSetText('detailPrecipSum', precipSum.toFixed(1));
                safeSetText('detailPrecipProb', precipProb);
                const probBar = document.getElementById('detailPrecipProbBar');
                if(probBar) probBar.style.width = precipProb + '%';
                
                const windMax = (d.wind_speed_10m_max && d.wind_speed_10m_max[index] !== undefined) ? d.wind_speed_10m_max[index] : '--';
                safeSetText('detailWindMax', windMax);
                const uvVal = (d.uv_index_max && d.uv_index_max[index] !== undefined) ? d.uv_index_max[index] : '--';
                safeSetText('detailUVMax', uvVal);

                const extras = document.getElementById('currentDayExtras');
                if(index === 0) {
                    safeSetText('detailVisibility', (c.visibility && c.visibility>9999)?">10 km":((c.visibility/1000).toFixed(1)+" km"));
                    safeSetText('detailUV', c.uv_index || "--");
                    if(extras) extras.classList.remove('hidden');
                    if(d.sunset && d.sunset[0]) {
                        const diff = new Date(d.sunset[0]) - new Date(); 
                        const cd = document.getElementById('sunCountdownText'); 
                        if(cd) {
                            if(diff>0) cd.innerText=`Noch ${Math.floor(diff/36e5)}h ${Math.floor((diff%36e5)/6e4)}m Licht`;
                            else cd.innerText="Dunkelheit";
                        }
                    }
                    try {
                        const r=await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${currentLat}&longitude=${currentLon}&current=european_aqi,pm10,pm2_5`);
                        const ad=await r.json(); const v=ad.current.european_aqi;
                        safeSetText('detailAqiVal', v);
                        let cl="bg-green-500"; if(v>40) cl="bg-yellow-400"; if(v>60) cl="bg-orange-500"; if(v>80) cl="bg-red-600";
                        const aqiBar = document.getElementById('detailAqiBar'); if(aqiBar) aqiBar.className=`w-2 h-2 rounded-full ${cl}`;
                    } catch(e) {}
                } else {
                    if(extras) extras.classList.add('hidden');
                }
                
                const score = calculateMotoScore(
                    d.temperature_2m_max[index] || 15, 
                    d.wind_speed_10m_max ? d.wind_speed_10m_max[index] : 10,
                    precipSum,
                    1, 
                    d.weather_code[index] || 0
                );
                const col = getScoreColor(score.score);
                const scoreEl = document.getElementById('dailyMotoScore');
                if(scoreEl) scoreEl.className = `mt-4 p-3 rounded-xl border border-slate-600/50 flex justify-between items-center bg-slate-800 ${col.bg} bg-opacity-20`;
                safeSetText('dailyScoreDetailVal', score.score + "/10");

                const modal = document.getElementById('dailyDetailsModal');
                if(modal) modal.classList.remove('hidden'); 
                lucide.createIcons(); 
            } catch(e) {
                console.error("Detail Error", e);
                const modal = document.getElementById('dailyDetailsModal');
                if(modal) modal.classList.remove('hidden');
            }
        }
        
        function getGearRecommendation(t,r) { let tx="Standard",ic="üß•"; if(t>26){tx="Sommer/Mesh";ic="üëï"}else if(t<10){tx="Winter/Thermo";ic="üß£"}else if(t<18){tx="Futter rein";ic="üß•"} if(r>0.5){tx+=" + Regen!";ic="‚òî"} return {text:tx,icon:ic}; }
        function showMotoDetails() { if(!lastWeatherData)return; const c=lastWeatherData.current; const ana=calculateMotoAnalysis(c.temperature_2m,c.wind_speed_10m,c.precipitation,c.is_day,c.weather_code); const l=document.getElementById('motoAnalysisList'); l.innerHTML=""; ana.pros.forEach(p=>l.innerHTML+=`<div class="flex items-center gap-3 p-2 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><i data-lucide="check-circle" class="text-emerald-400 flex-shrink-0" size="16"></i><span class="text-xs text-emerald-100">${p}</span></div>`); ana.cons.forEach(x=>l.innerHTML+=`<div class="flex items-center gap-3 p-2 bg-red-500/10 border border-red-500/30 rounded-xl"><i data-lucide="alert-triangle" class="text-red-400 flex-shrink-0" size="16"></i><span class="text-xs text-red-100">${x}</span></div>`); if(!ana.pros.length&&!ana.cons.length)l.innerHTML=`<div class="text-center text-slate-400 text-xs italic">Alles normal.</div>`; const g=getGearRecommendation(c.temperature_2m,c.precipitation); document.getElementById('gearText').innerText=g.text; document.getElementById('gearIcon').innerText=g.icon; document.getElementById('motoDetailsModal').classList.remove('hidden'); lucide.createIcons(); }
        function calculateMotoAnalysis(t,w,r,d,c) { let p=[],n=[]; if(t>=15&&t<=28)p.push("Top Temp");else if(t<5)n.push("Gl√§tte (<5¬∞)");else if(t<10)n.push("Kalt (<10¬∞)");else if(t>30)n.push("Hitze (>30¬∞)"); if(w<15)p.push("Wenig Wind");else if(w>40)n.push("B√∂en (>40kmh)"); if(r>0)n.push("Nass"); if(c<3)p.push("Gute Sicht"); if(d===0)n.push("Nacht");else p.push("Tag"); return {pros:p,cons:n}; }
        function calculateMotoScore(t,w,r,d,c) { let s=10,rs="Top"; if(t<0){s-=10;rs="Eis"}else if(t<5){s-=8;rs="Kalt"}else if(t<10){s-=5;rs="Frisch"}else if(t>35){s-=4;rs="Hitze"} if(c>=95){s-=10;rs="Gewitter"}else if(c>=66||c==71||c==73||c==75){s-=9;rs="Schnee"}else if(c>=61){s-=7;rs="Regen"}else if(c>=51){s-=4;rs="Niesel"} if(r>0.5){s-=5;rs="Nass"} if(w>60){s-=9;rs="Sturm"}else if(w>40){s-=5;rs="Windig"} if(d===0){s-=2;if(rs==="Top")rs="Nacht"} return {score:Math.max(0,Math.min(10,s)),reason:rs}; }
        function calculateDailyScore(h) { const off=(lastWeatherData.utc_offset_seconds||0)*1000; let ts=0,c=0; for(let i=0;i<h.time.length;i++){ if(new Date(new Date(h.time[i]).getTime()+off).toISOString().slice(0,10)!==new Date(Date.now()+off).toISOString().slice(0,10)) continue; if(h.is_day[i]){ ts+=calculateMotoScore(h.temperature_2m[i],h.wind_speed_10m[i],h.precipitation[i],h.is_day[i],h.weather_code[i]).score; c++; } } return c===0?"--":Math.round((ts/c)*10)/10; }
        function getScoreColor(s) { if(s>=8)return{bg:"border-emerald-500 text-emerald-400",hex:"#10b981"}; if(s>=5)return{bg:"border-yellow-500 text-yellow-400",hex:"#eab308"}; if(s>=3)return{bg:"border-orange-500 text-orange-400",hex:"#f97316"}; return{bg:"border-red-500 text-red-400",hex:"#ef4444"}; }
        
        function updateMainValues(t, app_t, w, h, r, c, d, txt, idx=0) {
            try {
                document.getElementById('temperature').innerText=Math.round(t); 
                // NEW: Update Feels Like
                safeSetText('feelsLike', Math.round(app_t));
                
                document.getElementById('windSpeed').innerText=w+" km/h"; document.getElementById('humidity').innerText=h+"%";
                const i=getWeatherInfo(c); document.getElementById('weatherDesc').innerText=i.t; document.getElementById('weatherIconContainer').innerHTML=`<i data-lucide="${i.i}" class="w-12 h-12"></i>`;
                const sc=calculateMotoScore(t,w,r,d,c); const col=getScoreColor(sc.score);
                const el=document.getElementById('motoScoreCircle'); el.className=`w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner ${col.bg}`;
                document.getElementById('motoScoreValue').innerText=sc.score; document.getElementById('motoScoreText').innerText=sc.reason;
                document.getElementById('timeLabel').innerText="Aktuell"; document.getElementById('timeLabel').classList.remove('opacity-0');
                if(lastWeatherData.daily && lastWeatherData.daily.temperature_2m_max[idx]!==undefined) { document.getElementById('tempMax').innerText=Math.round(lastWeatherData.daily.temperature_2m_max[idx]); document.getElementById('tempMin').innerText=Math.round(lastWeatherData.daily.temperature_2m_min[idx]); }
                updateWindArrow(); lucide.createIcons();
            } catch (e) { console.error("UpdateMain Error", e); }
        }

        function updateSunVisuals() {
            const suns = document.querySelectorAll('.sun-orb');
            if (!suns.length || !lastWeatherData || !lastWeatherData.daily) return;
            const now = Date.now(); 
            const sunrise = new Date(lastWeatherData.daily.sunrise[0]).getTime();
            const sunset = new Date(lastWeatherData.daily.sunset[0]).getTime();
            if (now < sunrise || now > sunset) return; 
            const pct = (now - sunrise) / (sunset - sunrise);
            const leftVal = (pct * 120) - 10;
            const sinVal = Math.sin(pct * Math.PI);
            const topVal = 100 - (sinVal * 90); 
            suns.forEach(sun => { sun.style.left = `${leftVal}%`; sun.style.top = `${topVal}%`; });
        }
        
        function triggerLightningLoop() {
            const layer = document.getElementById('lightningLayer');
            if(!layer) return;
            const nextStrike = Math.random() * 6000 + 2000;
            lightningTimeout = setTimeout(() => {
                layer.style.animation = 'none';
                layer.offsetHeight; 
                layer.style.animation = 'lightning-flash 0.6s linear';
                triggerLightningLoop();
            }, nextStrike);
        }

        function renderSplashEffects(c, d) {
            const con = document.getElementById('splashEffects');
            const loc = document.getElementById('splashLocalEffects');
            clearTimeout(lightningTimeout);
            let h = '';
            const isRain = [51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82, 95, 96, 99].includes(c);
            const isSnow = [71, 73, 75, 77, 85, 86].includes(c);
            const isFog = [45, 48].includes(c);
            const isStorm = [95, 96, 99].includes(c);
            const isCloudy = c > 0 || isRain || isSnow || isFog; 
            const isHeavyCloud = c === 3 || isRain || isSnow || isFog; 
            
            const isClear = (c === 0 || c === 1);

            if (isStorm) { triggerLightningLoop(); }
            if (d === 1) { 
                if (!isRain && !isSnow && !isFog) { 
                    h += `<div class="sun-orb" style="top: 100%; left: 0%;"></div>`; 
                } 
                // BIRDS LOGIC: Show birds if clear weather and day
                if (isClear && !isRain && !isSnow && !isFog) {
                    // Gruppe 1: Links -> Rechts (Standard)
                    h += `<div class="bird-container" style="top: 15%; animation: fly-across 45s linear infinite; animation-delay: 0s;">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:10px; left: 20px; animation-delay: 0.1s;"></div>
                           <div class="bird" style="top:-5px; left: 40px; animation-delay: 0.2s;"></div>
                         </div>`;
                    
                    // Gruppe 2: Links -> Rechts (Fern/Klein)
                    h += `<div class="bird-container" style="top: 30%; animation: fly-across 55s linear infinite; animation-delay: 20s; transform: scale(0.6);">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:15px; left: 15px;"></div>
                         </div>`;

                    // Gruppe 3: Rechts -> Links (Hoch/Schnell)
                    h += `<div class="bird-container" style="top: 10%; animation: fly-across-reverse 38s linear infinite; animation-delay: 5s;">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:8px; left: 15px; animation-delay: 0.1s;"></div>
                           <div class="bird" style="top:20px; left: -5px; animation-delay: 0.3s;"></div>
                           <div class="bird" style="top:12px; left: 30px; animation-delay: 0.2s;"></div>
                         </div>`;

                    // Gruppe 4: Rechts -> Links (Tief/Langsam)
                    h += `<div class="bird-container" style="top: 40%; animation: fly-across-reverse 60s linear infinite; animation-delay: 25s; transform: scale(0.8);">
                           <div class="bird" style="top:0; left: 0;"></div>
                           <div class="bird" style="top:5px; left: 20px;"></div>
                         </div>`;
                }
            } else { 
                for (let i = 0; i < 100; i++) { h += `<div class="star" style="top:${Math.random()*60}%;left:${Math.random()*100}%;width:${1+Math.random()*2}px;height:${1+Math.random()*2}px;animation-delay:${Math.random()*2}s;opacity:${0.3+Math.random()*0.7}"></div>`; } 
            }
            
            // WOLKEN (Mehr & Besser sichtbar)
            if (isCloudy && !isFog) {
                h += `<div class="cloud-shape" style="top:10%; left:-5%; width:100vw; height:35vh; animation-duration:22s; opacity:0.6;"></div>`;
                h += `<div class="cloud-shape" style="top:25%; right:-15%; width:90vw; height:30vh; animation-duration:28s; animation-direction:reverse; opacity:0.5;"></div>`;
                if (isHeavyCloud) {
                      h += `<div class="cloud-shape" style="top:-5%; left:20%; width:110vw; height:40vh; animation-duration:32s; opacity:0.4;"></div>`;
                      h += `<div class="cloud-shape" style="bottom:35%; left:-20%; width:110vw; height:45vh; animation-duration:38s; opacity:0.3;"></div>`;
                }
            }

            // NIEDERSCHLAG (Regen/Schnee/Nebel)
            if (isRain) {
                let count = 30; // Basis (Leicht)
                let speedBase = 0.8; 
                if ([53, 63, 81].includes(c)) { count = 80; speedBase = 0.7; }
                if ([55, 65, 66, 67, 82, 95, 96, 99].includes(c)) { count = 150; speedBase = 0.6; }
                for (let i = 0; i < count; i++) {
                    const speed = speedBase + Math.random() * 0.5;
                    h += `<div class="rain-drop" style="left:${Math.random()*100}%; animation-delay:${Math.random()}s; animation-duration:${speed}s"></div>`;
                }
            } else if (isSnow) {
                for (let i = 0; i < 30; i++) {
                    h += `<div class="snowflake" style="left:${Math.random()*100}%; animation-delay:${Math.random()*2}s; animation-duration:${3+Math.random()*2}s; opacity:${Math.random()}"></div>`;
                }
            } else if (isFog) {
                h += `<div class="fog-layer"></div>`;
            }

            if (con) con.innerHTML = h; if (loc) loc.innerHTML = h;
        }
        
        function renderRainChart(minutely15) {
            const container = document.getElementById('rainBarsContainer');
            if (!minutely15 || !minutely15.precipitation || minutely15.precipitation.length < 4) { container.innerHTML = '<div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">Keine Daten</div>'; return; }
            container.innerHTML = '';
            let startIndex = 0;
            const now = Date.now();
            if(minutely15.time) {
                for(let j=0; j<minutely15.time.length; j++) {
                    if(new Date(minutely15.time[j]).getTime() >= now - 15*60*1000) { 
                        startIndex = j; break; 
                    }
                }
            }
            for(let i=0; i<4; i++) {
                const dataIndex = startIndex + i;
                if (dataIndex >= minutely15.precipitation.length) break;
                const val = minutely15.precipitation[dataIndex];
                const height = Math.min(100, (val / 2.0) * 100); 
                const color = val > 1.0 ? "bg-blue-500" : "bg-blue-300/70";
                container.innerHTML += `<div class="w-1/4 h-full flex flex-col justify-end items-center gap-1"><div class="w-full rounded-t-md ${color} rain-bar" style="height: ${Math.max(5, height)}%"></div><span class="text-[9px] text-slate-400">${val > 0 ? val.toFixed(1) : '0'}</span></div>`;
            }
        }

        function render7Day() {
            const con = document.getElementById('forecast7List'); con.innerHTML='';
            const d = lastWeatherData.daily; if(!d) return;
            for(let i=0; i<d.time.length; i++) {
                const date = new Date(d.time[i]);
                const day = date.toLocaleDateString('de-DE', {weekday:'long'});
                const code = d.weather_code[i];
                const min = Math.round(d.temperature_2m_min[i]);
                const max = Math.round(d.temperature_2m_max[i]);
                const info = getWeatherInfo(code);
                con.innerHTML += `<div onclick="showDailyDetails(${i})" class="flex items-center justify-between bg-slate-800/40 p-3 rounded-xl border border-slate-700/50 cursor-pointer hover:bg-slate-700/50 transition active:scale-95"><span class="w-24 font-bold text-sm">${i===0?'Heute':day}</span><div class="flex items-center gap-2 text-blue-200"><i data-lucide="${info.i}" size="18"></i><span class="text-xs w-20 truncate">${info.t}</span></div><div class="flex gap-3 text-sm font-mono"><span class="text-blue-400">${min}¬∞</span><span class="text-slate-500">/</span><span class="text-red-400">${max}¬∞</span></div></div>`;
            }
            lucide.createIcons();
        }
        
        function initRadarMap() {
            const container = document.getElementById('radarMap');
            if(!container) return;
            if (radarMap) { radarMap.setView([currentLat, currentLon], 8); updateMarker(); return; }
            radarMap = L.map('radarMap', { zoomControl: false, attributionControl: true }).setView([currentLat, currentLon], 8);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OSM &copy; CARTO &copy; RainViewer', subdomains: 'abcd', maxZoom: 20 }).addTo(radarMap);
            updateMarker();
            fetchRadarData();
        }
        
        function updateMarker() {
            if(!radarMap) return;
            if(radarMarker) radarMap.removeLayer(radarMarker);
            const icon = L.divIcon({ className: 'custom-div-icon', html: "<div style='background-color:#ef4444; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow:0 0 10px #ef4444;'></div>", iconSize: [12, 12], iconAnchor: [6, 6] });
            radarMarker = L.marker([currentLat, currentLon], {icon: icon}).addTo(radarMap);
        }

        async function fetchRadarData() {
            try {
                const response = await fetch('https://api.rainviewer.com/public/weather-maps.json');
                const data = await response.json();
                if (data.radar && data.radar.past) {
                    radarTimestamps = data.radar.past;
                    const nowIndex = radarTimestamps.length - 1;
                    if (data.radar.nowcast) { radarTimestamps = radarTimestamps.concat(data.radar.nowcast); }
                    const timeline = document.getElementById('radarTimeline');
                    if(timeline) { timeline.max = radarTimestamps.length - 1; timeline.value = nowIndex; }
                    currentRadarIndex = nowIndex;
                    showRadarFrame(currentRadarIndex);
                    updatePlayButtonIcon(); 
                }
            } catch (e) { console.error("Radar fetch failed", e); document.getElementById('radarTimeLabel').innerText = "Offline"; }
        }

        function startRadarAnimation() {
            if (radarAnimationInterval) clearInterval(radarAnimationInterval);
            isRadarPlaying = true;
            updatePlayButtonIcon();
            if (!radarAnimationInterval) {
                 radarAnimationInterval = setInterval(() => {
                    currentRadarIndex = (currentRadarIndex + 1) % radarTimestamps.length;
                    showRadarFrame(currentRadarIndex);
                }, 800);
            }
        }
        
        function stopRadarAnimation() {
            if (radarAnimationInterval) { clearInterval(radarAnimationInterval); radarAnimationInterval = null; }
            isRadarPlaying = false;
            updatePlayButtonIcon();
        }
        
        function toggleRadarPlayback() { if (isRadarPlaying) { stopRadarAnimation(); } else { startRadarAnimation(); } }
        function updatePlayButtonIcon() { const btn = document.getElementById('radarPlayBtn'); if(btn) { btn.innerHTML = isRadarPlaying ? '<i data-lucide="pause" size="16"></i>' : '<i data-lucide="play" size="16"></i>'; lucide.createIcons(); } }
        function handleRadarScrub(val) { stopRadarAnimation(); currentRadarIndex = parseInt(val); showRadarFrame(currentRadarIndex); }

        function showRadarFrame(index) {
            if (!radarMap || !radarTimestamps[index]) return;
            const tsObj = radarTimestamps[index];
            const time = new Date(tsObj.time * 1000);
            const hours = time.getHours().toString().padStart(2, '0');
            const minutes = time.getMinutes().toString().padStart(2, '0');
            document.getElementById('radarTimeLabel').innerText = `${hours}:${minutes}`;
            const timeline = document.getElementById('radarTimeline');
            if(timeline && isRadarPlaying) { timeline.value = index; }
            const layerUrl = `https://tilecache.rainviewer.com${tsObj.path}/256/{z}/{x}/{y}/2/1_1.png`;
            const newLayer = L.tileLayer(layerUrl, { opacity: 0.7, zIndex: 100 });
            newLayer.addTo(radarMap);
            radarLayers[tsObj.time] = newLayer;
            Object.keys(radarLayers).forEach(key => { if (parseInt(key) !== tsObj.time) { if (radarMap.hasLayer(radarLayers[key])) { radarMap.removeLayer(radarLayers[key]); } delete radarLayers[key]; } });
        }

        function updateRadar(){ if(typeof L !== 'undefined') { initRadarMap(); } }
        function toggleFullscreen(){ const c=document.getElementById('radarSection'); isFullscreen=!isFullscreen; if(isFullscreen){ c.classList.add('radar-fullscreen'); document.getElementById('fullscreenIcon').setAttribute('data-lucide','x'); document.body.style.overflow='hidden'; }else{ c.classList.remove('radar-fullscreen'); document.getElementById('fullscreenIcon').setAttribute('data-lucide','maximize-2'); document.body.style.overflow=''; } lucide.createIcons(); setTimeout(() => { if(radarMap) radarMap.invalidateSize(); }, 300); }
        
        function updateUI(name, fromCache=false) {
            try {
                if(name) document.getElementById('cityName').innerText=name; const cur=lastWeatherData.current;
                document.getElementById('splashCity').innerText=name||"Unbekannt"; document.getElementById('splashTemp').innerText=Math.round(cur.temperature_2m);
                const info=getWeatherInfo(cur.weather_code); document.getElementById('splashIcon').innerHTML=`<i data-lucide="${info.i}" class="w-24 h-24"></i>`; document.getElementById('splashDesc').innerText=info.t;
                renderSplashEffects(cur.weather_code, cur.is_day);
                updateSunVisuals(); 
                // PASS NEW PARAMETER
                updateMainValues(
                    cur.temperature_2m, 
                    cur.apparent_temperature, // NEW
                    cur.wind_speed_10m, 
                    cur.relative_humidity_2m, 
                    cur.precipitation, 
                    cur.weather_code, 
                    cur.is_day, 
                    0
                );
                checkWarnings(cur); 
                if(!fromCache) checkAndSendNotification(calculateMotoScore(cur.temperature_2m, cur.wind_speed_10m, cur.precipitation, cur.is_day, cur.weather_code).score);
                if (lastWeatherData.hourly) document.getElementById('dailyScoreValue').innerText=calculateDailyScore(lastWeatherData.hourly)+" / 10";
                renderRainChart(lastWeatherData.minutely_15); renderHourly(); render7Day(); applyLayout();
                document.getElementById('startPrompt').classList.add('hidden'); 
                document.getElementById('dynamicContent').classList.remove('hidden'); 
                loadingIndicator.classList.add('hidden'); updateRadar();
                if(isFirstLoad) { document.getElementById('splashScreen').classList.remove('splash-hidden'); isFirstLoad=false; }
            } catch (e) { console.error("UpdateUI Error", e); loadingIndicator.classList.add('hidden'); }
        }

        async function fetchWeather(name, country, isBackground = false) { // UPDATED: Background flag
            if(!isBackground) { loadingIndicator.classList.remove('hidden'); offlineBanner.classList.add('hidden'); }
            
            // Store for auto-refresh
            currentCityName = name; 
            currentCountry = country;

            // Reset refresh timer to align with manual fetches
            if(refreshTimer) clearInterval(refreshTimer);
            refreshTimer = setInterval(() => {
                if(!document.hidden) {
                    console.log("Auto-refreshing weather...");
                    fetchWeather(currentCityName, currentCountry, true);
                }
            }, 300000); // 5 Minutes (300,000 ms)

            // Added apparent_temperature to current fetch
            const url=`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,apparent_temperature,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation,is_day,visibility,uv_index&hourly=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,is_day&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_sum,precipitation_probability_max,wind_speed_10m_max,uv_index_max&minutely_15=precipitation&forecast_days=7&timezone=auto&_t=${Date.now()}`;
            try { const r=await fetch(url); if(!r.ok)throw new Error(); lastWeatherData=await r.json(); saveToCache(name, lastWeatherData); updateUI(name); }
            catch(e) { 
                if(!isBackground) { // Only show errors if user initiated
                    const c=loadFromCache(); if(c){ lastWeatherData=c.data; offlineBanner.innerText="Offline"; offlineBanner.classList.remove('hidden'); updateUI(c.name,true); } else { document.getElementById('errorMessage').classList.remove('hidden'); loadingIndicator.classList.add('hidden'); } 
                }
            }
        }

        // --- LOCATEME DEFINITION MOVED HERE ---
        function locateMe(silent=false) {
            if(!navigator.geolocation){ console.log("Kein GPS Support"); fetchWeather("Berlin", ""); return; } 
            if(!silent){ document.getElementById('loadingIndicator').classList.remove('hidden'); initCompass(); }
            navigator.geolocation.getCurrentPosition(async p=>{
                currentLat=p.coords.latitude; currentLon=p.coords.longitude;
                if(document.getElementById('splashCity')) document.getElementById('splashCity').innerText="Suche Ort...";
                let n=null;
                try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${currentLat}&longitude=${currentLon}&language=de&format=json`);const d=await r.json(); if(d.results&&d.results[0]) n=d.results[0].name||d.results[0].city||d.results[0].town||d.results[0].village||d.results[0].suburb||d.results[0].hamlet;}catch(e){}
                if(!n) { try{ const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLat}&lon=${currentLon}&format=json&accept-language=de`, {headers:{'User-Agent':'WetterApp/2.5'}}); const d=await r.json(); if(d.address) n=d.address.city||d.address.town||d.address.village||d.address.hamlet||d.address.suburb||d.address.neighbourhood||d.address.county; }catch(e){} }
                if(!n) n = `${currentLat.toFixed(2)}, ${currentLon.toFixed(2)}`;
                fetchWeather(n,"");
            },()=>{ 
                document.getElementById('loadingIndicator').classList.add('hidden'); 
                console.warn("Standort Zugriff blockiert oder abgebrochen.");
                if(!silent) { document.getElementById('cityName').innerText = "Berlin (Demo)"; currentLat = 52.52; currentLon = 13.41; fetchWeather("Berlin", ""); } else { document.getElementById('gpsErrorPrompt').classList.remove('hidden'); } 
            }, {timeout:10000,enableHighAccuracy:true});
        }
        window.locateMe = locateMe; // Expose globally

        async function searchCity() {
            const v=cityInput.value.trim(); if(!v)return; suggestionsList.classList.add('hidden'); errorMessage.classList.add('hidden'); loadingIndicator.classList.remove('hidden');
            try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=10&language=de&format=json`);const d=await r.json(); if(!d.results)throw new Error(); const l=d.results[0]; currentLat=l.latitude; currentLon=l.longitude; fetchWeather(l.name,l.country);}catch(e){loadingIndicator.classList.add('hidden');errorMessage.classList.remove('hidden');setTimeout(()=>errorMessage.classList.add('hidden'),3000);}
        }

        cityInput.addEventListener('input',e=>{clearTimeout(debounceTimer);const v=e.target.value.trim();if(v.length<2){suggestionsList.classList.add('hidden');return;	debounceTimer=setTimeout(async()=>{try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=5&language=de&format=json`);const d=await r.json();suggestionsList.innerHTML='';if(d.results){d.results.forEach(p=>{const el=document.createElement('div');el.className="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50";el.innerHTML=`<span class="font-bold text-white text-sm">${p.name}</span><span class="text-xs text-slate-400 ml-2">${p.admin1||''}</span>`;el.onclick=()=>{cityInput.value=p.name;suggestionsList.classList.add('hidden');cityInput.blur();currentLat=p.latitude;currentLon=p.longitude;fetchWeather(p.name,p.country);};suggestionsList.appendChild(el);});suggestionsList.classList.remove('hidden');}else suggestionsList.classList.add('hidden');}catch(e){}},300);}});
        document.addEventListener('click',e=>{if(!cityInput.contains(e.target)&&!suggestionsList.contains(e.target))suggestionsList.classList.add('hidden');});
        
        function selectHour(i){
            const h=lastWeatherData.hourly; const t=Math.round(h.temperature_2m[i]); const c=h.weather_code[i]; const d=new Date(h.time[i]);
            const s=calculateMotoScore(t,h.wind_speed_10m[i],h.precipitation[i],h.is_day[i],c); const cl=getScoreColor(s.score);
            document.getElementById('modalTime').innerText=`${d.toLocaleDateString('de-DE',{weekday:'long'})} ${d.getHours()}:00`;
            document.getElementById('modalTemp').innerText=t; document.getElementById('modalDesc').innerText=getWeatherInfo(c).t;
            document.getElementById('modalIcon').innerHTML=`<i data-lucide="${getWeatherInfo(c).i}" size="48"></i>`;
            document.getElementById('modalWind').innerText=h.wind_speed_10m[i]+" km/h"; document.getElementById('modalRain').innerText=h.precipitation[i]+" mm"; document.getElementById('modalHum').innerText=h.relative_humidity_2m[i]+"%";
            document.getElementById('modalScoreVal').innerText=s.score; document.getElementById('modalScoreBg').className=`rounded-xl p-3 border flex items-center justify-between ${cl.bg} bg-slate-900/50`;
            document.getElementById('hourlyDetailsModal').classList.remove('hidden'); lucide.createIcons();
        }

        function renderHourly(){
            const c=document.getElementById('hourlyContainer'); c.innerHTML=''; const h=lastWeatherData.hourly;
            const off=(lastWeatherData.utc_offset_seconds||0)*1000; const start=h.time.findIndex(t=>t.startsWith(new Date(Date.now()+off).toISOString().slice(0,13)))||0;
            for(let i=start; i<start+24; i++){
                if(!h.time[i])break; const hr=new Date(h.time[i]).getHours(); const t=Math.round(h.temperature_2m[i]);
                const sc=calculateMotoScore(t,h.wind_speed_10m[i],h.precipitation[i],h.is_day[i],h.weather_code[i]);
                const col=getScoreColor(sc.score); const ic=getWeatherInfo(h.weather_code[i]).i;
                const act=(i===start)?"bg-slate-700 border-blue-500/50":"bg-slate-800/50 border-transparent";
                const dnI=h.is_day[i]===1?"sun":"moon"; 
                const dnC=h.is_day[i]===1?"text-orange-100/20":"text-slate-400/10";
                c.innerHTML+=`<div onclick="selectHour(${i})" class="relative hour-card cursor-pointer snap-start flex-shrink-0 w-24 p-2 rounded-xl border ${act} flex flex-col items-center justify-between h-32 hover:bg-slate-700 transition-all"><div class="absolute top-1 right-1 ${dnC}"><i data-lucide="${dnI}" size="8"></i></div><span class="text-xs text-slate-400 font-mono text-center leading-tight">${hr}:00</span><div class="text-blue-200"><i data-lucide="${ic}" size="20"></i></div><span class="text-sm font-bold">${t}¬∞</span><div class="w-full flex justify-center mt-1"><div class="h-1.5 w-8 rounded-full ${col.bg.replace('text-','bg-').split(' ')[1]}"></div></div></div>`;
            } lucide.createIcons();
        }

        function getWeatherInfo(c){const m={0:{t:"Klar",i:"sun"},1:{t:"Heiter",i:"sun"},2:{t:"Wolkig",i:"cloud-sun"},3:{t:"Bedeckt",i:"cloud"},45:{t:"Nebel",i:"cloud-fog"},48:{t:"Nebel",i:"cloud-fog"},51:{t:"Niesel",i:"cloud-drizzle"},53:{t:"Niesel",i:"cloud-drizzle"},55:{t:"Niesel",i:"cloud-drizzle"},56:{t:"Gefrier. Niesel",i:"cloud-drizzle"},57:{t:"Gefrier. Niesel",i:"cloud-drizzle"},61:{t:"Regen",i:"cloud-rain"},63:{t:"Regen",i:"cloud-rain"},65:{t:"Starkregen",i:"cloud-rain"},66:{t:"Gefrier. Regen",i:"cloud-hail"},67:{t:"Gefrier. Regen",i:"cloud-hail"},71:{t:"Schnee",i:"snowflake"},73:{t:"Schnee",i:"snowflake"},75:{t:"Schnee",i:"snowflake"},77:{t:"Schneegriesel",i:"snowflake"},80:{t:"Schauer",i:"cloud-rain-wind"},81:{t:"Schauer",i:"cloud-rain-wind"},82:{t:"Starkschauer",i:"cloud-rain-wind"},85:{t:"Schneeschauer",i:"snowflake"},86:{t:"Schneeschauer",i:"snowflake"},95:{t:"Gewitter",i:"cloud-lightning"},96:{t:"Gewitter",i:"cloud-lightning"},99:{t:"Gewitter",i:"cloud-lightning"}}; return m[c]||{t:"Unbekannt",i:"help-circle"};}
        
        function startClock(){
            const c=document.getElementById('liveClock');
            if(c)c.innerText=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
            updateSunVisuals();
            if(clockInterval)clearInterval(clockInterval);
            clockInterval=setInterval(()=>{
                if(c)c.innerText=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});
                updateSunVisuals();
            },1000);
        }
        startClock(); document.addEventListener('DOMContentLoaded', ()=>{ if(typeof locateMe === 'function') locateMe(true); });
    </script>
</body>
</html>
