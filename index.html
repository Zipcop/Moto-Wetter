<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <meta name="apple-mobile-web-app-title" content="Wetter">
    
    <link rel="apple-touch-icon" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    <link rel="icon" type="image/png" href="https://img.icons8.com/fluency/512/weather.png?v=2">
    
    <title>Wetter Live</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        html, body { overscroll-behavior-y: none; -webkit-tap-highlight-color: transparent; }
        body { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); padding-left: 1rem; padding-right: 1rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; color: white; overflow-x: hidden; }
        
        /* Z-INDEX LAYERING */
        #globalEffects { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
        main { position: relative; z-index: 10; }
        #splashScreen { 
            position: fixed; inset: 0; z-index: 100; 
            background: rgba(15, 23, 42, 0.98); backdrop-filter: blur(20px);
            transition: transform 0.6s cubic-bezier(0.33, 1, 0.68, 1), opacity 0.6s ease-out;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; padding: 2.5rem; overflow: hidden;
        }
        .splash-hidden { transform: translateY(-100%); opacity: 0; pointer-events: none; }
        #splashLocalEffects { position: absolute; inset: 0; z-index: 0; pointer-events: none; }
        .splash-content { position: relative; z-index: 10; }

        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glass-btn { background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(12px); border: 1px solid rgba(71, 85, 105, 1); color: white; }
        .loader { border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 3px solid #3b82f6; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .custom-scrollbar::-webkit-scrollbar { height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        input[type="search"]::-webkit-search-cancel-button { -webkit-appearance: none; }
        .radar-fullscreen { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 50; background: #0f172a; border-radius: 0 !important; padding: env(safe-area-inset-top) 0 calc(env(safe-area-inset-bottom) + 40px) 0; margin: 0 !important; }
        .live-dot { width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; display: inline-block; margin-right: 6px; animation: pulse-red 2s infinite; }
        
        .hour-card-active { background-color: rgba(59, 130, 246, 0.2) !important; border-color: rgba(59, 130, 246, 0.8) !important; transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .hour-card-night { background-color: rgba(10, 15, 30, 0.9) !important; border-color: rgba(255,255,255,0.05) !important; } 
        .modal-overlay { cursor: pointer; }
        .modal-content { cursor: default; }
        #suggestionsList { z-index: 100 !important; }
        .animate-pulse-slow { animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .rain-bar { transition: height 0.5s ease-out; }

        /* Animations */
        @keyframes floatUp { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        .animate-float-up { animation: floatUp 0.8s ease-out forwards; }
        .delay-100 { animation-delay: 0.1s; }
        .delay-200 { animation-delay: 0.2s; }
        .delay-300 { animation-delay: 0.3s; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-bounce-slow { animation: bounce-slow 2s infinite; }
        
        /* Splash FX */
        @keyframes rain-fall { 0% { transform: translateY(-10vh); } 100% { transform: translateY(110vh); } }
        .rain-drop { position: absolute; width: 2px; height: 15px; background: rgba(255,255,255,0.3); top: -20px; animation: rain-fall 0.8s linear infinite; }
        @keyframes snow-fall { 0% { transform: translateY(-10vh) translateX(0); opacity: 0; } 20% { opacity: 1; } 100% { transform: translateY(110vh) translateX(20px); opacity: 0.3; } }
        .snowflake { position: absolute; width: 6px; height: 6px; background: white; border-radius: 50%; top: -10px; filter: blur(1px); animation: snow-fall 4s linear infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.4; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }
        .star { position: absolute; background: white; border-radius: 50%; animation: twinkle 3s infinite ease-in-out; box-shadow: 0 0 6px rgba(255,255,255,0.9); }
        @keyframes fog-drift { 0% { transform: translateX(-10%); opacity: 0.2; } 50% { transform: translateX(10%); opacity: 0.5; } 100% { transform: translateX(-10%); opacity: 0.2; } }
        .fog-layer { position: absolute; left: -20%; right: -20%; height: 100px; background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.1), transparent); filter: blur(20px); animation: fog-drift 8s infinite ease-in-out; }
        @keyframes cloud-drift { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }
        .cloud-shape { position: absolute; background: radial-gradient(circle, rgba(255,255,255,0.4) 0%, transparent 70%); width: 800px; height: 300px; border-radius: 50%; filter: blur(35px); animation: cloud-drift 40s linear infinite; }
        .sun-glow { position: absolute; top: -50px; right: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(253, 224, 71, 0.4) 0%, transparent 70%); filter: blur(30px); animation: pulse 4s infinite; }
        .compass-active { border-color: #3b82f6; box-shadow: 0 0 8px rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="flex flex-col items-center">

    <!-- BACKGROUND EFFECTS (Z-0) -->
    <div id="splashEffects"></div>

    <!-- SPLASH SCREEN (Z-100) -->
    <div id="splashScreen">
        <div id="splashLocalEffects"></div>
        <div class="mt-10 text-center opacity-0 animate-float-up splash-content">
            <div class="flex items-center justify-center gap-2 text-blue-300 mb-2 uppercase tracking-widest text-xs font-bold">
                <i data-lucide="map-pin" size="14"></i> Aktueller Standort
            </div>
            <h1 id="splashCity" class="text-4xl font-bold tracking-tight drop-shadow-lg">Ortung...</h1>
        </div>
        <div class="flex flex-col items-center justify-center opacity-0 animate-float-up delay-100 splash-content">
            <div id="splashIcon" class="mb-4 transform scale-150 drop-shadow-2xl text-blue-200"><div class="loader border-t-white/50"></div></div>
            <div class="text-8xl font-black tracking-tighter drop-shadow-xl"><span id="splashTemp">--</span><span class="text-4xl align-top text-blue-200/80">Â°</span></div>
            <div id="splashDesc" class="text-xl font-medium text-blue-100/80 mt-2">Einen Moment...</div>
        </div>
        <div class="mb-10 flex flex-col items-center gap-2 opacity-0 animate-float-up delay-200 cursor-pointer splash-content" onclick="dismissSplash()">
            <span class="text-xs font-medium text-white/50 uppercase tracking-wider">Zum Starten wischen</span>
            <div class="bg-white/10 p-3 rounded-full backdrop-blur-md animate-bounce-slow hover:bg-white/20 transition"><i data-lucide="chevron-up" class="text-white"></i></div>
        </div>
    </div>

    <!-- MAIN CONTENT (Z-10) -->
    <main class="w-full max-w-lg space-y-4 pt-4 pb-10 relative z-10">
        <div class="glass-panel rounded-2xl p-4 shadow-xl z-20 relative">
            <div class="flex justify-between items-center mb-3">
                <h1 class="text-sm font-bold text-blue-200 uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="bike" size="16"></i> Wetter
                </h1>
                <div class="flex items-center gap-3">
                    <button onclick="toggleSettings()" class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative" title="Layout"><i data-lucide="settings-2" size="18"></i></button>
                    <button onclick="enableNotifications()" id="notifyBtn" class="text-slate-400 hover:text-white transition p-1.5 rounded-full hover:bg-slate-700/50 relative"><i data-lucide="bell" size="18"></i><span id="notifyBadge" class="hidden absolute top-0 right-0 w-2 h-2 bg-blue-500 rounded-full"></span></button>
                </div>
            </div>
            <form onsubmit="event.preventDefault(); searchCity();" class="flex gap-2 relative">
                <div class="relative flex-grow">
                    <input type="search" id="cityInput" placeholder="Stadt eingeben..." class="w-full bg-slate-800/50 border border-slate-600 rounded-xl py-3 px-4 text-white placeholder-slate-400 focus:outline-none focus:border-blue-500 transition appearance-none" autocomplete="off">
                    <div id="suggestionsList" class="hidden absolute top-full left-0 right-0 mt-2 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl overflow-hidden max-h-60 overflow-y-auto"></div>
                </div>
                <button type="submit" class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="search"></i></button>
                <button type="button" onclick="locateMe()" class="glass-btn p-3 rounded-xl transition shadow-lg touch-manipulation flex-shrink-0"><i data-lucide="map-pin"></i></button>
            </form>
            <div id="cityName" class="text-xl font-bold mt-4 text-center tracking-wide text-blue-100">--</div>
            <div id="offlineBanner" class="hidden flex items-center justify-center gap-2 text-[10px] text-orange-300 font-bold mb-1 bg-orange-500/20 rounded py-1 px-3 mx-auto w-fit animate-pulse cursor-pointer hover:bg-orange-500/30 transition" onclick="fetchWeather(lastWeatherData?.name || 'Standort', '')">
                <span>OFFLINE-MODUS</span> <i data-lucide="refresh-cw" size="10"></i>
            </div>
            <div id="timeLabel" class="text-xs text-slate-400 text-center uppercase tracking-wider mb-1 font-semibold opacity-0 transition-opacity duration-300">Aktuell</div>
            <div id="errorMessage" class="hidden text-red-400 text-center text-sm mt-2 font-semibold bg-red-500/10 p-2 rounded-lg border border-red-500/20">Stadt nicht gefunden.</div>
        </div>
        
        <div id="loadingIndicator" class="hidden flex justify-center py-10"><div class="loader"></div></div>
        <div id="gpsErrorPrompt" class="hidden text-center py-10 animate-fade-in">
             <div class="bg-slate-800/50 p-4 rounded-2xl inline-flex flex-col items-center gap-3 border border-slate-600/50">
                 <i data-lucide="map-off" size="32" class="text-slate-400"></i>
                 <p class="text-sm text-slate-300">Standortzugriff verweigert</p>
                 <button onclick="locateMe()" class="glass-btn text-xs font-bold py-2 px-4 rounded-xl transition">Erneut versuchen</button>
             </div>
        </div>

        <div id="warningContainer" class="hidden w-full max-w-lg animate-fade-in"></div>

        <div id="dynamicContent" class="hidden w-full max-w-lg space-y-4 animate-fade-in">
            <div id="statusSection" class="grid grid-cols-2 gap-4 transition-all duration-300">
                <div id="card-weather" onclick="showDailyDetails()" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 relative group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="maximize-2" size="12"></i></div>
                    <div id="weatherIconContainer" class="mb-1 text-blue-300"><i data-lucide="cloud" size="40"></i></div>
                    <div class="text-4xl font-bold mb-1"><span id="temperature">--</span>Â°</div>
                    <div id="weatherDesc" class="text-xs text-slate-300">--</div>
                    <div class="flex gap-4 text-sm font-semibold text-blue-200 mt-2 mb-2">
                        <span class="flex items-center"><i data-lucide="arrow-up" size="14" class="mr-1 text-red-400"></i><span id="tempMax">--</span>Â°</span>
                        <span class="flex items-center"><i data-lucide="arrow-down" size="14" class="mr-1 text-blue-400"></i><span id="tempMin">--</span>Â°</span>
                    </div>
                    <div class="flex gap-3 mt-1 text-xs text-slate-400">
                        <span class="flex items-center gap-1"><div class="bg-slate-700 border border-slate-600 rounded-full p-1 transform transition-transform duration-700" id="windDirArrow"><i data-lucide="arrow-up" size="12" class="text-blue-200"></i></div><span id="windSpeed">--</span></span>
                        <span class="flex items-center gap-1"><i data-lucide="droplets" size="12"></i> <span id="humidity">--</span></span>
                    </div>
                </div>
                <div id="card-moto" onclick="showMotoDetails()" class="glass-panel rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden transition-all duration-300 active:scale-95 cursor-pointer hover:bg-white/5 group">
                    <div class="absolute top-2 right-2 text-slate-500 opacity-0 group-hover:opacity-100 transition"><i data-lucide="info" size="12"></i></div>
                    <h3 class="text-xs font-bold uppercase tracking-wider text-slate-400 mb-2">Moto Index</h3>
                    <div id="motoScoreCircle" class="w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner"><span id="motoScoreValue" class="text-2xl font-black">--</span></div>
                    <div id="motoScoreText" class="text-xs font-semibold mb-2">--</div>
                    <div class="border-t border-slate-600/50 w-full pt-2 mt-1"><div class="flex justify-between items-center px-1 text-xs"><span class="text-slate-400">Heute Ã˜</span><span id="dailyScoreValue" class="font-bold text-blue-100">--</span></div></div>
                </div>
            </div>
            
            <div id="rainChartSection" class="glass-panel rounded-2xl p-4">
                <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300 mb-3"><i data-lucide="umbrella" size="16"></i> Niederschlag (1h)</h3>
                <div class="flex justify-between items-end h-24 gap-2" id="rainBarsContainer"><div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">Keine Daten</div></div>
                <div class="flex justify-between text-[10px] text-slate-500 mt-1 px-1"><span>Jetzt</span><span>15m</span><span>30m</span><span>45m</span></div>
            </div>

            <div id="radarSection" class="glass-panel rounded-2xl overflow-hidden shadow-lg transition-all duration-300 flex flex-col">
                <div class="bg-slate-800/80 p-3 flex justify-between items-center border-b border-slate-700 shrink-0">
                    <h3 class="text-sm font-semibold flex items-center gap-2"><i data-lucide="map" size="16" class="text-blue-400"></i><span id="radarTitle">Regen (Vorschau)</span></h3>
                    <div class="flex items-center gap-2">
                        <button onclick="toggleLayerMenu()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation flex items-center gap-2"><i data-lucide="layers" size="16"></i></button>
                        <button onclick="toggleFullscreen()" class="p-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white transition touch-manipulation"><i id="fullscreenIcon" data-lucide="maximize-2" size="16"></i></button>
                    </div>
                </div>
                <div id="radarFrameContainer" class="relative w-full h-96 bg-slate-900 transition-all duration-300 grow">
                    <iframe id="radarFrame" class="w-full h-full border-none" src=""></iframe>
                    <div class="absolute top-4 left-4 bg-slate-900/80 backdrop-blur-md px-3 py-1.5 rounded-full border border-slate-700/50 flex items-center shadow-lg pointer-events-none z-10"><div class="live-dot"></div><span class="text-[10px] text-slate-400 mr-2 uppercase tracking-wider">Live</span><span id="liveClock" class="text-xs font-mono font-bold text-white tracking-wider">--:--</span></div>
                    <div id="radarOverlay" class="absolute inset-0 pointer-events-none border border-slate-700/20"></div>
                </div>
            </div>
            <div id="timelineSection" class="glass-panel rounded-2xl p-4 transition-all duration-300">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-semibold flex items-center gap-2 text-slate-300"><i data-lucide="clock" size="16"></i> Vorhersage</h3>
                    <button onclick="toggleLegend()" class="text-slate-400 hover:text-white transition p-1 bg-slate-800/50 rounded-full hover:bg-slate-700"><i data-lucide="info" size="16"></i></button>
                </div>
                <div id="hourlyContainer" class="flex overflow-x-auto gap-3 pb-2 custom-scrollbar snap-x touch-pan-x"></div>
            </div>
        </div>
        
        <div id="startPrompt" class="text-center py-20 text-slate-500 hidden"><i data-lucide="bike" class="mx-auto mb-4 h-16 w-16 opacity-30"></i><p>Standort wird ermittelt...</p></div>
        <div class="text-center text-[10px] text-slate-600 mt-4 pb-2 opacity-50">v3.9 â€¢ n.w.</div>
    </main>

    <!-- MODALS (Settings, Daily, Moto, Hourly, Legend, Layer) -->
    <div id="settingsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[99] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="toggleSettings()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="layout" size="20"></i> Layout</h3><div class="space-y-4 text-sm"><div class="space-y-2" id="layoutList"></div><div class="pt-4 border-t border-slate-600/50"><h4 class="text-xs font-bold uppercase text-slate-400 mb-2">Detail-Sichtbarkeit</h4><div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-lg"><span>Wetter-Daten</span><button onclick="toggleSubVisibility('weather')" id="vis-weather-btn" class="text-green-400"><i data-lucide="eye" size="18"></i></button></div><div class="flex justify-between items-center bg-slate-800/50 p-2 rounded-lg mt-2"><span>Moto Index</span><button onclick="toggleSubVisibility('moto')" id="vis-moto-btn" class="text-green-400"><i data-lucide="eye" size="18"></i></button></div></div><button onclick="resetLayout()" class="w-full py-2 mt-2 text-xs text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition">Standard</button></div></div></div>
    
    <!-- DAILY DETAILS (UPDATED LOGIC) -->
    <div id="dailyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="document.getElementById('dailyDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-6 text-blue-100 flex items-center gap-2"><i data-lucide="calendar" size="20"></i> Tages-Infos</h3><div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunrise" size="12"></i> Aufgang</div><div id="detailSunrise" class="font-bold">--:--</div></div><div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sunset" size="12"></i> Untergang</div><div id="detailSunset" class="font-bold">--:--</div></div></div><div id="sunCountdownContainer" class="bg-yellow-500/10 border border-yellow-500/20 rounded-xl p-2 mb-6 text-center"><div class="text-xs text-yellow-200 font-medium flex items-center justify-center gap-2"><i data-lucide="hourglass" size="12"></i> <span id="sunCountdownText">...</span></div></div><div class="grid grid-cols-2 gap-4 mb-6"><div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="eye" size="12"></i> Sicht</div><div id="detailVisibility" class="font-bold">--</div></div><div class="bg-slate-800/50 p-3 rounded-xl text-center"><div class="text-slate-400 text-xs mb-1 flex justify-center items-center gap-1"><i data-lucide="sun" size="12"></i> UV</div><div id="detailUV" class="font-bold">--</div></div></div><div class="mb-2"><h4 class="text-xs font-bold uppercase text-slate-400 mb-2 tracking-wider">LuftqualitÃ¤t</h4><div class="bg-slate-800/50 p-4 rounded-xl"><div class="flex justify-between items-center mb-2"><span class="text-sm text-slate-300">AQI</span><span id="detailAqiVal" class="font-bold text-white">--</span></div><div class="w-full bg-slate-700 rounded-full h-2 mb-3"><div id="detailAqiBar" class="bg-green-500 h-2 rounded-full" style="width:0%"></div></div><div id="detailAqiText" class="text-xs text-center text-slate-400 italic">Lade...</div></div></div></div></div>

    <div id="motoDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[95] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="document.getElementById('motoDetailsModal').classList.add('hidden')" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-2 text-white flex items-center gap-2"><i data-lucide="bike" size="24" class="text-blue-400"></i> Moto Analyse</h3><p class="text-xs text-slate-400 mb-4">Details</p><div id="motoAnalysisList" class="space-y-3 mb-6"></div><h3 class="text-md font-bold mb-2 text-white flex items-center gap-2 border-t border-slate-600 pt-4"><i data-lucide="shirt" size="20" class="text-orange-400"></i> Gear Guide</h3><div class="bg-slate-800/50 p-3 rounded-xl border border-slate-600/50 flex items-center gap-3"><div id="gearIcon" class="text-2xl">ðŸ§¥</div><div class="text-sm font-medium text-slate-200" id="gearText">...</div></div></div></div>
    <div id="hourlyDetailsModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[80] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-xs rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="closeHourlyModal()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><div class="text-center mb-4"><div id="modalTime" class="text-lg font-bold text-blue-200">--:--</div><div id="modalDesc" class="text-sm text-slate-400">--</div></div><div class="flex flex-col items-center justify-center mb-6"><div id="modalIcon" class="mb-2 transform scale-125"></div><div class="text-5xl font-bold tracking-tighter"><span id="modalTemp">--</span>Â°</div></div><div class="grid grid-cols-3 gap-2 mb-4 text-center"><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="wind" size="12" class="inline"></i> Wind</div><div id="modalWind" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="umbrella" size="12" class="inline"></i> Regen</div><div id="modalRain" class="font-bold text-sm">--</div></div><div class="bg-slate-800/50 rounded-lg p-2"><div class="text-slate-400 text-[10px] mb-1"><i data-lucide="droplets" size="12" class="inline"></i> Feuchte</div><div id="modalHum" class="font-bold text-sm">--</div></div></div><div id="modalScoreBg" class="rounded-xl p-3 border flex items-center justify-between"><span class="font-bold uppercase text-xs tracking-wider">Moto Index</span><div class="text-right"><span id="modalScoreVal" class="text-xl font-black">--</span><span class="text-xs opacity-80">/10</span></div></div></div></div>
    <div id="legendModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-6 relative max-h-[85vh] overflow-y-auto custom-scrollbar shadow-2xl border-slate-600/50 modal-content"><button onclick="toggleLegend()" class="absolute top-4 right-4 text-slate-400 hover:text-white bg-slate-800/50 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-4 text-blue-100 flex items-center gap-2"><i data-lucide="cloud-sun" size="20"></i> Legende</h3><div class="grid grid-cols-1 gap-2 text-sm text-slate-300"><div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="sun" class="text-yellow-400 w-6 h-6"></i> <span>Klar</span></div><div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-sun" class="text-blue-200 w-6 h-6"></i> <span>BewÃ¶lkt</span></div><div class="flex items-center gap-4 p-3 bg-slate-800/50 rounded-xl"><i data-lucide="cloud-rain" class="text-blue-400 w-6 h-6"></i> <span>Regen</span></div></div></div></div>
    <div id="layerMenuModal" onclick="if(event.target === this) this.classList.add('hidden')" class="hidden fixed inset-0 z-[90] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in modal-overlay"><div class="glass-panel w-full max-w-sm rounded-2xl p-5 relative shadow-2xl border border-slate-500/50 modal-content"><button onclick="toggleLayerMenu()" class="absolute top-3 right-3 text-slate-400 hover:text-white bg-slate-800/80 p-1 rounded-full"><i data-lucide="x" size="20"></i></button><h3 class="text-lg font-bold mb-4 text-white flex items-center gap-2"><i data-lucide="layers" size="20"></i> Karten</h3><div class="grid grid-cols-2 gap-3"><button onclick="selectLayer('rain', 'Regen')" class="p-4 bg-slate-800 hover:bg-blue-600 rounded-xl border border-slate-700"><i data-lucide="cloud-rain" class="mx-auto mb-1 text-blue-300"></i><span class="text-xs block text-center">Regen</span></button><button onclick="selectLayer('wind', 'Wind')" class="p-4 bg-slate-800 hover:bg-blue-600 rounded-xl border border-slate-700"><i data-lucide="wind" class="mx-auto mb-1 text-teal-300"></i><span class="text-xs block text-center">Wind</span></button><button onclick="selectLayer('clouds', 'Wolken')" class="p-4 bg-slate-800 hover:bg-blue-600 rounded-xl border border-slate-700"><i data-lucide="cloud" class="mx-auto mb-1 text-gray-300"></i><span class="text-xs block text-center">Wolken</span></button><button onclick="selectLayer('temp', 'Temp')" class="p-4 bg-slate-800 hover:bg-blue-600 rounded-xl border border-slate-700"><i data-lucide="thermometer" class="mx-auto mb-1 text-red-400"></i><span class="text-xs block text-center">Temp</span></button></div></div></div>

    <script>
        lucide.createIcons();

        // State
        let currentLat = 51.1657; let currentLon = 10.4515;
        let currentRadarType = 'rain'; let currentRadarTitle = 'Regen (Vorschau)'; 
        let lastWeatherData = null;
        let isFullscreen = false; let debounceTimer; let clockInterval;
        let currentHeading = 0;
        let isFirstLoad = true; 
        
        // Layout Config
        let layoutConfig = { order: ['statusSection', 'rainChartSection', 'radarSection', 'timelineSection'], visibility: { statusSection: true, rainChartSection: true, radarSection: true, timelineSection: true, sub_weather: true, sub_moto: true } };
        try { const s = localStorage.getItem('motoLayoutConfig'); if(s) { const p = JSON.parse(s); layoutConfig = { ...layoutConfig, ...p, visibility: { ...layoutConfig.visibility, ...p.visibility } }; if(!layoutConfig.order.includes('rainChartSection')) { layoutConfig.order.splice(1, 0, 'rainChartSection'); layoutConfig.visibility.rainChartSection = true; } } } catch(e){}

        const cityInput = document.getElementById('cityInput');
        const suggestionsList = document.getElementById('suggestionsList');
        const errorMessage = document.getElementById('errorMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const warningContainer = document.getElementById('warningContainer');
        const offlineBanner = document.getElementById('offlineBanner');
        const splash = document.getElementById('splashScreen');

        // --- SWIPE & SPLASH ---
        let touchStartY = 0;
        splash.addEventListener('touchstart', e => { touchStartY = e.changedTouches[0].screenY; });
        splash.addEventListener('touchend', e => { if (touchStartY - e.changedTouches[0].screenY > 50) dismissSplash(); });
        function dismissSplash() { splash.classList.add('splash-hidden'); document.body.style.overflow = 'auto'; }
        function initSplash() { const hour = new Date().getHours(); const isDay = (hour >= 6 && hour < 20) ? 1 : 0; renderSplashEffects(0, isDay); }
        initSplash();

        // --- LAYOUT ---
        function applyLayout() {
            const con = document.getElementById('dynamicContent');
            const els = { 
                statusSection: document.getElementById('statusSection'), 
                rainChartSection: document.getElementById('rainChartSection'), 
                radarSection: document.getElementById('radarSection'), 
                timelineSection: document.getElementById('timelineSection') 
            };
            layoutConfig.order.forEach(id => { if(els[id]) { con.appendChild(els[id]); els[id].classList.toggle('hidden', !layoutConfig.visibility[id]); } });
            const wc=document.getElementById('card-weather'), mc=document.getElementById('card-moto');
            wc.classList.toggle('hidden', !layoutConfig.visibility.sub_weather); mc.classList.toggle('hidden', !layoutConfig.visibility.sub_moto);
            wc.classList.remove('col-span-2'); mc.classList.remove('col-span-2');
            if(layoutConfig.visibility.sub_weather && !layoutConfig.visibility.sub_moto) wc.classList.add('col-span-2');
            if(!layoutConfig.visibility.sub_weather && layoutConfig.visibility.sub_moto) mc.classList.add('col-span-2');
            lucide.createIcons();
        }
        function toggleSettings() { document.getElementById('settingsModal').classList.toggle('hidden'); if(!document.getElementById('settingsModal').classList.contains('hidden')) renderSettingsList(); }
        function renderSettingsList() {
            const l=document.getElementById('layoutList'); l.innerHTML='';
            const n={statusSection:'Ãœbersicht', rainChartSection: 'Niederschlag (1h)', radarSection:'Radar',timelineSection:'Vorhersage'};
            layoutConfig.order.forEach((id,i)=>{
                l.innerHTML+=`<div class="flex items-center justify-between bg-slate-800 p-3 rounded-xl border border-slate-700"><div class="flex items-center gap-3"><span class="text-slate-400 font-mono text-xs">${i+1}</span><span class="font-bold text-white">${n[id]}</span></div><div class="flex items-center gap-2"><button onclick="moveItem('${id}',-1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-up" size="16"></i></button><button onclick="moveItem('${id}',1)" class="p-1 hover:bg-slate-700 rounded"><i data-lucide="arrow-down" size="16"></i></button><div class="w-px h-4 bg-slate-600 mx-1"></div><button onclick="toggleVisibility('${id}')" class="${layoutConfig.visibility[id]?'text-green-400':'text-slate-500'} p-1 hover:bg-slate-700 rounded"><i data-lucide="${layoutConfig.visibility[id]?'eye':'eye-off'}" size="18"></i></button></div></div>`;
            });
            document.getElementById('vis-weather-btn').className = layoutConfig.visibility.sub_weather ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-weather-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_weather?'eye':'eye-off'}" size="18"></i>`;
            document.getElementById('vis-moto-btn').className = layoutConfig.visibility.sub_moto ? 'text-green-400' : 'text-slate-500';
            document.getElementById('vis-moto-btn').innerHTML = `<i data-lucide="${layoutConfig.visibility.sub_moto?'eye':'eye-off'}" size="18"></i>`;
            lucide.createIcons();
        }
        function moveItem(id, d) { const i=layoutConfig.order.indexOf(id); if(i<0||i+d<0||i+d>=layoutConfig.order.length)return; [layoutConfig.order[i],layoutConfig.order[i+d]]=[layoutConfig.order[i+d],layoutConfig.order[i]]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleVisibility(id) { layoutConfig.visibility[id]=!layoutConfig.visibility[id]; saveLayout(); renderSettingsList(); applyLayout(); }
        function toggleSubVisibility(k) { layoutConfig.visibility['sub_'+k]=!layoutConfig.visibility['sub_'+k]; saveLayout(); renderSettingsList(); applyLayout(); }
        function resetLayout() { layoutConfig={order:['statusSection','rainChartSection','radarSection','timelineSection'],visibility:{statusSection:true,rainChartSection:true,radarSection:true,timelineSection:true,sub_weather:true,sub_moto:true}}; saveLayout(); renderSettingsList(); applyLayout(); }
        function saveLayout() { localStorage.setItem('motoLayoutConfig', JSON.stringify(layoutConfig)); }

        // --- COMPASS ---
        function initCompass() { if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function') { DeviceOrientationEvent.requestPermission().then(r=>{if(r==='granted')window.addEventListener('deviceorientation',handleOrientation,true)}).catch(console.error); } else if (window.addEventListener) window.addEventListener('deviceorientation', handleOrientation, true); }
        function handleOrientation(e) { if (e.webkitCompassHeading) currentHeading=e.webkitCompassHeading; else if (e.alpha!==null) currentHeading=360-e.alpha; if(lastWeatherData) updateWindArrow(); }
        function updateWindArrow() { if(!lastWeatherData?.current?.wind_direction_10m)return; const a=document.getElementById('windDirArrow'); if(a) a.style.transform=`rotate(${lastWeatherData.current.wind_direction_10m+180-currentHeading}deg)`; }

        // --- OFFLINE/CACHE ---
        function saveToCache(n, d) { try{localStorage.setItem('motoWeather_cache_v3_9', JSON.stringify({name:n,data:d,timestamp:Date.now()}));}catch(e){} }
        function loadFromCache() { try{return JSON.parse(localStorage.getItem('motoWeather_cache_v3_9'));}catch(e){return null;} }
        async function enableNotifications() { if(!("Notification" in window))return alert("N/A"); if(Notification.permission==="granted"){alert("Aktiv!");checkAndSendNotification(10);} else if(Notification.permission!=="denied"){const p=await Notification.requestPermission();if(p==="granted")document.getElementById('notifyBadge').classList.remove('hidden');} else alert("Blockiert"); }
        function checkAndSendNotification(s) { if(Notification.permission==="granted"&&s>=8){const l=sessionStorage.getItem('lastNotificationTime'); if(!l||Date.now()-l>14400000){new Notification("Biker-Wetter!",{body:`Score: ${s}/10`,icon:"https://img.icons8.com/fluency/512/weather.png?v=2"});sessionStorage.setItem('lastNotificationTime',Date.now());}} }
        if ("Notification" in window && Notification.permission === "granted") document.getElementById('notifyBadge').classList.remove('hidden');

        function checkWarnings(c) { let w=null, col="bg-yellow-500/80 border-yellow-400", ic="alert-triangle"; 
        if(c.weather_code>=95){w="GEWITTER";col="bg-red-600/90 border-red-400";ic="cloud-lightning"}else if(c.wind_speed_10m>=75){w="STURM";col="bg-red-600/90 border-red-400";ic="wind"}else if(c.wind_speed_10m>=50){w="WindbÃ¶en";col="bg-orange-500/80 border-orange-400";ic="wind"}else if(c.temperature_2m<=3){w="GlÃ¤tte";col="bg-blue-600/80 border-blue-400";ic="snowflake"}else if(c.precipitation>=5){w="Starkregen";col="bg-blue-700/80 border-blue-400";ic="cloud-rain"}if(c.visibility<1000){w="Nebel";col="bg-gray-600/90 border-gray-400";ic="cloud-fog"}
        if(w){warningContainer.innerHTML=`<div class="w-full ${col} border p-3 rounded-xl flex items-center justify-between shadow-lg animate-pulse-slow mb-4 text-white"><div class="flex items-center gap-3 font-bold"><i data-lucide="${ic}" size="24"></i><span>${w}</span></div><i data-lucide="alert-circle" size="20"></i></div>`;warningContainer.classList.remove('hidden');}else warningContainer.classList.add('hidden'); lucide.createIcons(); }

        function toggleLegend() { document.getElementById('legendModal').classList.toggle('hidden'); lucide.createIcons(); }
        function closeHourlyModal() { document.getElementById('hourlyDetailsModal').classList.add('hidden'); }
        function toggleLayerMenu() { document.getElementById('layerMenuModal').classList.toggle('hidden'); lucide.createIcons(); }
        
        async function showDailyDetails() { 
            if(!lastWeatherData) return; 
            const daily = lastWeatherData.daily; 
            const cur = lastWeatherData.current;
            document.getElementById('detailSunrise').innerText = new Date(daily.sunrise[0]).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); 
            document.getElementById('detailSunset').innerText = new Date(daily.sunset[0]).toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); 
            document.getElementById('detailVisibility').innerText = cur.visibility > 9999 ? ">10 km" : (cur.visibility/1000).toFixed(1) + " km";
            document.getElementById('detailUV').innerText = cur.uv_index;

            // Corrected Sun Countdown Logic
            const now = new Date();
            const sunrise = new Date(daily.sunrise[0]);
            const sunset = new Date(daily.sunset[0]);
            const countdownEl = document.getElementById('sunCountdownText');

            if (now < sunrise) {
                // Before Sunrise
                const diff = sunrise - now;
                const h = Math.floor(diff / 36e5);
                const m = Math.floor((diff % 36e5) / 6e4);
                countdownEl.innerText = `Dunkel. Aufgang in ${h}h ${m}m`;
            } else if (now < sunset) {
                // Daytime
                const diff = sunset - now;
                const h = Math.floor(diff / 36e5);
                const m = Math.floor((diff % 36e5) / 6e4);
                countdownEl.innerText = `Noch ${h}h ${m}m Licht`;
            } else {
                // After Sunset
                countdownEl.innerText = "Dunkelheit (Sonne weg)";
            }

            try { 
                const res = await fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${currentLat}&longitude=${currentLon}&current=european_aqi,pm10,pm2_5`); 
                const aqData = await res.json(); const aqi = aqData.current.european_aqi; document.getElementById('detailAqiVal').innerText = aqi; 
                let color = "bg-green-500", text = "Sehr Gut", width = "20%"; 
                if(aqi > 20) { color = "bg-teal-400"; text = "Gut"; width="40%"; } 
                if(aqi > 40) { color = "bg-yellow-400"; text = "Mittel"; width="60%"; } 
                if(aqi > 60) { color = "bg-orange-500"; text = "Schlecht"; width="80%"; } 
                if(aqi > 80) { color = "bg-red-600"; text = "Sehr Schlecht"; width="100%"; } 
                const bar = document.getElementById('detailAqiBar'); 
                bar.className = `h-2 rounded-full ${color}`; bar.style.width = width; 
                document.getElementById('detailAqiText').innerText = text; 
            } catch(e) { document.getElementById('detailAqiText').innerText = "Nicht verfÃ¼gbar"; } 
            
            document.getElementById('dailyDetailsModal').classList.remove('hidden'); 
            lucide.createIcons(); 
        }
        
        function getGearRecommendation(temp, rain) {
           let text = "Standard-AusrÃ¼stung"; let icon = "ðŸ§¥";
           if(temp > 26) { text = "Leichte Sommer-Kombi / Mesh"; icon="ðŸ‘•"; } else if(temp < 10) { text = "Winter-Gear & ThermowÃ¤sche"; icon="ðŸ§£"; } else if(temp < 18) { text = "Thermo-Futter / Softshell drunter"; icon="ðŸ§¥"; }
           if(rain > 0.5) { text += " + Regenkombi!"; icon="â˜”"; } return {text, icon};
        }

        function showMotoDetails() { 
            if(!lastWeatherData) return; const cur = lastWeatherData.current; 
            const analysis = calculateMotoAnalysis(cur.temperature_2m, cur.wind_speed_10m, cur.precipitation, cur.is_day, cur.weather_code); 
            const list = document.getElementById('motoAnalysisList'); list.innerHTML = ""; 
            analysis.pros.forEach(p => { list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-emerald-500/10 border border-emerald-500/30 rounded-xl"><i data-lucide="check-circle" class="text-emerald-400 flex-shrink-0"></i><span class="text-sm text-emerald-100">${p}</span></div>`; }); 
            analysis.cons.forEach(c => { list.innerHTML += `<div class="flex items-center gap-3 p-3 bg-red-500/10 border border-red-500/30 rounded-xl"><i data-lucide="alert-triangle" class="text-red-400 flex-shrink-0"></i><span class="text-sm text-red-100">${c}</span></div>`; }); 
            if(analysis.pros.length === 0 && analysis.cons.length === 0) list.innerHTML = `<div class="text-center text-slate-400 italic">Keine besonderen Vorkommnisse.</div>`; 
            const gear = getGearRecommendation(cur.temperature_2m, cur.precipitation);
            document.getElementById('gearText').innerText = gear.text; document.getElementById('gearIcon').innerText = gear.icon;
            document.getElementById('motoDetailsModal').classList.remove('hidden'); lucide.createIcons(); 
        }

        // --- CALCULATIONS ---
        function calculateMotoAnalysis(temp, wind, rain, isDay, code) { let pros = [], cons = []; if(temp >= 15 && temp <= 28) pros.push("Perfekte Temperatur"); else if(temp < 5) cons.push("Eisgefahr & KÃ¤lte (< 5Â°C)"); else if(temp < 10) cons.push("Ziemlich kalt (< 10Â°C)"); else if(temp > 30) cons.push("Hitze (> 30Â°C)"); if(wind < 15) pros.push("Kaum Wind"); else if(wind > 40) cons.push("Starke BÃ¶en (> 40km/h)"); else if(wind > 60) cons.push("Sturmwarnung!"); if(rain > 0) cons.push("Nasse StraÃŸe mÃ¶glich"); if(code < 3) pros.push("Gute Sicht"); if(code >= 51) cons.push("Niederschlag aktiv"); if(isDay === 0) cons.push("Dunkelheit (Nachtfahrt)"); else pros.push("Tageslicht"); return { pros, cons }; }
        function calculateMotoScore(temp, wind, rain, isDay, code) { let score = 10, reason = "Perfekt"; if (temp < 0) { score -= 10; reason = "Eisgefahr"; } else if (temp < 5) { score -= 8; reason = "Zu kalt"; } else if (temp < 10) { score -= 5; reason = "Kalt"; } else if (temp > 35) { score -= 4; reason = "Hitze"; } if (code >= 51 && code <= 99) { if (code >= 95) { score -= 10; reason = "Gewitter"; } else if (code >= 66 && code <= 77) { score -= 9; reason = "Eis/Schnee"; } else if (code >= 61) { score -= 7; reason = "Regen"; } else { score -= 4; reason = "Niesel"; } } if (rain > 0.5) { score -= 5; reason = "Nass"; } if (wind > 60) { score -= 9; reason = "Sturm"; } else if (wind > 40) { score -= 5; reason = "Windig"; } else if (wind > 20) { score -= 2; } if (isDay === 0) { score -= 2; if(reason === "Perfekt") reason = "Nacht"; } return { score: Math.max(0, Math.min(10, score)), reason: reason }; }
        function calculateDailyScore(hourly) { const offsetMs = (lastWeatherData.utc_offset_seconds || 0) * 1000; let totalScore = 0; let count = 0; for (let i = 0; i < hourly.time.length; i++) { const timeMs = new Date(hourly.time[i]).getTime(); const pointDateStr = new Date(timeMs + offsetMs).toISOString().slice(0, 10); const nowDateStr = new Date(Date.now() + offsetMs).toISOString().slice(0, 10); if (pointDateStr !== nowDateStr) continue; if (hourly.is_day[i] === 1) { totalScore += calculateMotoScore(hourly.temperature_2m[i], hourly.wind_speed_10m[i], hourly.precipitation[i], hourly.is_day[i], hourly.weather_code[i]).score; count++; } } return count === 0 ? "--" : Math.round((totalScore / count) * 10) / 10; }
        function getScoreColor(score) { if (score >= 8) return { bg: "border-emerald-500 text-emerald-400", hex: "#10b981" }; if (score >= 5) return { bg: "border-yellow-500 text-yellow-400", hex: "#eab308" }; if (score >= 3) return { bg: "border-orange-500 text-orange-400", hex: "#f97316" }; return { bg: "border-red-500 text-red-400", hex: "#ef4444" }; }
        
        function updateMainValues(temp, wind, hum, rain, code, isDay, timeText, dayIndex = 0) { 
            document.getElementById('temperature').innerText = Math.round(temp); 
            document.getElementById('windSpeed').innerText = wind + " km/h"; 
            document.getElementById('humidity').innerText = hum + "%"; 
            const wInfo = getWeatherInfo(code); 
            document.getElementById('weatherDesc').innerText = wInfo.t; 
            document.getElementById('weatherIconContainer').innerHTML = `<i data-lucide="${wInfo.i}" class="w-12 h-12"></i>`; 
            
            const scoreInfo = calculateMotoScore(temp, wind, rain, isDay, code); 
            const scoreColor = getScoreColor(scoreInfo.score); 
            const scoreEl = document.getElementById('motoScoreCircle'); 
            scoreEl.className = `w-20 h-20 rounded-full border-4 flex items-center justify-center bg-slate-800 transition-colors duration-500 mb-1 shadow-inner ${scoreColor.bg}`; 
            document.getElementById('motoScoreValue').innerText = scoreInfo.score; 
            document.getElementById('motoScoreText').innerText = scoreInfo.reason; 
            document.getElementById('timeLabel').innerText = "Aktuell"; 
            document.getElementById('timeLabel').classList.remove('opacity-0'); 
            
            if (lastWeatherData && lastWeatherData.daily && lastWeatherData.daily.temperature_2m_max[dayIndex] !== undefined) { 
                document.getElementById('tempMax').innerText = Math.round(lastWeatherData.daily.temperature_2m_max[dayIndex]); 
                document.getElementById('tempMin').innerText = Math.round(lastWeatherData.daily.temperature_2m_min[dayIndex]); 
            } 
            updateWindArrow();
            lucide.createIcons(); 
        }

        // --- SPLASH EFFECTS RENDER ---
        function renderSplashEffects(code, isDay) {
            const container = document.getElementById('splashEffects');
            const localCon = document.getElementById('splashLocalEffects'); // Also render to local splash
            container.innerHTML = '';
            if(localCon) localCon.innerHTML = '';

            let html = '';

            // Rain
            if ([51,53,55,61,63,65,66,67,80,81,82,95,96,99].includes(code)) {
                for(let i=0; i<20; i++) {
                    const left = Math.random() * 100;
                    const delay = Math.random() * 1;
                    const dur = 0.5 + Math.random() * 0.5;
                    html += `<div class="rain-drop" style="left:${left}%; animation-delay:${delay}s; animation-duration:${dur}s"></div>`;
                }
            }
            // Snow
            else if ([71,73,75,77,85,86].includes(code)) {
                for(let i=0; i<20; i++) {
                     const left = Math.random() * 100;
                    const delay = Math.random() * 2;
                    const dur = 2 + Math.random() * 2;
                    html += `<div class="snowflake" style="left:${left}%; animation-delay:${delay}s; animation-duration:${dur}s; opacity:${Math.random()}"></div>`;
                }
            }
            // Fog
            else if ([45,48].includes(code)) {
                html += `<div class="fog-layer" style="top: 20%; height: 20%;"></div>`;
                html += `<div class="fog-layer" style="top: 50%; height: 30%; animation-delay: -2s;"></div>`;
                html += `<div class="fog-layer" style="top: 80%; height: 20%; animation-delay: -5s;"></div>`;
            }
            // Clear/Cloudy
            else {
                // Wolken fÃ¼r Code > 0 (auch bei Nacht) - Increased visibility and size
                if (code > 0) {
                     html += `<div class="cloud-shape" style="top: 5%; left: -15%; animation-duration: 30s;"></div>`;
                     html += `<div class="cloud-shape" style="top: 35%; right: -25%; animation-duration: 40s; animation-direction: reverse;"></div>`;
                     html += `<div class="cloud-shape" style="top: 65%; left: -10%; animation-duration: 35s; animation-delay: -10s;"></div>`;
                     html += `<div class="cloud-shape" style="top: 20%; right: 10%; animation-duration: 45s; animation-delay: -5s; animation-direction: reverse;"></div>`;
                }

                if (isDay === 1) {
                     // Sun -> Allow for code <= 2 (Teilweise bewÃ¶lkt)
                     if (code <= 2) {
                         html += `<div class="sun-glow"></div>`;
                     }
                } else {
                    // Stars -> Always visible at night unless severe weather (rain/snow/fog), even if cloudy
                     for(let i=0; i<120; i++) {
                        const top = Math.random() * 80; 
                        const left = Math.random() * 100;
                        const size = 1.5 + Math.random() * 3; // Bigger stars
                        const delay = Math.random() * 2;
                        const opacity = 0.4 + Math.random() * 0.6; // Brighter
                        html += `<div class="star" style="top:${top}%; left:${left}%; width:${size}px; height:${size}px; animation-delay:${delay}s; opacity:${opacity};"></div>`;
                    }
                }
            }
            
            container.innerHTML = html;
            if(localCon) localCon.innerHTML = html;
        }
        
        // --- RENDER RAIN CHART ---
        function renderRainChart(minutely15) {
            const container = document.getElementById('rainBarsContainer');
            if (!minutely15 || !minutely15.precipitation || minutely15.precipitation.length < 4) {
                container.innerHTML = '<div class="text-xs text-slate-500 w-full text-center flex items-center justify-center">Keine Daten</div>';
                return;
            }
            
            container.innerHTML = '';
            for(let i=0; i<4; i++) {
                const val = minutely15.precipitation[i];
                const height = Math.min(100, (val / 2.0) * 100); 
                const color = val > 1.0 ? "bg-blue-500" : "bg-blue-300/70";
                container.innerHTML += `
                    <div class="w-1/4 h-full flex flex-col justify-end items-center gap-1">
                        <div class="w-full rounded-t-md ${color} rain-bar" style="height: ${Math.max(5, height)}%"></div>
                        <span class="text-[9px] text-slate-400">${val > 0 ? val.toFixed(1) : '0'}</span>
                    </div>
                `;
            }
        }

        function updateUI(name, fromCache=false) {
            try {
                if(name) document.getElementById('cityName').innerText=name; const cur=lastWeatherData.current;
                document.getElementById('splashCity').innerText=name||"Unbekannt"; document.getElementById('splashTemp').innerText=Math.round(cur.temperature_2m);
                const info=getWeatherInfo(cur.weather_code); document.getElementById('splashIcon').innerHTML=`<i data-lucide="${info.i}" class="w-24 h-24"></i>`; document.getElementById('splashDesc').innerText=info.t;
                
                renderSplashEffects(cur.weather_code, cur.is_day);

                updateMainValues(cur.temperature_2m, cur.wind_speed_10m, cur.relative_humidity_2m, cur.precipitation, cur.weather_code, cur.is_day, 0);
                checkWarnings(cur); 
                if(!fromCache) checkAndSendNotification(calculateMotoScore(cur.temperature_2m, cur.wind_speed_10m, cur.precipitation, cur.is_day, cur.weather_code).score);
                if (lastWeatherData.hourly) document.getElementById('dailyScoreValue').innerText=calculateDailyScore(lastWeatherData.hourly)+" / 10";
                
                // Update Rain Chart
                renderRainChart(lastWeatherData.minutely_15);

                renderHourly(); applyLayout();
                document.getElementById('startPrompt').classList.add('hidden'); 
                document.getElementById('dynamicContent').classList.remove('hidden'); 
                loadingIndicator.classList.add('hidden'); updateRadar();
                if(isFirstLoad) { document.getElementById('splashScreen').classList.remove('splash-hidden'); isFirstLoad=false; }
            } catch (e) {
                console.error("UpdateUI Error", e);
                loadingIndicator.classList.add('hidden'); 
            }
        }

        async function fetchWeather(name, country) {
            loadingIndicator.classList.remove('hidden'); offlineBanner.classList.add('hidden');
            const url=`https://api.open-meteo.com/v1/forecast?latitude=${currentLat}&longitude=${currentLon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m,wind_direction_10m,precipitation,is_day,visibility,uv_index&hourly=temperature_2m,relative_humidity_2m,precipitation,weather_code,wind_speed_10m,is_day&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset&minutely_15=precipitation&forecast_days=3&timezone=auto&_t=${Date.now()}`;
            try { const r=await fetch(url); if(!r.ok)throw new Error(); lastWeatherData=await r.json(); saveToCache(name, lastWeatherData); updateUI(name); }
            catch(e) { 
                const c=loadFromCache(); 
                if(c){ lastWeatherData=c.data; offlineBanner.innerText="Offline"; offlineBanner.classList.remove('hidden'); updateUI(c.name,true); } 
                else { document.getElementById('errorMessage').classList.remove('hidden'); loadingIndicator.classList.add('hidden'); } 
            }
        }

        function locateMe(silent=false) {
            if(!navigator.geolocation){if(!silent)alert("Kein GPS");return;} if(!silent){document.getElementById('loadingIndicator').classList.remove('hidden');initCompass();}
            navigator.geolocation.getCurrentPosition(async p=>{
                currentLat=p.coords.latitude; currentLon=p.coords.longitude;
                if(document.getElementById('splashCity')) document.getElementById('splashCity').innerText="Suche Ort...";
                let n=null;
                try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${currentLat}&longitude=${currentLon}&language=de&format=json`);const d=await r.json(); if(d.results&&d.results[0]) n=d.results[0].name||d.results[0].city||d.results[0].town||d.results[0].village||d.results[0].suburb||d.results[0].hamlet;}catch(e){}
                if(!n) { try{ const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${currentLat}&lon=${currentLon}&format=json&accept-language=de`, {headers:{'User-Agent':'WetterApp/2.5'}}); const d=await r.json(); if(d.address) n=d.address.city||d.address.town||d.address.village||d.address.hamlet||d.address.suburb||d.address.neighbourhood||d.address.county; }catch(e){} }
                if(!n) n = `${currentLat.toFixed(2)}, ${currentLon.toFixed(2)}`;
                fetchWeather(n,"");
            },()=>{
                document.getElementById('loadingIndicator').classList.add('hidden'); 
                if(!silent) alert("Standort verweigert"); 
                else { document.getElementById('gpsErrorPrompt').classList.remove('hidden'); }
            }, {timeout:10000,enableHighAccuracy:true});
        }

        async function searchCity() {
            const v=cityInput.value.trim(); if(!v)return; suggestionsList.classList.add('hidden'); errorMessage.classList.add('hidden'); loadingIndicator.classList.remove('hidden');
            try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=10&language=de&format=json`);const d=await r.json(); if(!d.results)throw new Error(); const l=d.results[0]; currentLat=l.latitude; currentLon=l.longitude; fetchWeather(l.name,l.country);}catch(e){loadingIndicator.classList.add('hidden');errorMessage.classList.remove('hidden');setTimeout(()=>errorMessage.classList.add('hidden'),3000);}
        }

        cityInput.addEventListener('input',e=>{clearTimeout(debounceTimer);const v=e.target.value.trim();if(v.length<2){suggestionsList.classList.add('hidden');return;}debounceTimer=setTimeout(async()=>{try{const r=await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=5&language=de&format=json`);const d=await r.json();suggestionsList.innerHTML='';if(d.results){d.results.forEach(p=>{const el=document.createElement('div');el.className="p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700/50";el.innerHTML=`<span class="font-bold text-white text-sm">${p.name}</span><span class="text-xs text-slate-400 ml-2">${p.admin1||''}</span>`;el.onclick=()=>{cityInput.value=p.name;suggestionsList.classList.add('hidden');cityInput.blur();currentLat=p.latitude;currentLon=p.longitude;fetchWeather(p.name,p.country);};suggestionsList.appendChild(el);});suggestionsList.classList.remove('hidden');}else suggestionsList.classList.add('hidden');}catch(e){}},300);});
        document.addEventListener('click',e=>{if(!cityInput.contains(e.target)&&!suggestionsList.contains(e.target))suggestionsList.classList.add('hidden');});
        
        function selectHour(i){
            const h=lastWeatherData.hourly; const t=Math.round(h.temperature_2m[i]); const c=h.weather_code[i]; const d=new Date(h.time[i]);
            const s=calculateMotoScore(t,h.wind_speed_10m[i],h.precipitation[i],h.is_day[i],c); const cl=getScoreColor(s.score);
            document.getElementById('modalTime').innerText=`${d.toLocaleDateString('de-DE',{weekday:'long'})} ${d.getHours()}:00`;
            document.getElementById('modalTemp').innerText=t; document.getElementById('modalDesc').innerText=getWeatherInfo(c).t;
            document.getElementById('modalIcon').innerHTML=`<i data-lucide="${getWeatherInfo(c).i}" size="48"></i>`;
            document.getElementById('modalWind').innerText=h.wind_speed_10m[i]+" km/h"; document.getElementById('modalRain').innerText=h.precipitation[i]+" mm"; document.getElementById('modalHum').innerText=h.relative_humidity_2m[i]+"%";
            document.getElementById('modalScoreVal').innerText=s.score; document.getElementById('modalScoreBg').className=`rounded-xl p-3 border flex items-center justify-between ${cl.bg} bg-slate-900/50`;
            document.getElementById('hourlyDetailsModal').classList.remove('hidden'); lucide.createIcons();
        }

        function renderHourly(){
            const c=document.getElementById('hourlyContainer'); c.innerHTML=''; const h=lastWeatherData.hourly;
            const off=(lastWeatherData.utc_offset_seconds||0)*1000; const start=h.time.findIndex(t=>t.startsWith(new Date(Date.now()+off).toISOString().slice(0,13)))||0;
            for(let i=start; i<start+24; i++){
                if(!h.time[i])break; const hr=new Date(h.time[i]).getHours(); const t=Math.round(h.temperature_2m[i]);
                const sc=calculateMotoScore(t,h.wind_speed_10m[i],h.precipitation[i],h.is_day[i],h.weather_code[i]);
                const col=getScoreColor(sc.score); const ic=getWeatherInfo(h.weather_code[i]).i;
                const act=(i===start)?"bg-slate-700 border-blue-500/50":"bg-slate-800/50 border-transparent";
                const dnI=h.is_day[i]===1?"sun":"moon"; const dnC=h.is_day[i]===1?"text-yellow-500/40":"text-blue-300/30";
                c.innerHTML+=`<div onclick="selectHour(${i})" class="relative hour-card cursor-pointer snap-start flex-shrink-0 w-24 p-2 rounded-xl border ${act} flex flex-col items-center justify-between h-32 hover:bg-slate-700 transition-all"><div class="absolute top-1 right-1 ${dnC}"><i data-lucide="${dnI}" size="8"></i></div><span class="text-xs text-slate-400 font-mono text-center leading-tight">${hr}:00</span><div class="text-blue-200"><i data-lucide="${ic}" size="20"></i></div><span class="text-sm font-bold">${t}Â°</span><div class="w-full flex justify-center mt-1"><div class="h-1.5 w-8 rounded-full ${col.bg.replace('text-','bg-').split(' ')[1]}"></div></div></div>`;
            } lucide.createIcons();
        }

        function getWeatherInfo(c){const m={0:{t:"Klar",i:"sun"},1:{t:"Heiter",i:"sun"},2:{t:"Wolkig",i:"cloud-sun"},3:{t:"Bedeckt",i:"cloud"},45:{t:"Nebel",i:"cloud-fog"},48:{t:"Nebel",i:"cloud-fog"},51:{t:"Niesel",i:"cloud-drizzle"},53:{t:"Niesel",i:"cloud-drizzle"},55:{t:"Niesel",i:"cloud-drizzle"},56:{t:"Gefrier. Niesel",i:"cloud-drizzle"},57:{t:"Gefrier. Niesel",i:"cloud-drizzle"},61:{t:"Regen",i:"cloud-rain"},63:{t:"Regen",i:"cloud-rain"},65:{t:"Starkregen",i:"cloud-rain"},66:{t:"Gefrier. Regen",i:"cloud-hail"},67:{t:"Gefrier. Regen",i:"cloud-hail"},71:{t:"Schnee",i:"snowflake"},73:{t:"Schnee",i:"snowflake"},75:{t:"Schnee",i:"snowflake"},77:{t:"Schneegriesel",i:"snowflake"},80:{t:"Schauer",i:"cloud-rain-wind"},81:{t:"Schauer",i:"cloud-rain-wind"},82:{t:"Starkschauer",i:"cloud-rain-wind"},85:{t:"Schneeschauer",i:"snowflake"},86:{t:"Schneeschauer",i:"snowflake"},95:{t:"Gewitter",i:"cloud-lightning"},96:{t:"Gewitter",i:"cloud-lightning"},99:{t:"Gewitter",i:"cloud-lightning"}}; return m[c]||{t:"Unbekannt",i:"help-circle"};}
        function selectLayer(t,l){currentRadarType=t;document.getElementById('radarTitle').innerText=l;toggleLayerMenu();updateRadar();}
        function updateRadar(){const h=isFullscreen?1000:384;const s=`https://embed.windy.com/embed2.html?lat=${currentLat}&lon=${currentLon}&detailLat=${currentLat}&detailLon=${currentLon}&width=650&height=${h}&zoom=8&level=surface&overlay=${currentRadarType}&product=ecmwf&menu=&message=&marker=true&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C`;document.getElementById('radarFrame').src=s;}
        function toggleFullscreen(){const c=document.getElementById('radarCard');isFullscreen=!isFullscreen;if(isFullscreen){c.classList.add('radar-fullscreen');document.getElementById('fullscreenIcon').setAttribute('data-lucide','x');document.getElementById('radarOverlay').classList.add('hidden');document.body.style.overflow='hidden'}else{c.classList.remove('radar-fullscreen');document.getElementById('fullscreenIcon').setAttribute('data-lucide','maximize-2');document.getElementById('radarOverlay').classList.remove('hidden');document.body.style.overflow=''}lucide.createIcons();updateRadar();}
        function startClock(){const c=document.getElementById('liveClock');if(c)c.innerText=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'});if(clockInterval)clearInterval(clockInterval);clockInterval=setInterval(()=>{if(c)c.innerText=new Date().toLocaleTimeString('de-DE',{hour:'2-digit',minute:'2-digit'})},1000);}
        startClock(); document.addEventListener('DOMContentLoaded', ()=>locateMe(true));
    </script>
</body>
</html>


